---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "March 17, 2017"
output:
  pdf_document:
    keep_tex: yes
header-includes:
  - \usepackage{theapa}
abstract: 'Turnover in Wisconsin'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::read_chunk('turnover_data_cleaner.R')
```

```{r start_read, cache = TRUE, include = FALSE}
```

# Introduction

# Data

# Results

```{r table_1}
teachers[ , .(`Remain in Same School` = sum(!move_school_next, na.rm = TRUE)/.N,
              `Change Schools Within District` = 
                sum(move_school_next & !move_district_next, na.rm = TRUE)/.N,
              `Switch Districts` = sum(move_district_next, na.rm = TRUE)/.N,
              `Exit Wisconsin Public School` = sum(quit_next, na.rm = TRUE)/.N,
              `Number of Teachers` = .N),
          keyby = .(`Teacher Experience` = {
            f = factor(total_exp_floor)
            levels(f) = list(`0-2 years` = 1:3,
                             `3-5 years` = 4:6,
                             `6-10 years` = 7:11,
                             `11-30 years` = 12:30)
            f})]
#table 1b
teachers[ , .(`Teacher Experience` = 'All',
              `Remain in Same School` = sum(!move_school_next, na.rm = TRUE)/.N,
              `Change Schools Within District` = 
                sum(move_school_next & !move_district_next, na.rm = TRUE)/.N,
              `Switch Districts` = sum(move_district_next, na.rm = TRUE)/.N,
              `Exit Wisconsin Public School` = sum(quit_next, na.rm = TRUE)/.N,
              `Number of Teachers` = .N)]
```

```{r table_2}
#table 2a
## to do: WTF is going on with missing urbanicity, in particular in WI
teachers[(move_district_next & !is.na(urbanicity_s)), 
         c(as.list(table2(urbanicity_s_next, prop = TRUE)),
           list(`# Changing Districts` = .N, 
                `% of origin teachers` =
                  .N/teachers[!is.na(urbanicity_s)
                              ][.BY, .N, on = 'urbanicity_s'])),
         keyby = urbanicity_s]

#table 2b
teachers[(move_district_next & !is.na(urbanicity_s) & total_exp_floor < 3), 
         c(as.list(table2(urbanicity_s_next, prop = TRUE)),
           list(`# Changing Districts` = .N, 
                `% of origin teachers` =
                  .N/teachers[!is.na(urbanicity_s) & total_exp_floor < 3
                              ][.BY, .N, on = 'urbanicity_s'])),
         keyby = urbanicity_s]
```

```{r table_3}
teachers[move_district_next & total_exp_floor <= 10, 
         .(d_lsalary = 
             mean(schedule_lsalary_next - 
                    schedule_lsalary_next_cf, na.rm = TRUE), 
           d_lsalary_resid = 
             mean(schedule_lsalary_resid_next - 
                    schedule_lsalary_resid_next_cf, na.rm = TRUE),
           d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
         keyby = .(exp = {
           f = factor(total_exp_floor)
           levels(f) = list('1-3' = 1:3, '4-6' = 4:6, '7-10' = 7:10)
           f}, gender)
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ gender + exp, value.var = 'value')]
```

```{r table_4}
teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_lsalary = 
             mean(schedule_lsalary_next - 
                    schedule_lsalary_next_cf, na.rm = TRUE), 
           d_lsalary_resid = 
             mean(schedule_lsalary_resid_next - 
                    schedule_lsalary_resid_next_cf, na.rm = TRUE),
           d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]

teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_pct_prof_s = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp_s = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black_s = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl_s = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]
```

```{r table_5}
teachers[move_district_next & total_exp_floor <= 10 & 
           ethnicity_main %in% c('Black', 'Hispanic'),
         .(d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE), N = .N),
         keyby = ethnicity_main
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity_main, value.var = 'value')]

teachers[move_school_next & !move_district_next & total_exp_floor <= 10 &
           ethnicity_main %in% c('Black', 'Hispanic'),
         .(d_pct_prof = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE), N = .N),
         keyby = ethnicity_main
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity_main, value.var = 'value')]
```

```{r table_6}
melt(teachers, id.vars = c('year', 'move_district_next', 
                           'move_school_next', 'quit_next'), 
     measure.vars = paste0(q_var, '_q'), na.rm = TRUE,
     variable.name = 'Quartile of Distribution', value.name = 'quartile'
     )[ , .(`Probability Teachers Move to New School within District` = 
              mean(move_school_next & !move_district_next),
            `Probability Teachers Move to New District` = 
              mean(move_district_next),
            `Probability Teachers Exit Public Schools` = 
              mean(quit_next)), 
        keyby = .(`Quartile of Distribution`, quartile)]
```

```{r table_7}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 urbanicity_s + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l)
```

```{r table_8}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 factor(district_fill) + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l, omit.coef = '^factor')
```

```{r table_9}
library(mlogit)
teachersML = 
  melt(teachers, id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_s', 'pct_frl_s', 'urbanicity_s',
           'ethnicity_main', 'pct_black_s', 'pct_hisp_s',
           'total_exp_floor', 'n_students', 'class_size','exp_split'), 
       measure.vars = c('stay', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

mnl_l = 
  lapply(split(teachersML, by = 'exp_split', sorted = TRUE), function(DT) {
    print(head(DT))
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_s + pct_frl_s + 
             ethnicity_main*pct_black_s + ethnicity_main*pct_hisp_s + 
             #need to include dummy for year, but solution fails
             urbanicity_s + total_exp_floor + 
             I(total_exp_floor^2) + n_students + class_size, data = DT)
  })
texreg(mnl_l)
```

# Conclusion

# References
