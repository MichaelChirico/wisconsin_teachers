---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "March 17, 2017"
output:
  pdf_document:
    keep_tex: yes
    includes:
      in_header: turnover_paper_header.tex
abstract: 'Given the consistently-affirmed importance of teacher quality to student success, understanding teacher churn is crucial to formulating and evaluating teacher labor market policy. This paper replicates the analysis of @hanushek over a longer and more recent time period in Wisconsin and confirms all of its major findings, namely that while pay is a inter-district pay differentials are a significant determinant of turnover, school quality measures are much better predictors of all three types of churn -- within and between school districts and out of local public schools.'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::read_chunk('turnover_data_cleaner.R')
library(xtable)
options(xtable.comment = FALSE)
options(xtable.include.rownames = FALSE)
library(data.table)
library(texreg)
```

```{r start_read, cache = TRUE, include = FALSE}
```

# Introduction

# Literature Review

Because the potential policy implications of turnover in the teaching profession (from human capital and equity/distributional perspectives both) are far-reaching and polypartisan, the literature on turnover-related topics in education is extensive. As relates to this paper, there are five broad (and often overlapping) categories of inquiry: the relationship between turnover and wages, which has tended to focus on “opportunity wages” outside of the field of education; the relationship between turnover, school demographics, and other nonpecuniary benefits, which has tended to focus on distributional inequalities--whether teachers with certain characteristics are more or less likely to be teaching certain disadvantaged groups; the relationship between turnover and teacher quality as measured by student performance, usually value added; collective bargaining agreements in education, focusing by and large on the implications (or lack thereof) of seniority-preferential clauses; and the recent phenomenon of specific retention incentives, the provisioning of wage bonuses to teachers willing to teach in high-needs schools.

One of the earliest papers attempting to rigorously investigate turnover was a panel study of teachers in Michigan by @murnane, who used college degree field wages outside of education as opportunity wages, finding the expected lower exit rate for teachers with higher wages in teaching relative to the authors' defined alternative. @dolton use panel data on university graduates in the United Kingdom to estimate a competing risks model of the decision to leave teaching entirely, finding results in line with @murnane. Returning to panel studies in the US, @loeb use PUMS data to get an idea of teacher relative wages in many states and find that dropout rates fall when teacher relative wages are high. @stinebrickner also uses panel data (this time NLS-72) to track both teachers and non-teachers, focusing in particular on young teachers who leave the profession for long stints, and finds that the best predictor of female exit is recent childbearing, which is an important consideration for all work related to teacher turnover because such a high percentage (76 nationwide) of teachers are female. Lastly, @hanushek focuses on teachers in Texas and emphasizes that the characteristics of students are much stronger factors in predicting teacher exit than are wages (while also affirming the statistical significance of pay).

While wages have been found consistently to have some measurable effect on teacher turnover, it is impossible to explain within-district migration (which constitutes a large portion of switching--as much as 50%) through wage-only channels because contracts are fixed at the district level. As such, another strand of literature has chosen to focus on the nonpecuniary aspects of the decision to take a teaching job--school environment/rapport, student enthusiasm, neighborhood characteristics, etc.--usually by directing attention to a single district so that any wage-based considerations are stifled, as is the case for @boyd and @engel. @boyd track early-career teachers in New York City as they quit or transfer out of the city, and most importantly finds that commuting time is an important, often overlooked aspect of location preference. @engel leverages a unique data set from Chicago Public School job fairs which affords them a rather strong measure of teachers' demand for vacancies, neutralizing the influence of school administration's behavior on turnover (through poor match selection or other means). The authors contribute evidence that the school's neighborhood (perhaps due to ambient crime or other reputational effects good and bad) is a better predictor of teachers' preference than distance from home, going somewhat against the grain of @boyd. @scafidi examine statewide data from Georgia, but ignore wage effects, choosing instead to focus on disentangling the contributions of low student achievement and minority status to turnover; they find that minority status is the more salient associate of teacher exit.

The key element missing from all of the above studies is perhaps the most important consideration in the issue of teacher turnover--teacher quality. None of the studies above have student-teacher matched data, and so are unable to directly associate student outcomes with any given teacher. If, with respect to any measure of quality you would like, we find that transitioning teachers are identical to their replacements, the issue of teacher turnover is not, in fact, much of an issue--it leans closer to hot air and wasted ink. Thus, the recent trend in the literature to incorporate measures of teacher quality (in large part made possible by a trend towards administrative records allowing students to be linked to teachers and tracked over time) in considerations of teacher turnover has made big strides in addressing the most policy-relevant questions to be asked. The most common and widely accepted measure of teacher quality is value added[^VA] (in its various guises), and the literature has begun to incorporate such measures into studies of teacher turnover. @hanushek2010 considers value added as a measure of teacher productivity, and ask if common results of labor search theory (namely that turnover falls with tenure and that turnover is negatively associated with match-specific productivity) continue to hold in the education labor market. In fact, the authors find that the teachers most likely to switch schools are those with low measured match quality, and especially that those who leave teaching entirely are those with the lowest match quality. The results are more pronounced for schools with high proportions of low-SES students, which has strong policy implications, as it appears the best teachers in high needs schools are the least likely to change jobs. @goldhaber2007 performs a similar analysis with the longitudinal data of North Carolina and comes to similar conclusions, strengthening the robustness of the results. Lastly, @goldhaber2015 examine the inequity in the distribution of teacher quality by high-needs groups in Washington state, and find that for all three measures of quality (teacher experience, licensure exam score, and value added), the distribution of teachers favors the less needy (as measured by free/reduced-price lunch status, minority status, and low prior academic achievement).

[^VA]: The most commonly cited expositions on value added, its validity, and so on are probably @rivkin, an extensive exploration of the predictive powers of empirical Bayes VA measures; and @chettyI and @chettyII, the largest-scale study of long-term inferences based on value added.

The aforementioned papers have tended to keep the collective bargaining aspect of salary determination for teachers out of the spotlight, if largely for reasons of data restrictions. Nevertheless, it stands to reason to believe that the rigid structure of union-negotiated contracts could serve to contribute in a large way to teacher turnover. @ballou give much descriptive evidence of the shape of the wage-tenure profile, rooted in a data set collected by the Department of Defense and published by the AFT. They find that seniority premia in education largely mirror those in more traditional white collar professins, that steeper profiles are associated with less turnover, and that district financial and demographic conditions alone are insufficient to explain variation in contracts. Another common (and recently quite controversial, as evidenced by the contention in the ongoing contract negotiations in Philadelphia) feature of union-negotiated teacher contracts are seniority priviliges--preferential treatments granted to teachers in voluntary and involuntary transfers. @moe codes contracts from 158 districts in California according to the strength of seniority rights therein guaranteed to teachers and finds that such rights are associated with the distribution of teachers across schools (measuring quality as experience and certification) in a way that serves to harm minorities. Revisiting California with a slightly different sample and definition of the “determinacy” of the contracts with respect to seniority, @koski come to the opposite conclusion--that there is no such relationship. As a rebuttal, @anzia pin the difference in results on the exclusion in @moe of small school districts, where it appears that the entrenchment of bureaucracy falters and the rigidity of contract language wane, a claim which they support by repeating their analysis with the inclusion of an interaction for district size--indeed, for small districts the result of @koski holds, while the insight of @moe holds in larger districts. @cohenvogel use data from Florida and their results align with those of @koski (though they neglect to nuance their results by district size).

Finally, an emerging but still immature strand of literature is beginning to look at the potential for transfer bonuses and retention incentives to positively affect student outcomes. @fulbeck analyzes a scheme in place in Denver whereby teachers who choose to transfer to high-needs schools (low-performing) are given recurring bonus pay, and those initially stationed there are given retention incentives. She concludes that recipients of incentives are significantly less likely to switch jobs, as driven by a reduction in district exit rates and especially by teachers whos incentive payments exceed \$5,000. @glazerman evaluate the Talent Transfer Initiative, a randomized controlled trial conducted in 10 districts whereby high-performance teachers were given \$20,000 over the course of two years as reward for transferring the identified high-needs schools, and conclude that there were significant effects on teacher retention as well as on student outcomes. 

# Data

The State of Wisconsin's Department of Public Instruction (DPI) releases annual Salary, Position & Demographic reports through the WISEstaff data collection system, and these reports represent "a point-in-time collection of all staff members in public schools as of the 3rd Friday of September..." [@dpi], which serve as the primary source of data on teachers in this paper. Data are available at the position-teacher level cross-sectionally, with each entry corresponding to one of possibly several positions held by each school district employee. Identifiers in each file permit unique identification of an employee within a given year, but this identifier does not follow teachers between years. To overcome this substantial hurdle to identifying teacher mobility, data are first fed through the matching algorithm described in further detail in the appendix. Essentially, we are aided by the presence of various imperfect identifiers which are more stable over time, most crucially teachers' first and last names and years of birth. By building on these covariates and incorporating some limited fuzzy matching techniques, we construct a panel of teachers spanning the 1994-95 academic year (AY) through AY2015-16 [^spring]. 

[^spring]: For brevity, we herein refer to academic years by the spring year, e.g., AY2003-04 will be simply 2004.

As noted in the companion paper, the introduction of Wisconsin Act 10 introduced a substantial structural break in the labor market for Wisconsin teachers, so we include only data from `r teachers[ , sprintf('%d-%d', min(year), max(year))]` to avoid conflating the effects of this policy on teacher turnover, a topic covered in more detail in the companion paper and elsewhere, with the earlier functioning of the labor market (i.e., we do not want to mix the results from distinct equilibria of the teacher labor market, but would prefer to analyze the pre- and post-Act-10 markets separately). We drop all employees who are not full-time, full-year regular teachers of a major core subject (all-purpose elementary teachers or English/Math) at a single regular public school with a Bachelor's or Master's degree and fewer than 50 years' recorded experience; taken together, these restrictions eliminate `r round(100*abs(N_subset_I/N_full - 1))`% of employees, the lion's share of which come from eliminating substitutes/support staff and teachers non-core subjects. We then eliminate teachers with missing information on their subsequent school or district and teachers with instability in their recorded ethnicity, as well as teachers not categorized as white, black, or Hispanic, eliminating a further `r round(100*(N_subset_I - N_subset_II)/N_full)`% of all employees[^ethnicity]. Finally, we drop teachers' multiple positions by keeping only the highest-intensity position for each teacher, as measured by full-time equivalency, resulting in a final count of `r prettyNum(nrow(teachers), big.mark = ',')` teacher-year observations.

[^ethnicity]: Wisconsin teachers are predominantly white (`r pct_white`%).

This data is also used for the incorporation of counterfactual salary calculations, by incorporating the salary schedules estimated in the companion paper. Details of the fit procedure can be found there, but essentially salary schedules are computed as monotonicity- and concavity-constrained median-targeted splines [@ng] for each level of certification (Bachelor's or Master's degree) in each district in each year[^area_diff]. Data sparsity led this procedure to be unreliable in many cases, so ultimately around `r teachers[ , round(100*mean(is.na(schedule_lsalary)))]`% of teachers have missing salary information[^na_salary], mostly in rural districts or other districts with only one or two schools and a small number of students.

[^area_diff]: One difference is that the salaries included in the payscales estimation were less restrictive with respect to included subject areas. This was done since contracts are collectively bargained at the district level for all teachers, with scant mention of subject area in wage determination.

[^na_salary]: More specifically, we eliminate district-years featuring less than 20 teachers, less than 7 distinct levels of observed experience, or less than 5 unique values of the two measures of pay (salary and fringe benefits) in either degree track. HKR include like-minded restrictions, but combine teachers of different certification within an experience level.

We supplement the DPI teacher salary data set in several ways to incorporate data about other characteristics of schools and districts in Wisconsin. To get school- and district-level measures of socioeconomic makeup (percentage of students who are black or Hispanic or eligible for free/reduced lunches) and community type/urbanicity, we tap the National Center for Education Statistics' Common Core of Data's Universe Surveys, which provide this information on a yearly basis for all years in the study[^urbanicity_details]. At the district level, we also use this data to compute class size and the size of the student body.

[^urbanicity_details]: The method of recording urbanicity by the Common Core switched from being "metropolitan-centric" to being "urban-centric" for Wisconsin from 2006 [@sable]. We map the codes corresponding codes to match those used by HKR as well as possible, and use the data file from 2006, which has both types of code for all US districts, to confirm that this correspondence is by and large working as intended. For a small number of districts/schools with missing urbanicity codes in certain years, we use information from other years to inform urbanicity.

Lastly, we turn to DPI's public data again to get school- and district-level performance metrics. While @hanushek were able to obtain school- and district-level average scale scores on a standardized test in Texas, such a metric is not publicly available in Wisconsin for all years. Instead, we calculate student proficiency rates for each school and district as the percentage of test-takers deemed to be at grade level in mathematics or reading in a given year on the Wisconsin Knowledge and Concepts Examination (WKCE), which is administered to 4th, 8th, and 10th-grade students.

# Results

Table \ref{tbl:move_by_exp} replicates Table 1 of @hanushek (HKR), and as HKR found in Texas, most turnover in Wisconsin is happening within districts and out of the profession. In Wisconsin, the fraction of teachers transitioning among districts is vanishingly small after a "burn-in" period of roughly 6 years -- only `r round(100*teachers[total_exp_floor >= 7, mean(move_district_next)], 1)` of such teachers do so (compared with `r round((4.5*75284 + 2.5*165873 + 0.7*6978)/(75284+165873+6978), 1)`% for the comparable group in HKR), but is still relatively higher among the youngest teachers -- roughly twice as high for the "probationary" teachers (1-3 years' experience) as for teachers with 7-11 years' experience in both states.

By contrast, movement patterns within districts in the two states are very similar, lending weight to teachers "earning their stripes" within a district to be able to choose the best schools as a privilege of seniority. As expected, we also observe a U-shaped pattern in teachers exiting Wisconsin public schools, which jives with two types of quits. Early-career quitters who change to private schools, change state of residence, or change professions, and late-career quitters who retire. Results not included here break down the exit rates by experience level, where this dichotomy is even more dramatic -- first-year exit rates are about 9 percent and quickly level off at around 2 percent before spiking again past around 25 years.

As examined further below, the low rate of switches between districts appears to be owing to the generally more rural nature of Wisconsin vis-\`{a}-vis. Texas. To wit, Milwaukee is the only major urban area in the state, and its population (2010 Census) of 594,833 would rank 7th in Texas. This means that two major types of movers in the HKR data -- Large Urban - Large Urban and Suburban - Large Urban -- are limited within the state to ending up in a relatively minor metropolitan area. HKR don't provide any results disaggregated by city, precluding any attempts to compare these numbers more comparably to those that would obtain from eliminating the largest cities in Texas.

```{r table_1, results = 'asis', message = FALSE}
library(funchir)
T1 = rbind(
  teachers[ , .(`Remain in Same School` = 100*sum(!move_school_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ',')),
            keyby = .(`Teacher Experience` = exp_split)],
  teachers[ , .(`Teacher Experience` = 'All',
                `Remain in Same School` = 100*sum(!move_school_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ','))])
suppressWarnings(
  tbl <- capture.output(print(xtable(
    T1, caption =
      'Year-to-year Transitions of Teachers by Experience, 2000-08', 
    label = 'tbl:move_by_exp', digits = 1L, 
    align = paste0('lp{.103\\linewidth}p{.14\\linewidth}',
                   'p{.15\\linewidth}p{.09\\linewidth}',
                   'p{.16\\linewidth}R{.16}')),
    sanitize.text.function = identity))
)
idx = grep('^Teacher', tbl) - 1L
tbl = c(tbl[1L:idx], 
        ' & \\multicolumn{4}{c}{Percent of Teachers Who} & \\\\ \\cline{2-5}',
        tbl[(idx+1L):length(tbl)])
cat(tbl, sep = '\n')

# code to produce plot of quits by experience level, with
#   bootstrapped confidence intervals:
# x = teachers[total_exp_floor <= 40]
# setkey(x, teacher_id)
# IDs = unique(x$teacher_id)
# 
# bs = rbindlist(replicate(5000, x[.(sample(IDs, replace = TRUE)), 
#                                  mean(quit_next),
#                                  keyby = total_exp_floor],
#                          simplify = FALSE))
# 
# Y = merge(x[, mean(quit_next), keyby = total_exp_floor],
#           bs[ , as.list(quantile(V1, c(.025, .975))), keyby = total_exp_floor],
#           by = 'total_exp_floor')
# Y[ , matplot(total_exp_floor, .SD[ , !"total_exp_floor"])]
```

Table \ref{tbl:markov} replicates HKR Table 2, and supports its most important conclusions. HKR argue that there is little support for the idea that scores of young teachers are using large urban schools as a training ground before "settling down" with easier assignments in the suburb, based on the general low level of turnover from Large Urban districts. We affirm the scarcity of transitions from districts in Milwaukee, while also noting that such a path is certainly present, as evidenced by the majority of those who do leave Large Urban districts ending up in a Surburban district in both settings.

As mentioned in the discussion of Table \ref{tbl:move_by_exp}, the major difference with respect to quantities observed in Texas appears to be driven in differences in the urban landscape between Texas and Wisconsin[^share]. This is supported by the overall similarity of magnitudes of transition rates to community types besides Large Urban in the two papers. Again, the "stickiest" community type is Rural -- over 60% of Rural teachers remain Rural in both papers, and even fewer Rural Wisconsin teachers end up in a big city than is the case for Texas. Also as in HKR, we find broad similarity in the community type transition patterns of younger teachers as compared to all teachers.

[^share]: We also note a difference in the relative shift in population between the two states -- Texas observed dramatic changes in its community type distribution over the period of study of only 4 years, while Wisconsin only saw some movement from Rural to Suburban communities.

```{r table_2, results = 'asis'}
#** TO DO **
# - evidence for total cumulative pipeline from inner city to suburbs?
# - calculate steady-state distribution of markov chain
# - calculate distribution of distance moved between districts (esp. rural)
# - include overall breakdown of community type (and compare to Texas -- CCD)
# - probationary urban & suburban equally likely to remain in the same school
# - probationary urban & suburban slightly more likely to quit
# - count # of new teachers each year in suburbs to support lack of
#     of constraint on demand side for new teachers (re: no urban switching)
# - fix urbanicity for each district to overcome re-coding issue
share_change = 
  #use 2006, not incl_rng, because of the artificial change in 
  #  shares induced by the change in how urbanicity is calculated
  teachers[year %in% c(2000, 2006), .N, by = .(year, urbanicity_s)
           ][ , shr := N/sum(N), by = year
              ][order(year), .(delta = diff(shr)), by = urbanicity_s]
T2 = rbind(
  teachers[ , {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N,
           change_share = 
             share_change[.BY, sprintf('%.1f\\%%', 100*delta), 
                          on = 'urbanicity_s']))
  }, keyby = urbanicity_s],
  teachers[total_exp_floor <= 3, {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N))
  }, keyby = urbanicity_s],
  fill = TRUE)

setnames(T2, grep('[^y]_', names(T2)), character(3L))
T2[ , c('Origin Community', 'urbanicity_s') :=
      .(paste0('\\quad ', urbanicity_s), NULL)]
setcolorder(T2, c(ncol(T2), seq_len(ncol(T2) - 1L)))

tbl = capture.output(print(xtable(
  T2, caption = paste('Destination Community Type for Teachers',
                      'Changing Districts, by Origin Community',
                      'Type and Teacher Experience Level'),
  label = 'tbl:markov', digits = 1L, align = 'llrrrrrrr'),
  sanitize.text.function = identity, floating.environment = 'sidewaystable'))
idx = grep('^Origin', tbl)
mrow = function(x, n) paste0('\\multirow{', n, '}{*}{', x, '}')
mcol = function(x, n) paste0('\\multicolumn{', n, '}{c}{', x, '}')
pbox = function(x, p) paste0('\\parbox{', p, '\\linewidth}{', x, '}')
tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol(mrow('Percent of Teachers Who Move to', 2), 4),
                     mrow(pbox('Number Teachers Changing Districts', .09), 4),
                     mrow(pbox('Percent of Origin Teachers', .07), 4),
                     mrow(pbox('Change in Share of Teachers 2000-06', .07), 4), 
                     sep = ' & '), '\\\\'),
        ' & \\multicolumn{4}{c}{} & & & \\\\ \\cline{2-5}',
        '& & & & & & & \\\\', tbl[idx + 0L:1L],
        'I. All teachers & & & & & & & \\\\', tbl[idx + (2L:5L)], 
        '\\multicolumn{3}{l}{II. Probationary teachers ' %+% 
          '(1-3 years experience)}' %+%
          ' & & & & & \\\\', tbl[(idx+6L):length(tbl)])
cat(tbl, sep = '\n')
```

Table \ref{tbl:change_by_ge} replicates Table 3 of HKR, and confirms its most important insights. Raw salary differentials predict teacher mobility, but the pay differential is not on average very large -- only about \$200, or 0.4% higher than the counterfactually expected wage that would have obtained had the district-switching teacher remained in their current district. This premium declines with age for both male and female teachers, eventually dipping negative (though this estimate is imprecise/underpowered due to the limited quantity of teachers changing districts after 6 years).

Attempting to isolate the influence of district characteristics on wage effects, HKR suggest comparing the differential leverage of residual wages to get a more focused estimate of the association between wages and mobility. We run a similar regression using the payscales estimated in the companion paper, but evaluate separate regressions not just for each level of experience, but also for each certification track. This leads to a boost in the overall fraction of explained variance from 60% cited by HKR to `r teachers[ , round(100*var(schedule_lsalary_pred)/var(schedule_lsalary))]`% here; as in HKR, other included covariates are consistently significant, suggesting their strong independent correlation with salary levels.

As in HKR, we find the demographic-independent wage differentials to be even more important than the uncontrolled raw wages, with the predicted wage improvement nearly doubling to 0.8%. In contrast to HKR, however, we find a positive relationship between experience and residual wage differentials, with mid-career district switchers experiencing 2-3% higher wages upon arrival to their new employer, by contrast to the null relationship for probationary teachers. 

Student demographic differentials are very important for predicting teacher turnover, a finding which held in Texas as it does in Wisconsin. Most important in all experience classes and for both genders are the measures of student performance and student poverty -- district switchers end up at schools with 4% more students at grade level overall, an effect which is stronger for female teachers and for young teachers. They also end up on average with about 7% fewer students (school-wide) eligible for subsidized lunch. While this finding would need to be bolstered with experimental or quasi-experimental evidence, it hints at the potentially limited scope of teacher labor market policies intended to ameliorate teacher supply problems in hard-to-serve districts -- schools can much more easily exert influence over their compensation policies than they can dictate their student bodies, but the latter is more efficacious [see @fulbeck and @glazerman]. 

```{r table_3, results = 'asis'}
#** TO DO **
# - subset to years with scale scores available, use this instead
# - WKCE data for 2001-02 and earlier are NOT comparable to
#   performance level data for 2002-03 and later years...
# - real wages?
# - bootstrap adjusted wage procedure to incorporate
#   first-stage variability into standard errors
# - explore _why_ differential wages become more important with experience;
#   does ignoring certification bias this result in this way?
T3 = 
  teachers[move_district_next & total_exp_floor <= 10, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean),
                    sapply(dl, function(x) sd(x)/sqrt(length(x))))))
  }, keyby = .(exp_split, gender)
  ][ , dcast(.SD, var ~ gender + exp_split, value.var = 'val')]
T3[ , all := 
      teachers[move_district_next & total_exp_floor <= 10, {
        dl = lapply(
          list(schedule_lsalary_next - schedule_lsalary_next_cf,
               schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
               pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
               pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
          na.omit)
        c(rbind(sapply(dl, mean),
                sapply(dl, function(x) sd(x)/sqrt(length(x)))))}]]

T3[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3), c('var', 'type'))
sidx = T3$type == 's'
pidx = grepl('^Percent', T3$var)
T3[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3[type == 's', var := '']
T3[ , type := NULL]
setnames(T3, c('', rep(exp_lab[1L:3L], 2L), ''))

tbl = capture.output(print(xtable(
  T3, caption = paste('Average Change in Salary and District Student',
                      'Characteristics (and Standard Deviations) for',
                      'Teachers Changing Districts, by Gender and Experience'),
  label = 'tbl:change_by_ge', align = 'llccccccc'), 
  floating.environment = 'sidewaystable'))

idx = grep('years', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Men by Experience Class', 3L),
                     mcol('Women by Experience Class', 3L),
                     mrow(pbox('All Teachers 0-9 Years', .09), 2L),
                     sep = ' & '), '\\\\ \\cline{2-4} \\cline{5-7}'),
        tbl[idx:length(tbl)])

cat(tbl, sep = '\n')
```

```{r table_4, results = 'asis'}
se = function(x) sd(x)/sqrt(length(x))
T4D = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(schedule_lsalary_next - schedule_lsalary_next_cf,
                      schedule_lsalary_resid_next -
                        schedule_lsalary_resid_next_cf,
                      pct_prof_next_d - pct_prof_d, 
                      pct_hisp_next_d - pct_hisp_d,
                      pct_black_next_d - pct_black_d, 
                      pct_frl_next_d - pct_frl_d),
                 na.omit)
               .(var = paste0(rep(seq_len(6L), each = 2L),
                              rep(c('M', 'S'), 6L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

T4S = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s,
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s,
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = paste0(rep(3L:6L, each = 2L), rep(c('M', 'S'), 4L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

T4 = merge(T4D, T4S, by = 'var', all.x = TRUE)

T4[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T4[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T4), c('var', 'type'))
sidx = T4$type == 's'
pidx = grepl('^Percent', T4$var)
T4[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f\\%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f\\%%)', 100*x[pidx & sidx])
  o[is.na(x) & !sidx] = '---'
  o[is.na(x) & sidx] = ''
  o}), .SDcols = cols]
T4[type == 's', var := '']
T4[ , type := NULL]
T4[grepl('^Percent', var), var := paste('\\quad', var)]

tbl = capture.output(print(xtable(
  T4, caption = paste('Average Change in Salary and in District and Campus',
                      'Student Characteristics (and Standard Deviations)',
                      'for Teachers with 1-10 Years of Experience Who',
                      'Change Districts, by Community Type of Origin',
                      'and Destination District'),
  label = 'tbl:change_by_urb', 
  align = paste0('llp{.12\\textwidth}p{.12\\textwidth}',
                 'p{.12\\textwidth}p{.12\\textwidth}')),
  sanitize.text.function = identity))

idx = grep('Urban', tbl) - 1L

tbl = c(tbl[1L:idx],
        paste0(paste('', mcol('District Average Characteristics', 2L),
                     mcol('Campus Average Characteristics', 2L),
                     sep = ' & '), '\\\\ \\cline{2-5}'),
        ' & Large Urban to Suburban & Suburban to Suburban & ' %+%
          'Large Urban to Suburban & Suburban to Suburban \\\\',
        tbl[(idx + 2L):length(tbl)])

idx = grep('quad', tbl)[1L] - 1L

tbl = c(tbl[1L:idx], 'Average Student Characteristics & & & & \\\\',
        tbl[(idx+1L):length(tbl)])

cat(tbl, sep = '\n')
```

```{r table_5, results = 'asis'}
T5D = 
  teachers[move_district_next & total_exp_floor <= 10 & 
             ethnicity_main %in% c('Black', 'Hispanic'), {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L),
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

T5S = 
  teachers[move_within_next & total_exp_floor <= 10 & 
             ethnicity_main %in% c('Black', 'Hispanic'), {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L), 
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean),
                               sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

T5 = merge(T5D, T5S, by = 'var', all.x = TRUE)

T5[ , var := rep(c('Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch',
                   'Number of teachers'), c(2L, 2L, 2L, 2L, 1L))]
T5[ , type := c(rep(c('m', 's'), 4L), 'n')]
cols = setdiff(names(T5), c('var', 'type'))
sidx = T5$type == 's'
pidx = grepl('^Percent', T5$var)
nidx = T5$type == 'n'
T5[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o[nidx] = prettyNum(x[nidx], big.mark = ',')
  o}), .SDcols = cols]
T5[type == 's', var := '']
T5[ , type := NULL]

tbl = capture.output(print(xtable(
  T5, caption = paste('Average Change in District and Campus Student',
                      'Characteristics (and Standard Deviations)',
                      'for Black and Hispanic Teachers with 1-10',
                      'Years of Experience who Change Campuses'),
  label = 'tbl:change_by_eth', 
  align = paste0('llp{.1\\textwidth}p{.1\\textwidth}',
                 'p{.1\\textwidth}p{.1\\textwidth}'))))

idx = grep('Black.x', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Between District Moves', 2L),
                     mcol('Within District Moves', 2L),
                     sep = ' & '), '\\\\ \\cline{2-5}'),
        ' & Black Teachers & Hispanic Teachers & ' %+%
          'Black Teachers & Hispanic Teachers \\\\',
        tbl[(idx + 1L):length(tbl)])

cat(tbl, sep = '\n')
```

```{r table_6, results = 'asis'}
T6 = 
  melt(teachers, id.vars = c('year', 'move_district_next', 
                             'move_within_next', 'quit_next'), 
       measure.vars = paste0(q_var, '_q'), na.rm = TRUE, value.factor = TRUE
       )[ , .(`Probability Teachers Move to New School within District` = 
                mean(move_within_next),
              `Probability Teachers Move to New District` = 
                mean(move_district_next),
              `Probability Teachers Exit Public Schools` = 
                mean(quit_next)), 
          keyby = .(variable, value)]
T6[variable == 'lwage_resid_avg_q', grep('within', names(T6)) := NA]
T6[ , variable := NULL]
cols = grep('^Prob', names(T6))
T6[ , (cols) := lapply(.SD, function(x) {
  o = sprintf('%.1f\\%%', 100*x)
  is.na(o) = is.na(x); o}), .SDcols = cols]
T6[ , value := paste0('\\quad ', value)]
setnames(T6, 'value', 'Quartile of Distribution')

tbl = capture.output(print(xtable(
  T6, caption = paste('School Average Transition Rates by Distribution of',
                      'Residual Teacher Salary and Student Demographic',
                      'Characteristics (data weighted by number of',
                      'teachers in school)'),
  label = 'tbl:change_by_quartile',
  align = 'lp{.25\\textwidth}p{.13\\textwidth}p{.13\\textwidth}p{.13\\textwidth}'), 
  sanitize.text.function = identity, NA.string = '---'))

idx = grep('Highest', tbl)
tbl[idx] = paste0(c('Residual salary', 'Percent proficient',
                    'Percent eligible for reduced-price lunch',
                    'Percent Black', 'Percent Hispanic'),
                  ' & & & \\\\\n', tbl[idx])
cat(tbl, sep = '\n')
```

```{r table_7, results = 'asis'}
reg_l = 
  lapply(split(teachers, f = teachers$exp_split),
         function(DT) 
           DT[ , lm(leave_next ~
                      schedule_lbase_ba_salary*gender + 
                      pct_prof_s + pct_frl_s + 
                      ethnicity_main*pct_black_s + 
                      ethnicity_main*pct_hisp_s + factor(year) + 
                      urbanicity_s + total_exp_floor + 
                      I(total_exp_floor^2) + n_students_d + class_size_d)])

coefn = setNames(nm = names(coef(reg_l[[1L]])))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_s', 'pct_frl_s', 'pct_black_s', 'pct_hisp_s',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_s')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts, by Experience (linear',
                  'probability models; standard errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), 
  reorder.coef = c(1, 6, 2:5, 7:10),
  include.rsquared = FALSE, include.adjrs = FALSE, include.rmse = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])

idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)

#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

```{r table_8, results = 'asis', cache = TRUE}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(leave_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 factor(district_fill) + total_exp_floor + 
                                 I(total_exp_floor^2) +
                                 n_students_d + class_size_d)])

#some districts are dropped by lm
#  (insufficient variation given low frequency of moves & other covariates)
coefn = setNames(nm = Reduce(union, lapply(reg_l, function(x) names(coef(x)))))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_s', 'pct_frl_s', 'pct_black_s', 'pct_hisp_s',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_s')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm_fe', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts with District Fixed',
                  'Effects, by Experience (linear probability models;',
                  'standard errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), 
  reorder.coef = c(1, 6, 2:5, 7:10),
  include.rsquared = FALSE, include.adjrs = FALSE, include.rmse = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])
idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

```{r table_9, eval = FALSE}
library(mlogit)
teachersML = 
  melt(teachers, id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_s', 'pct_frl_s', 'urbanicity_s',
           'ethnicity_main', 'pct_black_s', 'pct_hisp_s',
           'total_exp_floor', 'n_students_d', 'class_size_d','exp_split'), 
       measure.vars = c('stay_next', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

mnl_l = 
  lapply(split(teachersML, by = 'exp_split', sorted = TRUE), function(DT) {
    print(head(DT))
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_s + pct_frl_s + 
             ethnicity_main*pct_black_s + ethnicity_main*pct_hisp_s + 
             #need to include dummy for year, but solution fails
             urbanicity_s + total_exp_floor + 
             I(total_exp_floor^2) + n_students_d + class_size_d, data = DT)
  })
texreg(mnl_l)
```

# Conclusion

# References
