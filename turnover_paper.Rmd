---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    keep_tex: yes
    includes:
      in_header: turnover_paper_header.tex
fontsize: 12pt
linestretch: 1.5
abstract: 'Given the consistently-affirmed importance of teacher quality to student success, understanding teacher churn is crucial to formulating and evaluating teacher labor market policy. This paper replicates and extends the analysis of @hanushek over a longer and more recent time period in Wisconsin and confirms all of its major findings, namely that while inter-district pay differentials are a significant determinant of turnover, school quality measures are much better predictors of all three types of churn -- within and between school districts and out of local public schools.'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::read_chunk('turnover_data_cleaner.R')
library(xtable)
options(xtable.comment = FALSE)
options(xtable.include.rownames = FALSE)
options(xtable.table.placement = 'htbp')
library(data.table)
library(texreg)
library(sandwich)
library(lmtest)
library(mlogit)
```

```{r start_read, cache = TRUE, include = FALSE}
```

# Introduction

Good teachers have large impacts on student achievement[^teachers_important]. It is therefore imperative for public schools to be able to attract and retain high-quality teachers. Of preeminent concern for policymakers, then, is the strength of the various manipulable levers at their disposal for influencing teacher labor markets. More specifically, state education administrators would like to identify the policy implications of various tools on three types of teacher mobility: intra-district switching, where due to the collectively bargained nature of most teachers' salaries, only nonpecuniary considerations matter, inter-district switching, where teachers move to another school district in the same state, and exo-district switching, where teachers leave the public teaching workforce entirely[^new_teachers].

[^teachers_important]: See, e.g., @rockoff.

[^new_teachers]: Policies that affect the supply and quality of new teachers to the profession may also be of considerable importance to replenishing and improving the stock of teachers over time, but we do not consider these channels in this work. See @harris, @wayne, and @boyd2009.

In this paper, we consider pecuniary and non-pecuniary predictors of various types of teacher churn in replicating the analyses of @hanushek in a new context (Wisconsin) and time horizon (2000 - 2007). The headline results of @hanushek were "that teacher mobility is much more strongly related to characteristics of the students, particularly race and achievement, than to salary, although salary exerts a modest impact once compensating differentials are taken into account." We confirm the pith of this conclusion, namely that student characteristics are a much better predictor of turnover than are wage differentials, though we come to different conclusions regarding more specific points. In fact, while we do find strong evidence that the socioeconomic makeup of a teacher's district predicts turnover (and that there is heterogeneity in this effect by teacher race), the evidence we find for the importance of wages and student achievement is far from compelling.

We explore to the extent possible potential contributors to this discrepancy in results; most salient are the differences between Texas, where @hanushek conduct their study, and Wisconsin. Wisconsin is a largely rural state -- its largest city/metropolitan area (in fact it is the only city considered to be "large" for NCES reporting purposes), Milwaukee, currently has roughly 600,000 residents (1,500,000 including the metropolitan area), making it around the 30th-largest city in the United States. By contrast, Texas has six cities larger than this, with El Paso being the nearest in size to Milwaukee. Though the non-urban parts of Texas are themselves sparsely populated and distinctly rural, the more uniform lack of major population centers in Wisconsin is likely to be reflected in considerably different preferences among local residents for various aspects of potential teaching positions. 

# Literature Review

Because the potential policy implications of turnover in the teaching profession (from human capital and equity/distributional perspectives both) are far-reaching and polypartisan, the literature on turnover-related topics in education is extensive. As relates to this paper, there are five broad (and often overlapping) categories of inquiry: the relationship between turnover and wages, which has tended to focus on “opportunity wages” outside of the field of education; the relationship between turnover, school demographics, and other nonpecuniary benefits, which has tended to focus on distributional inequalities--whether teachers with certain characteristics are more or less likely to be teaching certain disadvantaged groups; the relationship between turnover and teacher quality as measured by student performance, usually value added (VA); collective bargaining agreements in education, focusing by and large on the implications (or lack thereof) of seniority-preferential clauses; and the recent phenomenon of specific retention incentives, the provisioning of wage bonuses to teachers willing to teach in high-needs schools.

One of the earliest papers attempting to rigorously investigate turnover was a panel study of teachers in Michigan by @murnane, who used college degree field wages outside of education as opportunity wages, finding the expected lower exit rate for teachers with higher wages in teaching relative to the authors' defined alternative. @dolton use panel data on university graduates in the United Kingdom to estimate a competing risks model of the decision to leave teaching entirely, finding results in line with @murnane. Returning to panel studies in the US, @loeb use PUMS data to get an idea of teacher relative wages in many states and find that dropout rates fall when teacher relative wages are high. @stinebrickner also uses panel data (this time NLS-72) to track both teachers and non-teachers, focusing in particular on young teachers who leave the profession for long stints, and finds that the best predictor of female exit is recent childbearing, which is an important consideration for all work related to teacher turnover because such a high percentage (76 nationwide) of teachers are female. Lastly, @hanushek focuses on teachers in Texas and emphasizes that the characteristics of students are much stronger factors in predicting teacher exit than are wages (while also affirming the statistical significance of pay).

While wages have been found consistently to have some measurable effect on teacher turnover, it is impossible to explain within-district migration (which constitutes a large portion of switching--as much as 50%) through wage-only channels because contracts are fixed at the district level. As such, another strand of literature has chosen to focus on the nonpecuniary aspects of the decision to take a teaching job--school environment/rapport, student enthusiasm, neighborhood characteristics, etc.--usually by directing attention to a single district so that any wage-based considerations are stifled, as is the case for @boyd2005 and @engel. @boyd2005 track early-career teachers in New York City as they quit or transfer out of the city, and most importantly finds that commuting time is an important, often overlooked aspect of location preference. @engel leverages a unique data set from Chicago Public School job fairs which affords them a rather strong measure of teachers' demand for vacancies, neutralizing the influence of school administration's behavior on turnover (through poor match selection or other means). The authors contribute evidence that the school's neighborhood (perhaps due to ambient crime or other reputational effects good and bad) is a better predictor of teachers' preference than distance from home, going somewhat against the grain of @boyd2005. @scafidi examine statewide data from Georgia, but ignore wage effects, choosing instead to focus on disentangling the contributions of low student achievement and minority status to turnover; they find that minority status is the more salient associate of teacher exit.

The key element missing from all of the above studies is perhaps the most important consideration in the issue of teacher turnover--teacher quality. None of the studies above have student-teacher matched data, and so are unable to directly associate student outcomes with any given teacher. If, with respect to any measure of quality you would like, we find that transitioning teachers are identical to their replacements, the issue of teacher turnover is not, in fact, much of an issue. Thus, the recent trend in the literature to incorporate measures of teacher quality (in large part made possible by a trend towards administrative records allowing students to be linked to teachers and tracked over time) in considerations of teacher turnover has made big strides in addressing the most policy-relevant questions to be asked. The most common and widely accepted measure of teacher quality is VA[^value_added] (in its various guises), and the literature has begun to incorporate such measures into studies of teacher turnover. @hanushek2010 consider VA as a measure of teacher productivity, and ask if common results of labor search theory (namely that turnover falls with tenure and that turnover is negatively associated with match-specific productivity) continue to hold in the education labor market. In fact, the authors find that the teachers most likely to switch schools are those with low measured match quality, and especially that those who leave teaching entirely are those with the lowest match quality. The results are more pronounced for schools with high proportions of low-SES students, which has strong policy implications, as it appears the best teachers in high needs schools are the least likely to change jobs. @goldhaber2007 performs a similar analysis with the longitudinal data of North Carolina and comes to similar conclusions, strengthening the robustness of the results. Lastly, @goldhaber2015 examine the inequity in the distribution of teacher quality by high-needs groups in Washington state, and find that for all three measures of quality (teacher experience, licensure exam score, and VA), the distribution of teachers favors the less needy (as measured by free/reduced-price lunch status, minority status, and low prior academic achievement).

[^value_added]: The most commonly cited expositions on value-added, its validity, and so on are probably @rivkin, an extensive exploration of the predictive powers of empirical Bayes VA measures; and @chettyI and @chettyII, the largest-scale study of long-term inferences based on VA.

The aforementioned papers have tended to keep the collective bargaining aspect of salary determination for teachers out of the spotlight, if largely for reasons of data restrictions. Nevertheless, it stands to reason to believe that the rigid structure of union-negotiated contracts could serve to contribute in a large way to teacher turnover. @ballou give much descriptive evidence of the shape of the wage-tenure profile, rooted in a data set collected by the Department of Defense and published by the AFT. They find that seniority premia in education largely mirror those in more traditional white collar professins, that steeper profiles are associated with less turnover, and that district financial and demographic conditions alone are insufficient to explain variation in contracts. Another common (and recently quite controversial, as evidenced by the contention in the ongoing contract negotiations in Philadelphia) feature of union-negotiated teacher contracts are seniority priviliges--preferential treatments granted to teachers in voluntary and involuntary transfers. @moe codes contracts from 158 districts in California according to the strength of seniority rights therein guaranteed to teachers and finds that such rights are associated with the distribution of teachers across schools (measuring quality as experience and certification) in a way that serves to harm minorities. Revisiting California with a slightly different sample and definition of the “determinacy” of the contracts with respect to seniority, @koski come to the opposite conclusion--that there is no such relationship. As a rebuttal, @anzia pin the difference in results on the exclusion in @moe of small school districts, where it appears that the entrenchment of bureaucracy falters and the rigidity of contract language wane, a claim which they support by repeating their analysis with the inclusion of an interaction for district size--indeed, for small districts the result of @koski holds, while the insight of @moe holds in larger districts. @cohenvogel use data from Florida and their results align with those of @koski (though they neglect to nuance their results by district size).

Finally, an emerging strand of literature is looking at the potential for transfer bonuses and retention incentives to positively affect student outcomes. @fulbeck analyzes a scheme in place in Denver whereby teachers who choose to transfer to high-needs schools (low-performing) are given recurring bonus pay, and those initially stationed there are given retention incentives. She concludes that recipients of incentives are significantly less likely to switch jobs, as driven by a reduction in district exit rates and especially by teachers whos incentive payments exceed \$5,000. @glazerman evaluate the Talent Transfer Initiative, a randomized controlled trial conducted in 10 districts whereby high-performance teachers were given \$20,000 over the course of two years as reward for transferring the identified high-needs schools, and conclude that there were significant effects on teacher retention as well as on student outcomes. Two highly germane papers investigate the impact in Wisconsin on teachers of Governor Scott Walker's flagship policy, Act 10, which severely limited the scope for collective bargaining in the state. @litten uses differences in contract renewal dates surrounding the policy's enactment to evince the effect of unionization on teachers' wages, and finds the lack of union bargaining power reduced teacher compensation by 8%. @biasi constructs value-added measures from grade-level test results and concludes that the move to individually-negotiated salaries in some districts had a significant impact on teacher quality and student outcomes in such districts, while also cautioning that most of these gains are competition-based, so that scaling up the system state-wide would have an impact limited to a boost from the exit of low-quality teachers. 

# Data

The State of Wisconsin's Department of Public Instruction (DPI) releases annual Salary, Position & Demographic reports through the WISEstaff data collection system, and these reports represent "a point-in-time collection of all staff members in public schools as of the 3rd Friday of September..." [@dpi], which serve as the primary source of data on teachers in this paper. Data are available at the position-teacher level cross-sectionally, with each entry corresponding to one of possibly several positions held by each school district employee. Identifiers in each file permit unique identification of an employee within a given year, but this identifier does not follow teachers between years. To overcome this substantial hurdle to identifying teacher mobility, data are first fed through the matching algorithm described in further detail in the appendix. Essentially, we are aided by the presence of various imperfect identifiers which are more stable over time, most crucially teachers' first and last names and years of birth. By building on these covariates and incorporating some limited fuzzy matching techniques, we construct a panel of teachers spanning the 1994-95 academic year (AY) through AY2015-16 [^spring]. 

[^spring]: For brevity, we herein refer to academic years by the spring year, e.g., AY2003-04 will be simply 2004.

As noted in the companion paper, the introduction of Wisconsin Act 10 introduced a substantial structural break in the labor market for Wisconsin teachers, so we include only data from `r teachers[ , sprintf('%d-%d', min(year), max(year))]` to avoid conflating the effects of this policy on teacher turnover, a topic covered in more detail in the companion paper and elsewhere, with the earlier functioning of the labor market (i.e., we do not want to mix the results from distinct equilibria of the teacher labor market, but would prefer to analyze the pre- and post-Act-10 markets separately). We drop all employees who are not full-time, full-year regular teachers of a major core subject (all-purpose elementary teachers or English/Math) at a single regular public school with a Bachelor's or Master's degree and fewer than 50 years' recorded experience; taken together, these restrictions eliminate `r round(100*abs(N_subset_I/N_full - 1))`% of employees, the lion's share of which come from eliminating substitutes/support staff and teachers non-core subjects[^position_code]. We then eliminate teachers with missing information on their subsequent school or district and teachers with instability in their recorded ethnicity, as well as teachers not categorized as white, black, or Hispanic, eliminating a further `r round(100*(N_subset_I - N_subset_II)/N_full, 1L)`% of all employees[^ethnicity]. Finally, we drop teachers' multiple positions by keeping only the highest-intensity position for each teacher, as measured by full-time equivalency, resulting in a final count of `r prettyNum(nrow(teachers), big.mark = ',')` teacher-year observations.

[^position_code]: We also eliminate any teacher who appears in any role besides "Teacher" in any year. In particular, this eliminates a nontrivial number of educators who either begin their career with an "ease-in" period or end it with a "soft retirement" period, during which they act as a substitute teacher before or after a career otherwise focused on teaching. Such teachers often have part-time roles at several local schools, which introduces sufficient ambiguity in the definition of mobility so as to obscure interpretation of results, so we opt for a stricter definition of full-time teaching than is completely necessary.
[^ethnicity]: Wisconsin teachers are predominantly white (`r pct_white`%).

This data is also used for the incorporation of counterfactual salary calculations, by incorporating the salary schedules estimated in the companion paper. Details of the fit procedure can be found there, but essentially salary schedules are computed as monotonicity- and concavity-constrained median-targeted splines [@ng] for each level of certification (Bachelor's or Master's degree) in each district in each year[^area_diff]. Data sparsity led this procedure to be unreliable in many cases, so ultimately around `r teachers[ , round(100*mean(is.na(schedule_lsalary)))]`% of teachers have missing salary information[^na_salary], mostly in rural districts or other districts with only one or two schools and a small number of students.

[^area_diff]: One difference is that the salaries included in the payscales estimation were less restrictive with respect to included subject areas. This was done since contracts are collectively bargained at the district level for all teachers, with scant mention of subject area in wage determination.

[^na_salary]: More specifically, we eliminate district-years featuring less than 20 teachers, less than 7 distinct levels of observed experience, or less than 5 unique values of the two measures of pay (salary and fringe benefits) in either degree track. HKR include like-minded restrictions, but combine teachers of different certification within an experience level.

We supplement the DPI teacher salary data set in several ways to incorporate data about other characteristics of schools and districts in Wisconsin. To get school- and district-level measures of socioeconomic makeup (percentage of students who are black or Hispanic or eligible for free/reduced lunches) and community type/urbanicity, we tap the Universe Surveys from the National Center for Education Statistics' Common Core of Data, which provide this information on a yearly basis for all years in the study[^urbanicity_details]. At the district level, we also use this data to compute class size and the size of the student body.

[^urbanicity_details]: The method of recording urbanicity by the Common Core switched from being "metropolitan-centric" to being "urban-centric" for Wisconsin from 2006 [@sable]. We map the codes corresponding codes to match those used by HKR as well as possible, and use the data file from 2006, which has both types of code for all US districts, to confirm that this correspondence is by and large working as intended. For a small number of districts/schools with missing urbanicity codes in certain years, we use information from other years to inform urbanicity.

Lastly, we turn to DPI's public data again to get school- and district-level performance metrics. While @hanushek were able to obtain school- and district-level average scale scores on a standardized test in Texas, such a metric is not publicly available in Wisconsin for all years. Instead, we calculate student proficiency rates for each school and district as the percentage of test-takers deemed to be at grade level in mathematics or reading in a given year on the Wisconsin Knowledge and Concepts Examination (WKCE), which is administered to 4th, 8th, and 10th-grade students.

# Results
```{r table_1_move_by_exp, results = 'asis', message = FALSE}
library(funchir)
T1 = rbind(
  teachers[ , .(`Remain in Same School` =
                  100*sum(!move_school_next & !quit_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 
                  100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ',')),
            keyby = .(`Teacher Experience` = exp_split)],
  teachers[ , .(`Teacher Experience` = 'All',
                `Remain in Same School` = 
                  100*sum(!move_school_next & !quit_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 
                  100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ','))])

n_retd = 
  5*round(T1[`Teacher Experience` == '>30 years'][[grep('Exit', names(T1))]]/5)

suppressWarnings(
  tbl <- capture.output(print(xtable(
    T1, caption =
      paste0('Year-to-year Transitions of Teachers by Experience, ',
             incl_rng[1L], '-', incl_rng[2L] %% 100), 
    label = 'tbl:move_by_exp', digits = 1L, 
    align = paste0('lp{.12\\linewidth}p{.14\\linewidth}',
                   'p{.17\\linewidth}p{.10\\linewidth}',
                   'p{.17\\linewidth}R{.13}')),
    sanitize.text.function = identity))
)
idx = grep('^Teacher', tbl) - 1L
tbl = c(tbl[1L:idx], 
        ' & \\multicolumn{4}{c}{Percent of Teachers Who} & \\\\ \\cline{2-5}',
        tbl[(idx + 1L):length(tbl)])
cat(tbl, sep = '\n')

quit_rates = teachers[, mean(quit_next), keyby = total_exp_floor]
new_quits = quit_rates[total_exp_floor == 1, V1]
mid_quits = quit_rates[total_exp_floor %between% c(10, 20), mean(V1)]
# code to produce plot of quits by experience level, with
#   bootstrapped confidence intervals:
# x = teachers[total_exp_floor <= 40]
# setkey(x, teacher_id)
# IDs = unique(x$teacher_id)
# 
# bs = rbindlist(replicate(5000, x[.(sample(IDs, replace = TRUE)), 
#                                  mean(quit_next),
#                                  keyby = total_exp_floor],
#                          simplify = FALSE))
# 
# Y = merge(x[, mean(quit_next), keyby = total_exp_floor],
#           bs[ , as.list(quantile(V1, c(.025, .975))), keyby = total_exp_floor],
#           by = 'total_exp_floor')
# Y[ , matplot(total_exp_floor, .SD[ , !"total_exp_floor"])]

# code to produce indicator for exogenous moves
#   induced by charter closures -- less than 200
#   such moves in total, and the source schools
#   are too small to have been fit with COBS,
#   so we salary effects can't be seen analogously
# library(readxl)
# closures = 
#   read_excel(paste0('/media/data_drive/wisconsin/charter_schools/',
#                     'charter_closures_report.xls'), skip = 2L, 
#              col_names = c('sch_year', 'cesa', 'district', 'authorizer',
#                            'school', 'school_name', 'grades_served',
#                            'year_closed', 'closure_reason'))
# setDT(closures)
# 
# closures = closures[!grepl('no longer charter status', closure_reason)]
# #this school appears to have lose its charter status,
# #  see correspondence with Latoya Holiday Apr. 21, 2017
# closures = closures[!(district == '3619' & school == '0419')]
# 
# closures[ , year := as.integer(gsub('^([0-9]{4}).*', '\\1', sch_year)) + 1L]
# 
# teachers[closures, exogenous_switch := TRUE,
#          on = c('year', district_fill = 'district', school_fill = 'school')]
```

Table \ref{tbl:move_by_exp} replicates Table 1 of @hanushek (HKR)[^cite_pkg], and as HKR found in Texas, most turnover in Wisconsin is happening within districts and out of the profession. In Wisconsin, the fraction of teachers transitioning among districts is vanishingly small after a "burn-in" period of roughly 6 years -- only `r round(100*teachers[total_exp_floor >= 7, mean(move_district_next)], 1)`% of such teachers do so (compared with `r round((4.5*75284 + 2.5*165873 + 0.7*6978)/(75284+165873+6978), 1)`% for the comparable group in HKR), but is still relatively higher among the youngest teachers -- roughly twice as high for the "probationary" teachers (1-3 years' experience) as for teachers with 7-11 years' experience in both states.

[^cite_pkg]: This and subsequent analyses were greatly facilitated by several facilities of the R programming language, for which due credit must be given to @r, @rstudio, @xie, @leifeld, @dahl, @henningsen, @zeileis2002, @zeileis2004, @zeileis2006 and @croissant.

By contrast, movement patterns within districts in the two states are very similar, lending weight to teachers "earning their stripes" within a district to be able to choose the best schools as a privilege of seniority. As expected, we also observe a U-shaped pattern in teachers exiting Wisconsin public schools, which jives with two types of quits. Early-career quitters who change to private schools, change state of residence, or change professions, and late-career quitters who retire -- this is epecially evident among teachers with more than 30 years' experience, a group which sees a mass exodus of fully `r n_retd` percent of its teachers annually. Results not included here break down the exit rates by experience level, where this dichotomy is even more dramatic -- first-year exit rates are about `r to.pct(new_quits, 0)` percent and quickly level off at around `r to.pct(mid_quits, 0)` percent before spiking again past around 25 years.

As examined further below, the low rate of switches between districts appears to be owing to the generally more rural nature of Wisconsin vis-à-vis. Texas. To wit, Milwaukee is the only major urban area in the state, and its population (2010 Census) of 594,833 would rank 7th in Texas. This means that two major types of movers in the HKR data -- Large Urban - Large Urban and Suburban - Large Urban -- are limited within the state to ending up in a relatively minor metropolitan area. HKR don't provide any results disaggregated by city, precluding any attempts to compare these numbers more comparably to those that would obtain from eliminating the largest cities in Texas.

```{r table_2_markov, results = 'asis'}
#** TO DO **
# - calculate distribution of distance moved between districts (esp. rural)
# - fix all table notes
share_change = 
  #use 2006, not incl_rng, because of the artificial change in 
  #  shares induced by the change in how urbanicity is calculated
  teachers[year %in% c(2000, 2006), .N, by = .(year, urbanicity_s)
           ][ , shr := N/sum(N), by = year
              ][order(year), .(delta = diff(shr)), by = urbanicity_s]
T2 = rbind(
  teachers[ , {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N,
           change_share = 
             share_change[.BY, sprintf('%.1f\\%%', 100*delta), 
                          on = 'urbanicity_s']))
  }, keyby = urbanicity_s],
  teachers[total_exp_floor <= 3, {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N))
  }, keyby = urbanicity_s],
  fill = TRUE)
total_urban_moves =
  teachers[urbanicity_s %in% c('Large Urban', 'Small Urban'), 
           sum(move_district_next)]
rural_rural = T2[urbanicity_s == 'Rural', Rural[1L]]
r_r_msg = if(rural_rural>60) '60%' else 'MAJOR DATA CHANGE FLAG'

setnames(T2, grep('[^y]_', names(T2)), character(3L))
T2[ , c('Origin Community', 'urbanicity_s') :=
      .(paste0('\\quad ', urbanicity_s), NULL)]
setcolorder(T2, c(ncol(T2), seq_len(ncol(T2) - 1L)))

tbl = capture.output(print(xtable(
  T2, caption = paste('Destination Community Type for Teachers',
                      'Changing Districts, by Origin Community',
                      'Type and Teacher Experience Level'),
  label = 'tbl:markov', digits = 1L, align = 'llrrrrrrr'),
  sanitize.text.function = identity, floating.environment = 'sidewaystable'))
idx = grep('^Origin', tbl)
mrow = function(x, n) paste0('\\multirow{', n, '}{*}{', x, '}')
mcol = function(x, n) paste0('\\multicolumn{', n, '}{c}{', x, '}')
pbox = function(x, p) paste0('\\parbox{', p, '\\linewidth}{', x, '}')
tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol(mrow('Percent of Teachers Who Move to', 2), 4),
                     mrow(pbox('Number Teachers Changing Districts', .09), 4),
                     mrow(pbox('Percent of Origin Teachers', .07), 4),
                     mrow(pbox('Change in Share of Teachers 2000-06', .09), 4), 
                     sep = ' & '), '\\\\'),
        ' & \\multicolumn{4}{c}{} & & & \\\\ \\cline{2-5}',
        '& & & & & & & \\\\', tbl[idx + 0L:1L],
        'I. All teachers & & & & & & & \\\\', tbl[idx + (2L:5L)], 
        '\\multicolumn{3}{l}{II. Probationary teachers ' %+% 
          '(1-3 years experience)}' %+%
          ' & & & & & \\\\', tbl[(idx+6L):length(tbl)])
cat(tbl, sep = '\n')

#What percent of teachers starting in Large Urban districts
#  ever work at a Suburban district?
pct_ever_go_suburban = 
  #similar if check Large Urban on first 3 schools
  teachers[order(year), if (urbanicity_d[1L] == 'Large Urban')
    urbanicity_d[-1L], by = teacher_id
    ][ , any(V1 == 'Suburban', na.rm = TRUE),
       by = teacher_id][ , mean(V1)]

suburban_new_hires = teachers[urbanicity_s == 'Suburban',
                              sum(total_exp_floor == 1L)]
mwk_net = 
  teachers[(move_district_next),
           sum(district_next == '3619') - 
             sum(district_fill == '3619')]
#Madison, Elmbrook, Waukesha, Waunakee, Oconomowoc
attractive = c('3269', '0714', '6174', '6181', '4060')
attr_net = 
    teachers[(move_district_next),
           sum(district_next %in% attractive) - 
             sum(district_fill %in% attractive)]
# Re: Hanushek comment "Urban teachers equally likely as suburban teachers
#   to remain in the same school", consult:
# teachers[grep('Urban', urbanicity_s), mean(stay_next & !move_within_next)]
# teachers[grep('Suburban', urbanicity_s), mean(stay_next & !move_within_next)]
# Re: Hanushek comment "Urban teachers ~ 10% more likely to quit", consult:
# teachers[grep('Urban', urbanicity_s), mean(quit_next)]
# teachers[grep('Suburban', urbanicity_s), mean(quit_next)]

# #most/least "attractive" districts (by net in/outflow)
# arr = 
#   teachers[(move_district_next & !grepl('^[79]', district_next)), 
#            .(arrivals = .N), keyby = district_next]
# dep = 
#   teachers[(move_district_next), .(exits = .N), by = district_fill]
# 
# arrdep = merge(arr, dep, by.x = 'district_next', by.y = 'district_fill', all = TRUE)
#       
# arrdep[is.na(arrivals), arrivals := 0]
# arrdep[is.na(exits), exits := 0]
# arrdep[ , net_flow := arrivals - exits]
```

Table \ref{tbl:markov} replicates HKR Table 2, and supports its most important conclusions. HKR argue that there is little support for the idea that scores of young teachers are using large urban schools as a training ground before "settling down" with easier assignments in the suburb, based on the general low level of turnover from Large Urban districts. We affirm the scarcity of transitions from districts in Milwaukee, while also noting that such a path is certainly present, as evidenced by the majority of those who do leave Large Urban districts ending up in a Surburban district in both settings. HKR also observe that the likelihoods of remaining in the same school and of quitting are roughly the same for urban and suburban teachers, an observation which we can confirm in Wisconsin. We further note that while Table \ref{tbl:markov} only presents a cross-sectional picture, the career-long trend reaffirms this -- only `r to.pct(pct_ever_go_suburban, 1L)`% of teachers starting their careers at a large urban district ever work at a suburban district. Lastly, we echo the suggestion of HKR that this phenomenon cannot be driven _per se_ by demand-side constraints -- in our time period of observation, we observe only `r prettyNum(total_urban_moves, big.mark = ',')` urban teachers change districts, whereas `r prettyNum(suburban_new_hires, big.mark = ',')` teachers were hired in suburban districts, though of course this does not rule out arguments based for example on stricter screening of applicants transferring from urban districts. 

We note, however, that though tales of flight from troubled urban districts is apparently anecdotal, it is far from apocryphal. To wit, while 50 percent of districts have a net inflow (arrivals less departures) of four or fewer teachers (in absolute value), Milwaukee's net outflow was `r abs(mwk_net)` teachers, and the five highest-inflow districts, all suburbs of Milwaukee or districts adjacent the main university town of Madison, saw in total an inflow of `r attr_net` teachers in this time. This being a two-sided market, this state of affairs is perhaps largely attributable to the dynamic nature of student populations at these districts -- but these, as well, are reflective of the appeal of the districts to parents (and teachers as parents).

```{r tx_wi_urb_dist, fig.cap = '\\label{fig:ti_wi_urb}Comparison of the Prevalence of Different Community Types'}
wi_ti[ , plot(table(State, `Community Type`), las = 1L,
              color = c('red', 'blue', 'darkgreen', 'lavender'),
              main = 'Urbanicity in Texas and Wisconsin, 2010')]
wi_pct_districts_nonurb = 
  wi_ti[State == 'Wisconsin', mean(`Community Type` %in% 
                              c('Rural', 'Suburban'), na.rm = TRUE)]
```


As mentioned in the discussion of Table \ref{tbl:move_by_exp}, the major difference with respect to quantities observed in Texas appears to be driven in differences in the urban landscape between Texas and Wisconsin[^share_shift]. This is supported by the overall similarity of magnitudes of transition rates to community types besides Large Urban in the two papers. Figure \ref{fig:ti_wi_urb} depicts this difference in landscape by comparing the distribution of community types in Texas and Wisconsin (bar widths reflect the relative quantity of districts in Texas and Wisconsin). While both states are majority-rural, the non-rural part of Texas is comparatively urbanized, whereas more than `r to.pct(wi_pct_districts_nonurb, -1)`% of Wisconsin districts are non-urban.

Returning to Table \ref{tbl:move_by_exp}, we see that, as in HKR, the "stickiest" community type is Rural -- over `r r_r_msg` of Rural teachers remain Rural in both papers, and even fewer Rural Wisconsin teachers end up in a big city than is the case for Texas. This may reflect the similarity in prevalence of rural districts in the two states. Lastly, we also find broad similarity in the community type transition patterns of younger teachers as compared to all teachers.

[^share_shift]: We also note a difference in the relative shift in population between the two states -- Texas observed dramatic changes in its community type distribution over the period of study of only 4 years, while Wisconsin only saw some movement from Rural to Suburban communities.

```{r table_3_change_by_ge, results = 'asis'}
#** TO DO **
# - subset to years with scale scores available, use this instead
#   Use aggregated distribution? Possible to construct
#     population moments from school-level data?
# - real wages?
# - explore _why_ differential wages become more important with experience;
#    : ignoring certification? breaking down results by
#      certification shows the patterns consistent, but _could_ in
#      principal be related to the residual wages themselves picking up
#      unexpected patterns by ignoring certification.
#    : plot distribution of change in wage vs. tenure
#      very weak evidence for influence of skew; nevertheless ever-so-slight
#      positive trend emerges w.r.t. experience
se = function(x) sd(x)/sqrt(length(x))
T3 = 
  teachers[move_district_next & total_exp_floor <= 10, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean), sapply(dl, se))))
  }, keyby = .(exp_split, gender)
  ][ , dcast(.SD, var ~ gender + exp_split, value.var = 'val')]
T3[ , all := 
      teachers[move_district_next & total_exp_floor <= 10, {
        dl = lapply(
          list(schedule_lsalary_next - schedule_lsalary_next_cf,
               schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
               pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
               pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
          na.omit)
        c(rbind(sapply(dl, mean), sapply(dl, se)))}]]

avg_premium = 
  teachers[(move_district_next), 
           mean(exp(schedule_lsalary_next) - 
                  exp(schedule_lsalary_next_cf), na.rm = TRUE)]

avg_premium_rel = 
  teachers[(move_district_next), 
           mean(exp(schedule_lsalary_next)/
                  exp(schedule_lsalary_next_cf), na.rm = TRUE)]

m_del_prem = diff(unlist(
  T3[var == '1M', grep('M.*(3|11)', names(T3)), with = FALSE]
))
f_del_prem = diff(unlist(
  T3[var == '1M', grep('F.*(3|11)', names(T3)), with = FALSE]
))
prem_trend_msg = if (m_del_prem < 0 || f_del_prem < 0) 
  'MAJOR DATA CHANGE FLAG' else ''

mid_career_premium = 
  teachers[move_district_next & total_exp_floor %between% c(4, 11),
           mean(schedule_lsalary_resid_next - 
                  schedule_lsalary_resid_next_cf, na.rm = TRUE)]

adj_wage_coef = T3[var == '2M', all]
prof_coefs = unlist(T3[var == '3M', !'var'])
prof_coefs_m = prof_coefs[grep('^M', names(prof_coefs))]
prof_coefs_f = prof_coefs[grep('^F', names(prof_coefs))]
pct_prof_coef = prof_coefs['all']
pct_prof_msg = if (any(prof_coefs_f < prof_coefs_m) ||
                   any(prof_coefs_m[1L] < prof_coefs_m[-1L]) ||
                   any(prof_coefs_f[1L] < prof_coefs_f[-1L]))
  'MAJOR DATA CHANGE FLAG' else ''
                   
pct_black_coef = T3[var == '5M', all]
pct_frl_coef = T3[var == '6M', all]

var_explained = 
  teachers[ , var(schedule_lsalary_pred, na.rm = TRUE)/
              var(schedule_lsalary, na.rm = TRUE)]
var_explained_msg = if (var_explained <= .7) 'MAJOR DATA CHANGE FLAG' else ''

T3[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3), c('var', 'type'))
sidx = T3$type == 's'
pidx = grepl('^Percent', T3$var)
T3[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3[type == 's', var := '']
T3[ , type := NULL]
setnames(T3, c('', rep(exp_lab[1L:3L], 2L), ''))

tbl = capture.output(print(xtable(
  T3, caption = paste('Average Change in Salary and District Student',
                      'Characteristics (and Standard Deviations) for',
                      'Teachers Changing Districts, by Gender and Experience'),
  label = 'tbl:change_by_ge', align = 'llccccccc'), 
  floating.environment = 'sidewaystable'))

idx = grep('years', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Men by Experience Class', 3L),
                     mcol('Women by Experience Class', 3L),
                     mrow(pbox('All Teachers 0-9 Years', .1), 2L),
                     sep = ' & '), '\\\\ \\cline{2-4} \\cline{5-7}'),
        tbl[idx:length(tbl)])

cat(tbl, sep = '\n')
# code to bootstrap adjusted salary SEs
# tids = teachers[ , unique(teacher_id)]
# boot_dist = rbindlist(lapply(integer(5000), function(...) {
#   DT = teachers[.(sample(tids, replace = TRUE))]
#   DS = payscales[district_fill %in% DT[ , unique(district_fill)]])
#   DS[ , lwage_resid := {
#     resid(lm(log(wage) ~ cesa + urbanicity + pct_prof + 
#                pct_black + pct_hisp + pct_frl))
#   }, by = .(highest_degree, tenure)]
#   DT[DS, schedule_lsalary_resid := i.lwage_resid,
#      on = c('year', 'district_fill', 
#             total_exp_floor = 'tenure', 'highest_degree')]
#   DT[order(year), schedule_lsalary_resid_next := 
#        shift(schedule_lsalary_resid, n = 1L, type = 'lead'), 
#      by = teacher_id]
#   DT[DS[ , .(year = year - 1L, district_fill, 
#              tenure = tenure - 1L, highest_degree, 
#              lwage, lwage_pred, lwage_resid)], 
#      schedule_lsalary_resid_next_cf := i.lwage_resid,
#      on = c('year', 'district_fill', 
#             total_exp_floor = 'tenure', 'highest_degree')]
#   DT[move_district_next & total_exp_floor <= 10,
#      mean(schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
#           na.rm = TRUE), keyby = .(exp_split, gender)]
# }), idcol = 'bb')
#with output:
# boot_dist[ , sd(V1), by = .(exp_split, gender)]
#     exp_split gender          V1
# 1:  1-3 years      M 0.005152039
# 2:  1-3 years      F 0.002977234
# 3:  4-6 years      M 0.006794788
# 4:  4-6 years      F 0.003923421
# 5: 7-11 years      M 0.007791188
# 6: 7-11 years      F 0.006181071

# code for distribution of Delta residual wage by experience
# teachers[move_district_next & total_exp_floor <= 10, {
#   boxplot(schedule_lsalary_resid_next - 
#             schedule_lsalary_resid_next_cf ~ total_exp_floor)
#   abline(h = 0, lty = 2)}]
```

Table \ref{tbl:change_by_ge} replicates Table 3 of HKR, and confirms its most important insights. Raw salary differentials predict teacher mobility, but the average pay differential is not on average very large -- only about `r dol.form(25*round(avg_premium/25), tex = TRUE)`, or `r to.pct(avg_premium_rel - 1, 1)`% higher than the counterfactually expected wage that would have obtained had the district-switching teacher remained in their current district. This premium `r prem_trend_msg`increases with age for both male and female teachers.

```{r potential_premium, fig.cap = '\\label{fig:premia}How Much Do Teachers Stand to Gain from Changing Districts throughout Their Careers?'}
payscales[ , {
  qs = quantile(wage, c(.1, .25, .4, .6, .75, .9))
  .(r9010 = qs['90%']/qs['10%'] - 1,
    r7525 = qs['75%']/qs['25%'] - 1,
    r6040 = qs['60%']/qs['40%'] - 1,
    d7525 = qs['75%'] - qs['25%'])
}, by = .(tenure, highest_degree)
][ , {
  avg_7525 <<- mean(r7525)
  #multiplying factor for discounting
  #  20 years at 10%
  dfact = (1-1.06^(-21))/(1-1.06^(-1))
  total_gain_ma <<- mean(d7525[highest_degree == 5]) * dfact
  dcast(.SD, tenure ~ highest_degree,
        value.var = c('r9010', 'r7525', 'r6040'))
}][ , {
  y = 100*.SD[ , !"tenure"]
  ba = grepl('_4$', names(y))
  par(oma = c(0, 0, 0, 3))
  matplot(tenure, y, lty = 1, type = 'l', lwd = 3,
          col = ifelse(ba, 'red', 'blue'), las = 1,
          ylim = c(0, 1.1*max(y)), xlab = 'Tenure',
          ylab = 'Available Wage Ratio',
          main = 'Potential Gains from Mobility')
  ys = unlist(y[.SD$tenure == 15, !ba, with = FALSE])
  text(15, ys, c('90-10 Ratio', '75-25 Ratio', '60-40 Ratio'),
       pos = 3L)
  usr = par('usr')[c(2L, 4L)]
  legend(usr[1L], usr[2L]/2, c('MA', 'BA'), lty = 1L,
         lwd = 3L, col = c('blue', 'red'), xpd = NA, 
         bty = 'n', yjust = .5)
}]
```

One potential explanation of the weakness of the wage results is that there simply is not sufficient heterogeneity among available contracts to generate mobility incentives. Figure \ref{fig:premia} demonstrates that this is not a likely explanation. No matter their current experience or certification level, a teacher in a district paying the 25th percentile of wages for that experience-certification cell would gain on average `r to.pct(avg_7525)`% by changing to a district at the 75th percentile. Especially for younger teachers, this potential gain would accumulate annually to become a hefty sum over the course of the career -- discounting the average annual gain for Master's-certified teachers at 6% and adding over 20 years, this is roughly `r dol.form(total_gain_ma, dig = -4, tex = TRUE)` on the table; results are more dramatic for teachers further in the tails of the wage distribution.

Attempting to isolate the influence of district characteristics on wage effects, HKR suggest comparing the differential leverage of residual wages to get a more focused estimate of the association between wages and mobility[^residual_ses]. We run a similar regression using the payscales estimated in the companion paper, but evaluate separate regressions not just for each level of experience, but also for each certification track. This leads to a boost in the overall fraction of explained variance from 60% cited by HKR to `r var_explained_msg``r to.pct(var_explained, 0)`% here; as in HKR, other included covariates are consistently significant, suggesting their strong independent correlation with salary levels.

[^residual_ses]: HKR mention they failed to adjust the standard errors associated with the adjusted wage differentials to account for the fact that they involve residuals from a regression. We explored accounting for this by bootstrapping the regression through resampling teachers and recalculating residuals, but confirm that little changes as a result.

Unlike HKR, we find the demographic-independent wage differentials to be no more important than the uncontrolled raw wages, with the predicted wage improvement amounting to `r to.pct(adj_wage_coef, 1L)`%. In further contrast to HKR, we find a positive relationship between experience and residual wage differentials, with mid-career district switchers experiencing roughly `r to.pct(mid_career_premium, 1)`% higher wages upon arrival to their new employer, by contrast to the null relationship for probationary teachers. This pattern is consistent across the dimension of certification which was ignored by HKR, suggesting the opposite result cannot be attributed to bias introduced by movement patterns of Bachelor's- vs. Master's-certified instructors.

Student demographic differentials are very important for predicting teacher turnover, a finding which held in Texas as it does in Wisconsin. Most distinguished in all experience classes and for both genders are changes in measures of student performance, student poverty and the percetnage of black students -- district switchers end up at schools with `r to.pct(pct_prof_coef, 0)`% more students at grade level overall, an effect which is `r pct_prof_msg`stronger for female teachers and for young teachers. They also end up on average with about `r to.pct(-pct_frl_coef, 0)`% fewer students (school-wide) eligible for subsidized lunch and `r to.pct(-pct_black_coef, 0)`% fewer black students. While this finding would need to be bolstered with experimental or quasi-experimental evidence, it hints at the potentially limited scope of teacher labor market policies intended to ameliorate teacher supply problems in hard-to-serve districts -- schools can much more easily exert influence over their compensation policies than they can dictate their student bodies, but the latter is more efficacious [see @fulbeck and @glazerman]. 

```{r table_3_long_distance, results = 'asis'}
T3D = 
  teachers[move_district_next & total_exp_floor <= 10 & distance_moved > 50, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean), sapply(dl, se))))
  }, keyby = .(exp_split, gender)
  ][ , dcast(.SD, var ~ gender + exp_split, value.var = 'val')]
T3D[ , all := 
       teachers[move_district_next & total_exp_floor <= 10 & distance_moved > 50, {
         dl = lapply(
           list(schedule_lsalary_next - schedule_lsalary_next_cf,
                schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
                pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
                pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
           na.omit)
         c(rbind(sapply(dl, mean), sapply(dl, se)))}]]
adj_wage_coef = T3D[var == '2M', all]

T3D[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                    'Percent proficient', 'Percent Hispanic',
                    'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3D[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3D), c('var', 'type'))
sidx = T3D$type == 's'
pidx = grepl('^Percent', T3D$var)
T3D[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3D[type == 's', var := '']
T3D[ , type := NULL]
setnames(T3D, c('', rep(exp_lab[1L:3L], 2L), ''))

tbl = capture.output(print(xtable(
  T3D, caption = paste('Average Change in Salary and District Student',
                       'Characteristics (and Standard Deviations) for',
                       'Teachers Changing to a district more than 50',
                       'Miles Away, by Gender and Experience'),
  label = 'tbl:change_far_by_ge', align = 'llccccccc'), 
  floating.environment = 'sidewaystable'))

idx = grep('years', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Men by Experience Class', 3L),
                     mcol('Women by Experience Class', 3L),
                     mrow(pbox('All Teachers 0-9 Years', .1), 2L),
                     sep = ' & '), '\\\\ \\cline{2-4} \\cline{5-7}'),
        tbl[idx:length(tbl)])

cat(tbl, sep = '\n')

# #t-test of difference vs. table 3 among the young
# teachers[exp_split == '1-3 years' & move_district_next,
#          t.test(I(schedule_lsalary_next -
#                     schedule_lsalary_next_cf) ~ I(distance_moved > 50)),
#          by = gender]
# teachers[exp_split == '1-3 years' & move_district_next & distance_moved > 50,
#          t.test(I(schedule_lsalary_next -
#                     schedule_lsalary_next_cf) ~ gender)]
# #scatterplot of distance vs. differential
# teachers[(move_district_next), {
#   ldist = log10(distance_moved)
#   wdiff = schedule_lsalary_next - schedule_lsalary_next_cf
#   plot(ldist, wdiff)
#   abline(lm(wdiff ~ ldist), col = 'red')
# }]
```

One major aspect of teacher mobility glossed over by HKR is geographic separation. A wide variety of frictions may be geospatially-related or -generated -- social and professional networks tend to be concentrated locally; there are typically substantial fixed costs involved in moving (real estate closing fees, moving expenses, etc.); preferences may depend on climate/geography; and so on. As a first pass at exploring how long-distance moves may differ in nature from those over short distances, we reproduce in Table \ref{tbl:change_far_by_ge} the analysis of Table \ref{tbl:change_by_ge} for only those where the distance between the origin and destination school exceeded 50 miles (a distance deemed sufficient to likely entail a physical move rather than simply an adjusted commute).

The preeminent distinction of long-distance moves is moderation -- all average demographic differentials moderate towards zero, suggesting a diminution of the importance of these aspects in this population. The noteworthy exception to this trend is among probationary teachers -- young males experience wage increases in an uprooting move, while young females experience further declines for long moves. More detailed data would be needed to explore the mechanism at work behind this observation (in particular, none of the differences -- male vs. female or short- vs. long-distance moves -- have $p$ values below .05), but one explanation is a higher willingness among bachelors to change scenery completely, while younger women may tend to be married and moving with their partners. In any case, the overall importance of wages in long-distance moves is close to zero, suggesting wage differentials are either of secondary or tertiary concern in the associated decision processes, or that there is unsufficient heterogeneity in wages at such distances to generate enough moves so motivated, though the case of young male teachers does weaken the latter explanation. 

```{r table_4_change_by_urb, results = 'asis'}
#** TO DO **
# - Why are teachers even worse off
#   in terms of adjusted than unadjusted pay?
# - How to express drop in %Black/Hispanic/FRL
#   RELATIVELY (i.e., accounting for the fact
#   that there are no minority/poor students outside MWK)
# - Compare within-urban differential in achievement
#   (require MWK charter schools back in data)
# - Use scale scores, not proficiency
# #Code to get nominal vs. residual pay differential for Urban-Suburban
# #  switchers, _by highest_degree_
# teachers[move_district_next & urbanicity_next_d == 'Suburban' &
#            urbanicity_d == 'Large Urban' & total_exp_floor <= 10, {
#              dl = lapply(
#                list(schedule_lsalary_next - schedule_lsalary_next_cf,
#                     schedule_lsalary_resid_next -
#                       schedule_lsalary_resid_next_cf),
#                na.omit)
#              .(var = c('1M', '1S', '2M', '2S'),
#                val = c(rbind(sapply(dl, mean), sapply(dl, se))))
#            }, keyby = .(urbanicity_d, highest_degree)]
T4D = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(schedule_lsalary_next - schedule_lsalary_next_cf,
                      schedule_lsalary_resid_next -
                        schedule_lsalary_resid_next_cf,
                      pct_prof_next_d - pct_prof_d, 
                      pct_hisp_next_d - pct_hisp_d,
                      pct_black_next_d - pct_black_d, 
                      pct_frl_next_d - pct_frl_d),
                 na.omit)
               .(var = paste0(rep(seq_len(6L), each = 2L),
                              rep(c('M', 'S'), 6L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

lose_msg = if (!all(T4D[var %in% c('1M', '2M')]$`Large Urban` < 0))
  'MAJOR DATA CHANGE FLAG' else ''
lose_resid_msg = 
  if (T4D[ , `Large Urban`[var == '1M'] > `Large Urban`[var == '2M']])
    'MAJOR DATA CHANGE FLAG' else ''
lose_degree_msg = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' &
             urbanicity_d == 'Large Urban' & total_exp_floor <= 10, {
               p_nom = t.test(I(schedule_lsalary_next - 
                                  schedule_lsalary_next_cf) ~ 
                                highest_degree)$p.value
               p_res = t.test(I(schedule_lsalary_resid_next - 
                                  schedule_lsalary_resid_next_cf) ~ 
                                highest_degree)$p.value
               if (p_nom < .1 || p_res < .1) 'MAJOR DATA CHANGE FLAG' else ''}]
         
pct_prof_coef_d = T4D[var == '3M', `Large Urban`]
pct_black_coef_d = T4D[var == '5M', `Large Urban`]
pct_frl_coef_d = T4D[var == '6M', `Large Urban`]

T4S = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s,
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s,
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = paste0(rep(3L:6L, each = 2L), rep(c('M', 'S'), 4L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

T4 = merge(T4D, T4S, by = 'var', all.x = TRUE)

T4[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T4[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T4), c('var', 'type'))
sidx = T4$type == 's'
pidx = grepl('^Percent', T4$var)
T4[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f\\%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f\\%%)', 100*x[pidx & sidx])
  o[is.na(x) & !sidx] = '---'
  o[is.na(x) & sidx] = ''
  o}), .SDcols = cols]
T4[type == 's', var := '']
T4[ , type := NULL]
T4[grepl('^Percent', var), var := paste('\\quad', var)]

suburban_black_msg10 = 
  if (districts[urbanicity == 'Suburban',
                mean(pct_black < .1, na.rm = TRUE) <= .85])
    'MAJOR DATA CHANGE FLAG' else ''
suburban_black_msg2 = 
  if (districts[urbanicity == 'Suburban',
                mean(pct_black < .02, na.rm = TRUE) <= .55])
    'MAJOR DATA CHANGE FLAG' else ''
pct_black_mwk = 
  districts[urbanicity == 'Large Urban',
            sum(n_students*pct_black, na.rm = TRUE)/
              sum(n_students, na.rm = TRUE)]
pct_frl_mwk = 
  districts[urbanicity == 'Large Urban',
            sum(n_students*pct_frl, na.rm = TRUE)/
              sum(n_students, na.rm = TRUE)]
pct_frl_suburb = 
  districts[urbanicity == 'Suburban',
           median(pct_frl, na.rm = TRUE)]

tbl = capture.output(print(xtable(
  T4, caption = paste('Average Change in Salary and in District and Campus',
                      'Student Characteristics (and Standard Deviations)',
                      'for Teachers with 1-10 Years of Experience Who',
                      'Change Districts, by Community Type of Origin',
                      'and Destination District'),
  label = 'tbl:change_by_urb', 
  align = paste0('llp{.135\\textwidth}p{.135\\textwidth}',
                 'p{.135\\textwidth}p{.135\\textwidth}')),
  sanitize.text.function = identity))

idx = grep('Urban', tbl) - 1L

tbl = c(tbl[1L:idx],
        paste0(paste(
          '', mcol(mrow(pbox('District Average Characteristics', .2), 2L), 2L),
          mcol(mrow(pbox('Campus Average Characteristics', .2), 2L), 2),
          sep = ' & '), '\\\\\n & & & & \\\\ \\cline{2-5}'),
        ' & Large Urban to Suburban & Suburban to Suburban & ' %+%
          'Large Urban to Suburban & Suburban to Suburban \\\\',
        tbl[(idx + 2L):length(tbl)])

idx = grep('quad', tbl)[1L] - 1L

tbl = c(tbl[1L:idx], 'Average Student Characteristics & & & & \\\\',
        tbl[(idx+1L):length(tbl)])

cat(tbl, sep = '\n')
```

Table \ref{tbl:change_by_urb}, which parallels Table 4 of HKR, again uncovers a labor market functioning similar to that in Texas. In particular, while HKR find Large Urban - Suburban district switchers penalize themselves in pay but are rewarded in demographic-adjusted pay, Wisconsin teachers `r lose_msg`lose out on both measures when leaving Large Urban districts, albeit the residual pay penalty is `r lose_resid_msg`much lower than that of nominal pay. This difference does not appear to be attributable to HKR's exclusion of certification as a conditioning variable, as the pattern here `r lose_degree_msg`differs insignificantly by degree.

The other results of HKR are confirmed in even more dramatic fashion. There is strong evidence of selection on the student performance metric, which does vary quite widely in suburban districts. Teachers leaving Milwaukee tend to end up at districts with `r to.pct(pct_prof_coef_d, 0)`% more students deemed to be at grade level on the state standardized test. On the other hand, teachers leaving Large Urban districts (i.e, Milwaukee) for the suburbs experience a precipitous drop of `r to.pct(-pct_black_coef_d, 0)`% black students and `r to.pct(-pct_frl_coef_d, 0)`% subsidized lunch eligibility. This is practically a tautological result, as the student demographics outside of urban areas in Wisconsin are pretty uniformly non-minority -- about `r suburban_black_msg10`90% of suburban districts have fewer than 10% black students, and about `r suburban_black_msg2`60% have fewer than 2% black students, whereas Milwaukee is about `r to.pct(pct_black_mwk, 0)`% black. Similarly, teachers leaving Milwaukee for the suburbs have little choice but to end up in a district with far fewer economically disadvantaged students -- whereas `r to.pct(pct_frl_mwk, 0)`% of Milwaukee students are eligible, the median percentage in suburban schools is `r to.pct(pct_frl_suburb, 0)`%. 

This phenomenon is reflected further in the suburban-to-suburban moves, which reflect little change in the ethnic/racial makeup of student bodies, since a dramatic shift would demonstrate very strong influence of this factor. We also find evidence of selection into economically better-off districts among suburban switchers, but the magnitude of this difference is attenuated with respect to that reported by HKR. We do not find patterns of selection on student performance as strongly as was found in HKR. This may be a reflection of the crudeness of the proficiency measure as compared to the more variable raw scale score measures used by HKR. Lastly, we confirm the finding of HKR that there does not appear to be evidence that teachers are able to select into the more desirable schools within their target districts -- The differences in campus-level characteristics are almost identical to the differences in district-level characteristics. This is likely a reflection of supply-side constraints, as the choicest appointments in a district may be awarded to long-serving serving teachers (promotion from within), as well as suburban districts perhaps having only a small number of schools at which to teach a given grade level/subject.

```{r table_5_change_by_eth, results = 'asis'}
# - to do: re-cast heterogeneity Q in terms
#   of white vs. non-white
# - do black teachers _start_ at lower-quality schools?
T5D = 
  teachers[move_district_next & total_exp_floor <= 10 & 
             ethnicity_main %in% c('Black', 'Hispanic'), {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L),
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

T5S = 
  teachers[move_within_next & total_exp_floor <= 10 & 
             ethnicity_main %in% c('Black', 'Hispanic'), {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L), 
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean),
                               sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

T5 = merge(T5D, T5S, by = 'var', all.x = TRUE)

T5[ , var := rep(c('Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch',
                   'Number of teachers'), c(2L, 2L, 2L, 2L, 1L))]
T5[ , type := c(rep(c('m', 's'), 4L), 'n')]
cols = setdiff(names(T5), c('var', 'type'))
sidx = T5$type == 's'
pidx = grepl('^Percent', T5$var)
nidx = T5$type == 'n'
T5[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o[nidx] = prettyNum(x[nidx], big.mark = ',')
  o}), .SDcols = cols]
T5[type == 's', var := '']
T5[ , type := NULL]

tbl = capture.output(print(xtable(
  T5, caption = paste('Average Change in District and Campus Student',
                      'Characteristics (and Standard Deviations)',
                      'for Black and Hispanic Teachers with 1-10',
                      'Years of Experience who Change Campuses'),
  label = 'tbl:change_by_eth', 
  align = paste0('llp{.1\\textwidth}p{.1\\textwidth}',
                 'p{.1\\textwidth}p{.1\\textwidth}'))))

idx = grep('Black.x', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Between District Moves', 2L),
                     mcol('Within District Moves', 2L),
                     sep = ' & '), '\\\\ \\cline{2-5}'),
        ' & Black Teachers & Hispanic Teachers & ' %+%
          'Black Teachers & Hispanic Teachers \\\\',
        tbl[(idx + 1L):length(tbl)])

cat(tbl, sep = '\n')
```

HKR examine the state of Texas, which features substantially more ethnic heterogeneity than does Wisconsin. As a result, they are better-equipped to identify heterogeneity in preferences by teacher ethnicity. Wisconsin, however, only has `r teachers[ethnicity_main %in% c('Black', 'Hispanic'), prettyNum(uniqueN(teacher_id), big.mark = ',')]` of its `r teachers[ , prettyNum(uniqueN(teacher_id), big.mark = ',')]` teachers non-white, so our results are underpowered relative to HKR. Table \ref{tbl:change_by_eth} presents these results, which parallel HKR Table 5. Given how few observations we have of black or Hispanic teachers switching districts, we eschew any temptation to interpret these results. Only black switchers within districts provide enough records to interpret meaningfully; in Wisconsin, we find (in contrast to white within-district switchers) black teachers tend to migrate to economically better-off and higher-performing schools (white teachers only tend to select on the latter characteristic). 

```{r table_6_change_by_quartile, results = 'asis'}
#** TO DO **
# - weight by SCHOOL not DISTRICT size (?)
# - HKR suggested they would have like to use
#   student body size for weighting instead of
#   teacher workforce size; investigate doing so
# - ? include residual salary rows for within-district
#   movers (should in principal all show up null, but
#   could reveal confounding effects that are likely
#   to be present elsewhere in the table -- use
#   as a motivation, or is it just distraction?)
# - Why do teachers in lowest-FRL districts move
#   more often than those in highest-FRL districts?
#   : teachers[pct_frl_d > 0, mean(move_district_next), 
#              keyby = .(cut(pct_frl_d, breaks = 0:20/20))
#              ][ , plot(1:19/20, V1)]
#     ^ just noise? ^
# - for Hanushek/Rivkin -- is Table 6 also restricted
#   to younger teachers??
# - how much is Milwaukee alone driving some of these results?
#    * idem Kenosha (erroneous year of data)
T6 = 
  melt(teachers, id.vars = c('year', 'move_district_next', 
                             'move_within_next', 'quit_next'), 
       measure.vars = paste0(q_var, '_q'), na.rm = TRUE, value.factor = TRUE
       )[ , .(`Probability Teachers Move to New School within District` = 
                mean(move_within_next),
              `Probability Teachers Move to New District` = 
                mean(move_district_next),
              `Probability Teachers Exit Public Schools` = 
                mean(quit_next)), 
          keyby = .(variable, value)]


resid_lo_hi_ratio = 
  T6[variable == 'lwage_resid_avg_q', {
    v = get(grep('New District', names(T6), 
                 value = TRUE, fixed = TRUE))
    v[value == 'Lowest']/v[value == 'Highest']}]
pct_prof_lo_hi_ratio = 
  T6[variable == 'pct_prof_q', {
    v = get(grep('Exit', names(T6),
                 value = TRUE, fixed = TRUE))
    v[value == 'Highest']/v[value == 'Lowest']}]
     
T6[variable == 'lwage_resid_avg_q', grep('within', names(T6)) := NA]
T6[ , variable := NULL]
cols = grep('^Prob', names(T6))
T6[ , (cols) := lapply(.SD, function(x) {
  o = sprintf('%.1f\\%%', 100*x)
  is.na(o) = is.na(x); o}), .SDcols = cols]
T6[ , value := paste0('\\quad ', value)]
setnames(T6, 'value', 'Quartile of Distribution')

tbl = capture.output(print(xtable(
  T6, caption = paste('School Average Transition Rates by Distribution of',
                      'Residual Teacher Salary and Student Demographic',
                      'Characteristics (data weighted by number of',
                      'teachers in school)'),
  label = 'tbl:change_by_quartile',
  align = 'lp{.3\\textwidth}p{.15\\textwidth}p{.15\\textwidth}p{.15\\textwidth}'), 
  sanitize.text.function = identity, NA.string = '---'))

idx = grep('Highest', tbl)
tbl[idx] = paste0(c('Residual salary', 'Percent proficient',
                    'Percent eligible for reduced-price lunch',
                    'Percent Black', 'Percent Hispanic'),
                  ' & & & \\\\\n', tbl[idx])
cat(tbl, sep = '\n')
```

To the end of examining heterogeneity in the impact of school and district characteristic differentials on teacher mobility, HKR present their Table 6, which breaks down the three exit rates for each (weighted) quartile of the covariate distribution. We replicate that analysis here in Table \ref{tbl:change_by_quartile}. Saliently, our results for the correlation of school characteristics for within-district movers are nearly identical to those found in Texas, which gives a stronger indication that we have identified some fundamental nonpecuniary mechanisms driving sorting among schools in a district.

Differences with respect to the results in Texas begin to emerge for the other destinations of school leavers (other districts and other professions). As noted in Table \ref{tbl:move_by_exp}, overall rates of switching districts are quite low compared to Texas and national averages; conditional on this, the patterns of movement by quartile of residual salary exhibit a similar pattern to that in Texas, with teachers in the lowest quartile about `r to.pct(resid_lo_hi_ratio - 1, 0)`% more likely to change districts than teachers in the highest residual pay quartile.  By contrast to HKR, however, who found the opposite association, we find the same trend (at attenuated magnitudes) with respect to leaving Wisconsin public schools, suggesting salary considerations are also important for teachers considering options outside of public school teaching (or in other states).

We also find fairly strong patterns in quitting associated with subsidized lunch eligibility and with the ethnic makeup of schools, with teachers at the most economically advantaged schools `r to.pct(1-pct_prof_lo_hi_ratio, 0)`% less likely to exit teaching; similar numbers obtain for both the quantity of black and of Hispanic students. For teachers moving within districts, however, we observe the opposite pattern, which is difficult to explain _prima facie_, and suggests the presence of confounding factors distorting the patterns away from what should be expected.

```{r table_7_reg_lpm, results = 'asis'}
#** TO DO **
# - don't use first-year base salary (HKR didn't
#   because they only estimated schedule for
#   experience 1 - 10, but run these regressions
#   for all experience classes)
# - why achievement no longer significant? being
#   picked up through reduced-price lunch?
# - check units of coefficients
# - missingness biasing results substantially?
# - HKR claim there's insufficient variation in
#   their data to separately identify gradients
#   in growth rate from base levels of growth;
#   explore whether that's possible here
# - HKR also claim to have checked robustness
#   to using 6th-year instead of 1st-year
#   as the base salary
# - HKR fit separate quadratic curves in 
#   experience for each experience class 
#   (almost surely leading to hard discontinuities
#    in the E[exit | tenure] curve) -- explore
#   this and explore fixing it.
reg_l = 
  lapply(split(teachers, f = teachers$exp_split, sorted = TRUE),
         function(DT) 
           DT[ , lm(leave_next ~
                      schedule_lbase_ba_salary*gender + 
                      pct_prof_d + pct_frl_d + 
                      ethnicity_main*pct_black_d + 
                      ethnicity_main*pct_hisp_d + factor(year) + 
                      urbanicity_d + total_exp_floor + 
                      I(total_exp_floor^2) + n_students_d + class_size_d)])

coefn = setNames(nm = names(coef(reg_l[[1L]])))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_d', 'pct_frl_d', 'pct_black_d', 'pct_hisp_d',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_d')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
SEs = lapply(reg_l, vcovHC, 'HC1')
se_vcov = function(x) sqrt(diag(x))
pvals = lapply(seq_along(reg_l), function(ii)
  coeftest(reg_l[[ii]], SEs[[ii]])[ , 'Pr(>|t|)']) 
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts, by Experience (linear',
                  'probability models; Huber-White standard ',
                  'errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), override.pvalues = pvals,
  reorder.coef = c(1, 6, 2:5, 7:10), override.se = lapply(SEs, se_vcov),
  include.rsquared = FALSE, include.adjrs = FALSE, 
  include.rmse = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])

idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)

#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

Having identified some key patterns in moments of the data, we now move on to try and separate the confounding effects of each of these and other factors in affecting teacher turnover with the aim of identifying more fundamentally the association between salient district and school characteristics on teacher turnover. Table \ref{tbl:reg_lpm} provides the main coefficients of interest from a simple linear probability regression model predicting leaving a district (i.e., either switching districts or exiting teaching); this corresponds to HKR Table 7. 

By contrast to the strength of such results implied in earlier results, the importance of student achievement has dwindled in the regression specification, and does not come out as independently significant for any subgroup. The same goes for base salary differentials -- in contrast to HKR, we find little evidence of an independent influence of salary on turnover rates, for males nor for female teachers[^class_size]. This does not appear to be due to imprecision -- the magnitude of HKR's standard errors follows closely those found for the Wisconsin data, despite our smaller sample sizes.

[^class_size]: HKR also mention results not printed in their paper suggesting a paucity of evidence suggesting class size is an important factor in teacher turnover decisions; we give tepid support to this statement, as class size does indeed appear to be related to turnover, but somewhat weakly and only for younger teachers.

HKR also found little independent evidence in favor of student economic status factoring in to teachers' mobility decisions, but in fact this is the source of our strongest effects. As mentioned above, it is possible that the crude nature of the proficiency measure is only weakly identified, and that some of the unaccounted for part of student performance is being captured in other coefficients, especially subsidized lunch eligibility. Even more compelling would be to associate student performance (and other school/district-level characteristics) more finely with the set of students actually faced by a given teacher.

The results in HKR about the differential effects of student body makeup are largely similar to those we find in Wisconsin. White and nonwhite teachers have opposite and significant correlations between the quantity of minority students in their origin district and their likelihood of leaving it. These results tend to modulate towards zero with experience, regardless of teacher or student race category, and suggest a degree of assortative matching on ethnicity among districts in Wisconsin (though the patterns for whites differ sharply from those of nonwhites, the patterns for black and Hispanic teachers are hard to distinguish).

```{r table_8_reg_lpm_fe, results = 'asis', cache = TRUE}
#** TO DO **
# - Do total future discounted pay totals lead to different
#   results?
# - What about using real wages?
reg_l = 
  lapply(split(teachers, f = teachers$exp_split, sorted = TRUE),
         function(DT) DT[ , lm(leave_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_d + pct_frl_d + 
                                 ethnicity_main*pct_black_d + 
                                 ethnicity_main*pct_hisp_d + factor(year) + 
                                 factor(district_fill) + total_exp_floor + 
                                 I(total_exp_floor^2) +
                                 n_students_d + class_size_d)])

#some districts are dropped by lm
#  (insufficient variation given low frequency of moves & other covariates)
coefn = setNames(nm = Reduce(union, lapply(reg_l, function(x) names(coef(x)))))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_d', 'pct_frl_d', 'pct_black_d', 'pct_hisp_d',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_d')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
SEs = lapply(reg_l, vcovHC, 'HC1')
pvals = lapply(seq_along(reg_l), function(ii)
  coeftest(reg_l[[ii]], SEs[[ii]])[ , 'Pr(>|t|)']) 
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm_fe', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts with District Fixed',
                  'Effects, by Experience (linear probability models;',
                  'Huber-White standard errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), override.pvalues = pvals,
  reorder.coef = c(1, 6, 2:5, 7:10), override.se = lapply(SEs, se_vcov),
  include.rsquared = FALSE, include.adjrs = FALSE, 
  include.rmse = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])
idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

To account in a rudimentary way for district-specific hiring policies, HKR move on to their Table 8 which repeats Table 7 with district fixed effects. HKR note that the patterns in responsiveness to wages are the same, though attenuated; that coefficients involving student ethnicity are qualitatively unaffected; and that schools with high achievement continue to exhibit lower propensities for turnover. Our results, presented in Table \ref{tbl:reg_lpm_fe}, are similar in that they closely resemble the results without fixed effects, but with noted attenuation and weaker precision.

The most notable difference relative to table \ref{tbl:reg_lpm} is the weakening of results regarding the importance of student characteristics for white teachers. While partially attributable to a decline in precision, this adjustment suggests much of the discovered correlation between student characteristics and exit probability for white teachers can be chalked up to district-to-district heterogeneity in preferences or hiring policies.

```{r table_9, results = 'asis', cache = TRUE}
##** TO DO**
# - Estimate marginal effects for men/women
#   of a 10% salary increase (also with
#   confidence intervals?) & compare to HKR
# - Why did changing definition of move_district_next
#   change the #s for nonwhites so we can't fit anymore?
teachersML = 
  melt(teachers[total_exp_floor <= 30], id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_d', 'pct_frl_d', 'urbanicity_d',
           'nonwhite', 'pct_nonwhite_d',
           'total_exp_floor', 'n_students_d', 'class_size_d','exp_split'), 
       measure.vars = c('stay_next', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)
teachersML[ , exp_split := droplevels(exp_split)]

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

mnl_l = 
  lapply(split(teachersML, f = teachersML$exp_split, sorted = TRUE), function(DT) {
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_d + pct_frl_d + 
             nonwhite*pct_nonwhite_d +  factor(year) + 
             urbanicity_d + total_exp_floor + I(total_exp_floor^2) + 
             n_students_d + class_size_d, data = DT)
  })

coefn = setNames(nm = names(coef(mnl_l[[1L]])))
coefn[seq_len(length(coefn))] = 'x'
idx = match(
  paste0(rep(c('move_district_next:', 'quit_next:'), each = 6L),
         rep(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
               'pct_prof_d', 'pct_frl_d', 'pct_nonwhite_d',
               'nonwhiteTRUE:pct_nonwhite_d'), 2L)), 
  names(coefn)
)
coefn[idx] = 
  rep(c('First year base salary (log)', 
        'First year base salary (log) * female', 'Percent proficient', 
        'Percent eligible for subsidized lunch', 'Percent Nonwhite',
        'Nonwhite * percent Nonwhite'), 2L)
mnl_l = lapply(mnl_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})

tbl = capture.output(texreg(
  mnl_l, label = 'tbl:reg_mlogit', omit.coef = '^x',
  caption = paste('Multinomial Logit Estimated Effects of Teacher',
                  'Salary and Student Demographic Characteristics',
                  'on the Probabilities That Teachers Switch',
                  'School Districts or Exit Teaching Relative to',
                  'Remaining in Same District'),
  reorder.coef = c(1, 9, 3, 5, 7, 11, 2, 10, 4, 6, 8, 12),
  groups = list('I. Switch Districts' = 1:6, 'II. Exit Teaching' = 7:12),
  include.aic = FALSE, include.loglik = FALSE,
  include.nobs = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-5}',
        tbl[idx:length(tbl)])
tbl = gsub('\\([12]\\)', '', tbl)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

Finally, the conflation of switching districts and exiting teaching may mask important heterogeneity between these two choices. To separate these competing exit risks, HKR construct Table 9, which gives coefficients from a multinomial logit model with three choices -- remain in district, switch districts, and exit teaching. We repeat that analysis here, with the caveat that, given the sparsity in racial variation present among Wisconsin teachers, we are unable to identify the full model specified by HKR and mirrored above in Tables \ref{tbl:reg_lpm} and \ref{tbl:reg_lpm_fe}. In light of this, and in light of the apparent similarity in Wisconsin in the behavior of black and Hispanic teachers described above, we specify the multinomial logit model in terms of a more parsimonious coefficient set. Namely, we distinguish between white and nonwhite teachers and white and nonwhite students (instead of among white, black, and Hispanic students and teachers).

We continue to see little evidence favoring the salience of wage considerations for Wisconsin teachers; the strongest suggestions found here point to the importance of wages for older male teachers in exiting teaching, a result which is generally opposed to that found by HKR in Texas, where salaries were generally important, but only for the propensity to change districts. Also as in the regression specifications, the prominence of student proficiency found by HKR fails to make a notable appearance in Wisconsin.

With respect to the importance of student demographics, our results again point to the same effects found in Texas. White teachers seem to be spurred to change districts or exit teaching by highly black student populations; the reverse is true of nonwhite teachers, who can be drawn to remain in high-minority districts. Subsidized lunch eligibility's strong effect observed in the combined specification is found here to be concentrated more among those leaving teaching than those changing districts.

# Conclusion

That salary incentives appear to play such a limited role in driving teacher churn is bound at first glance to be a disappointment for policymakers. The most powerful predictors of turnover in educators in Wisconsin are all basically beyond the control of administrators, who have no readily-manipulated direct lever for assigning students to schools[^gerrymandering]. HKR found school quality (as measured by average standardized test performance) to be of key importance for attracting/retaining teachers, but we found no evidence that student proficiency (as measured by attainment levels on standardized tests) is a factor in the turnover decision for Wisconsin teachers. Regardless, manipulating school performance is famously difficult[^cheating], and is in fact the original goal administrators often have in mind when they turn to labor market policies in the first place, so that telling administrators they can improve teacher retention by improving student performance amounts essentially to circular reasoning.

[^cheating]: See, for example, the widespread cheating scandals on standardized tests by teachers in Chicago [@jacob], Atlanta, and Philadelphia as an example of the lengths professionals feel they need to go to effect change in testing outcomes.

[^gerrymandering]: There is evidence [e.g., @richards] that catchment area manipulation (educational gerrymandering) is being used by some schools to select their student populations, but the equilibrium outcome of the strategic interactions of districts competing for the most "desirable" students is far from clear.

The upside is that this paper is far from settling the debate about welfare-maximizing teacher turnover policies. Limitations in our data prevent us from associating to teachers anything but crude measures of their productivity; measures such as experience, certification, and race are famously poor predictors of teacher quality measures such as value-added. We are thus unable to provide any input to the question of whether _high-quality_ teachers have patterns of mobility which resemble that of the teaching population as a whole, or whether heterogeneity in their preferences can be used to devise appropriate policies.

# References
