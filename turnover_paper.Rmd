---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "March 17, 2017"
output:
  pdf_document:
    keep_tex: yes
header-includes:
  - \usepackage{theapa}
  - \usepackage{array}
  - \usepackage{multirow}
  - \newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1\linewidth}}
  - \usepackage{longtable}
abstract: 'Turnover in Wisconsin'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
knitr::read_chunk('turnover_data_cleaner.R')
```

```{r start_read, cache = TRUE, include = FALSE}
```

# Introduction

# Data

# Results

```{r table_1}
library(xtable)
T1 = rbind(
  teachers[ , .(`Remain in Same School` = 100*sum(!move_school_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit WI \mbox{Public Schools}` = 100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ',')),
            keyby = .(`Teacher Experience` = exp_split)],
  teachers[ , .(`Teacher Experience` = 'All',
                `Remain in Same School` = 100*sum(!move_school_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit WI \mbox{Public Schools}` = 100*sum(quit_next)/.N,
                `Number of Teachers` = prettyNum(.N, big.mark = ','))])
tbl = capture.output(print(xtable(
  T1, caption = 'Year-to-year Transitions of Teachers by Experience, 2000-08', 
  label = 'tbl:move_by_exp', digits = 1L, 
  align = paste0('lp{.14\\linewidth}p{.16\\linewidth}',
                 'p{.2\\linewidth}p{.14\\linewidth}p{.19\\linewidth}R{.16}')),
  include.rownames = FALSE))
idx = grep('^Teacher', tbl) - 1L
tbl = c(tbl[1L:idx], 
        ' & \\multicolumn{4}{c}{Percent of Teachers Who} & \\\\ \\cline{2-5}',
        tbl[(idx+1L):length(tbl)])
cat(tbl, sep = '\n')
```

```{r table_2}
share_change = 
  #use 2006, not incl_rng, because of the artificial change in 
  #  shares induced by the change in how urbanicity is calculated
  teachers[year %in% c(2000, 2006), .N, by = .(year, urbanicity_s)
           ][ , shr := N/sum(N), by = year
              ][order(year), .(delta = diff(shr)), by = urbanicity_s]
T2 = rbind(
  teachers[ , {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N,
           change_share = 
             share_change[.BY, sprintf('%.1f%%', 100*delta), on = 'urbanicity_s']))
  }, keyby = urbanicity_s],
  teachers[total_exp_floor <= 3, {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = prettyNum(N_move, big.mark = ','), 
           pct_origin = 100*N_move/.N))
  }, keyby = urbanicity_s],
  fill = TRUE)

setnames(T2, grep('[^y]_', names(T2)), character(3L))
T2[ , c('Origin Community', 'urbanicity_s') :=
      .(paste0('\\quad ', urbanicity_s), NULL)]
setcolorder(T2, c(ncol(T2), seq_len(ncol(T2) - 1L)))

tbl = capture.output(print(xtable(
  T2, caption = paste('Destination Community Type for Teachers',
                      'Changing Districts, by Origin Community',
                      'Type and Teacher Experience Level'),
  label = 'tbl:markov', digits = 1L, align = 'llrrrrrrr'),
  include.rownames = FALSE, sanitize.text.function = identity,
  floating.environment = 'longtable'))
idx = grep('^Origin', tbl)
mrow = function(x, n) paste0('\\multirow{', n, '}{*}{', x, '}')
mcol = function(x, n) paste0('\\multicolumn{', n, '}{c}{', x, '}')
pbox = function(x, p) paste0('\\parbox{', p, '\\linewidth}{', x, '}')
tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol(mrow('Percent of Teachers Who Move to', 2), 4),
                     mrow(pbox('Number Teachers Changing Districts', .13), 4),
                     mrow(pbox('Percent of Origin Teachers', .12), 4),
                     mrow(pbox('Change in Share of Teachers 2000-06', .16), 4), 
                     sep = ' & '), '\\\\'),
        ' & \\multicolumn{4}{c}{} & & & \\\\ \\cline{2-5}',
        '& & & & & & & \\\\', tbl[idx + 0L:1L],
        'I. All teachers & & & & & & & \\\\', tbl[idx + (2L:5L)], 
        '\\multicolumn{3}{l}{II. Probationary teachers ' %+% 
          '(1-3 years experience)}' %+%
          ' & & & & & \\\\', tbl[(idx+6L):length(tbl)])
cat(tbl, sep = '\n')
```

```{r table_3}
T3M = 
  teachers[move_district_next & total_exp_floor <= 10, 
           .(d_lsalary = 
               mean(schedule_lsalary_next - 
                      schedule_lsalary_next_cf, na.rm = TRUE), 
             d_lsalary_resid = 
               mean(schedule_lsalary_resid_next - 
                      schedule_lsalary_resid_next_cf, na.rm = TRUE),
             d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
             d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
             d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
             d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
           keyby = .(exp_split, gender)
           ][ , melt(.SD, measure.vars = patterns('^d_'))
              ][ , dcast(.SD, variable ~ gender + exp_split, value.var = 'value')]
T3M[ , all := 
       teachers[move_district_next & total_exp_floor <= 10, 
                c(mean(schedule_lsalary_next - 
                         schedule_lsalary_next_cf, na.rm = TRUE),
                  mean(schedule_lsalary_resid_next - 
                         schedule_lsalary_resid_next_cf, na.rm = TRUE),
                  mean(pct_prof_next - pct_prof, na.rm = TRUE),
                  mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
                  mean(pct_black_next - pct_black, na.rm = TRUE),
                  mean(pct_frl_next - pct_frl, na.rm = TRUE))]]

T3S = 
  teachers[move_district_next & total_exp_floor <= 10, 
           .(d_lsalary = 
               sd(schedule_lsalary_next - 
                      schedule_lsalary_next_cf, na.rm = TRUE), 
             d_lsalary_resid = 
               sd(schedule_lsalary_resid_next - 
                      schedule_lsalary_resid_next_cf, na.rm = TRUE),
             d_pct_prof = sd(pct_prof_next - pct_prof, na.rm = TRUE),
             d_pct_hisp = sd(pct_hisp_next - pct_hisp, na.rm = TRUE),
             d_pct_black = sd(pct_black_next - pct_black, na.rm = TRUE),
             d_pct_frl = sd(pct_frl_next - pct_frl, na.rm = TRUE)),
           keyby = .(exp_split, gender)
           ][ , melt(.SD, measure.vars = patterns('^d_'))
              ][ , dcast(.SD, variable ~ gender + exp_split, value.var = 'value')]
T3S[ , all := 
       teachers[move_district_next & total_exp_floor <= 10, 
                c(sd(schedule_lsalary_next - 
                       schedule_lsalary_next_cf, na.rm = TRUE),
                  sd(schedule_lsalary_resid_next - 
                       schedule_lsalary_resid_next_cf, na.rm = TRUE),
                  sd(pct_prof_next - pct_prof, na.rm = TRUE),
                  sd(pct_hisp_next - pct_hisp, na.rm = TRUE),
                  sd(pct_black_next - pct_black, na.rm = TRUE),
                  sd(pct_frl_next - pct_frl, na.rm = TRUE))]]
T3S[ , variable := '']

T3 = rbind(T3M, T3S, idcol = TRUE)[order(rowid(.id))][ , .id := NULL]
rename = 
  data.table(variable = 
               paste0('d_', c('lsalary', 'lsalary_resid', 'pct_prof',
                              'pct_hisp', 'pct_black', 'pct_frl')),
             formal = c('Base year salary (log)', 'Adjusted salary (log)',
                        'Percent proficient', 'Percent Hispanic',
                        'Percent black', 'Percent subsidized lunch'))
T3[rename, variable := i.formal, on = 'variable']
setnames(T3, c('', rep(exp_lab[-4L], 2L), ''))

tbl = capture.output(print(xtable(
  T3, caption = paste('Average Change in Salary and District Student',
                      'Characteristics (and Standard Deviations) for',
                      'Teachers Changing Districts, by Gender and Experience'),
  label = 'tbl:avg_d_cov'), include.rownames = FALSE, floating.environment = 'longtable'))

cat(tbl, sep = '\n')
```

```{r table_4}
teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_lsalary = 
             mean(schedule_lsalary_next - 
                    schedule_lsalary_next_cf, na.rm = TRUE), 
           d_lsalary_resid = 
             mean(schedule_lsalary_resid_next - 
                    schedule_lsalary_resid_next_cf, na.rm = TRUE),
           d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]

teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_pct_prof_s = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp_s = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black_s = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl_s = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]
```

```{r table_5}
teachers[move_district_next & total_exp_floor <= 10 & 
           ethnicity_main %in% c('Black', 'Hispanic'),
         .(d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE), N = .N),
         keyby = ethnicity_main
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity_main, value.var = 'value')]

teachers[move_within_next & total_exp_floor <= 10 &
           ethnicity_main %in% c('Black', 'Hispanic'),
         .(d_pct_prof = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE), N = .N),
         keyby = ethnicity_main
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity_main, value.var = 'value')]
```

```{r table_6}
melt(teachers, id.vars = c('year', 'move_district_next', 
                           'move_school_next', 'quit_next'), 
     measure.vars = paste0(q_var, '_q'), na.rm = TRUE,
     variable.name = 'Quartile of Distribution', value.name = 'quartile'
     )[ , .(`Probability Teachers Move to New School within District` = 
              mean(move_within_next),
            `Probability Teachers Move to New District` = 
              mean(move_district_next),
            `Probability Teachers Exit Public Schools` = 
              mean(quit_next)), 
        keyby = .(`Quartile of Distribution`, quartile)]
```

```{r table_7}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 urbanicity_s + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l)
```

```{r table_8}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 factor(district_fill) + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l, omit.coef = '^factor')
```

```{r table_9}
library(mlogit)
teachersML = 
  melt(teachers, id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_s', 'pct_frl_s', 'urbanicity_s',
           'ethnicity_main', 'pct_black_s', 'pct_hisp_s',
           'total_exp_floor', 'n_students', 'class_size','exp_split'), 
       measure.vars = c('stay_next', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

mnl_l = 
  lapply(split(teachersML, by = 'exp_split', sorted = TRUE), function(DT) {
    print(head(DT))
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_s + pct_frl_s + 
             ethnicity_main*pct_black_s + ethnicity_main*pct_hisp_s + 
             #need to include dummy for year, but solution fails
             urbanicity_s + total_exp_floor + 
             I(total_exp_floor^2) + n_students + class_size, data = DT)
  })
texreg(mnl_l)
```

# Conclusion

# References
