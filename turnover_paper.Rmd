---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "March 17, 2017"
output:
  pdf_document:
    keep_tex: yes
header-includes:
  - \usepackage{theapa}
abstract: 'Turnover in Wisconsin'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide')
```

```{r data_import, include = FALSE}
library(data.table)
library(Hmisc)
library(funchir)
library(texreg)
library(mlogit)

wds = c(data = '/media/data_drive/wisconsin/')

colClasses = fread(wds['data'] %+% 
                     'wisconsin_teacher_data_matched_colClass.csv',
                   header = FALSE)
teachers = fread(wds['data'] %+% 'wisconsin_teacher_data_matched.csv',
                 colClasses = colClasses$V2)

incl_yrs = 2000:2008
incl_rng = range(incl_yrs)
teachers = teachers[year %between% incl_rng & highest_degree %in% 4:5]

teachers = 
  unique(teachers[order(-full_time_equiv)], by = c('teacher_id', 'year'))

teachers[is.na(move_school_next), move_school_next := FALSE]
teachers[is.na(move_district_next), move_district_next := FALSE]

schools = fread(wds['data'] %+% 'school_demographics.csv',
                colClasses = list(character = c('district', 'school')), 
                na.strings = '')
schools[ , urbanicity := 
           factor(urbanicity, levels = 
                    c('Large Urban', 'Small Urban', 'Suburban', 'Rural'))]
teachers[schools, urbanicity_s := i.urbanicity, 
         on = c('district', 'school', 'year')]
teachers[schools, urbanicity_s_next := i.urbanicity, 
         on = c(district_next_main = 'district', 
                school_next_main = 'school', 'year')]

payscales = fread(wds['data'] %+% 'wisconsin_salary_scales_imputed.csv',
                  colClasses = list(character = 'district_fill'))
payscales = payscales[year %between% incl_rng]
districts = fread(wds['data'] %+% 'district_demographics.csv',
                  colClasses = list(character = 'district'))
payscales[districts, `:=`(n_students = i.n_students, pct_hisp = pct_hisp,
                          pct_black = pct_black, pct_frl = pct_frl,
                          pct_prof = (n_prof + n_advn)/n_tested,
                          urbanicity = urbanicity),
          on = c(district_fill = 'district', 'year')]
#confirmed: 1-1 mapping b/w district & cesa (even across years)
cesa_map = unique(teachers[ , .(district_fill, cesa)])
payscales[cesa_map, cesa := cesa, on = 'district_fill']
payscales[ , lwage_ba_resid := 
             resid(lm(log(wage_ba) ~ cesa + urbanicity + scale(pct_prof) + 
                        pct_black + pct_hisp + pct_frl, 
                      na.action = na.exclude)),
           by = tenure]
payscales[ , lwage_ma_resid := 
             resid(lm(log(wage_ma) ~ cesa + urbanicity + scale(pct_prof) + 
                        pct_black + pct_hisp + pct_frl, 
                      na.action = na.exclude)),
           by = tenure]

teachers[order(year), salary_next := 
           shift(salary, n = 1, type = 'lead'), by = teacher_id]
teachers[melt(payscales, id.vars = c('year', 'district_fill', 'tenure'),
              measure.vars = c('wage_ba', 'wage_ma')
              )[ , highest_degree := 4L + (variable == 'wage_ma')], 
         schedule_lsalary := log(i.value),
         on = c('year', 'district_fill', 
                total_exp_floor = 'tenure', 'highest_degree')]
teachers[order(year), schedule_lsalary_next := 
           shift(schedule_lsalary, n = 1, type = 'lead'), by = teacher_id]

teachers[melt(payscales, id.vars = c('year', 'district_fill', 'tenure'),
              measure.vars = c('lwage_ba_resid', 'lwage_ma_resid')
              )[ , highest_degree := 4L + (variable == 'lwage_ma_resid')], 
         schedule_lsalary_resid := i.value,
         on = c('year', 'district_fill', 
                total_exp_floor = 'tenure', 'highest_degree')]
teachers[order(year), schedule_lsalary_resid_next := 
           shift(schedule_lsalary_resid, n = 1, type = 'lead'), 
         by = teacher_id]

teachers[melt(payscales, id.vars = c('year', 'district_fill', 'tenure'),
              measure.vars = c('wage_ba', 'wage_ma')
              )[ , c('highest_degree', 'tenure') := 
                   #increment tenure to get counterfactual subsequent wage
                   #  by matching, e.g, experience 4 to 
                   #  experience 5 in the table
                   .(4L + (variable == 'wage_ma'), tenure + 1L)], 
         schedule_lsalary_next_cf := log(i.value),
         on = c('year', 'district_fill', 
                total_exp_floor = 'tenure', 'highest_degree')]

teachers[melt(payscales, id.vars = c('year', 'district_fill', 'tenure'),
              measure.vars = c('lwage_ba_resid', 'lwage_ma_resid')
              )[ , c('highest_degree', 'tenure') := 
                   .(4L + (variable == 'lwage_ma_resid'), tenure + 1L)], 
         schedule_lsalary_resid_next_cf := i.value,
         on = c('year', 'district_fill', 
                total_exp_floor = 'tenure', 'highest_degree')]

teachers[districts, 
         `:=`(pct_prof = (i.n_prof + i.n_advn)/i.n_tested, 
              pct_hisp = i.pct_hisp, pct_black = i.pct_black, 
              pct_frl = i.pct_frl, urbanicity_d = i.urbanicity), 
         on = c('year', district_fill = 'district')]

teachers[districts, 
         `:=`(pct_prof_next = (i.n_prof + i.n_advn)/i.n_tested, 
              pct_hisp_next = i.pct_hisp, pct_black_next = i.pct_black, 
              pct_frl_next = i.pct_frl, urbanicity_d_next = urbanicity), 
         on = c('year', district_next_main = 'district')]

teachers[schools, 
         `:=`(pct_prof_s = (i.n_prof + i.n_advn)/i.n_tested, 
              pct_hisp_s = i.pct_hisp, pct_black_s = i.pct_black, 
              pct_frl_s = i.pct_frl), 
         on = c('year', district_fill = 'district', school_fill = 'school')]

teachers[schools, 
         `:=`(pct_prof_next_s = (i.n_prof + i.n_advn)/i.n_tested, 
              pct_hisp_next_s = i.pct_hisp, pct_black_next_s = i.pct_black, 
              pct_frl_next_s = i.pct_frl), 
         on = c('year', district_next_main = 'district',
                school_next_main = 'school')]
```


# Introduction

# Data

# Results

```{r table_1}
teachers[ , .(`Remain in Same School` = sum(!move_school_next, na.rm = TRUE)/.N,
              `Change Schools Within District` = 
                sum(move_school_next & !move_district_next, na.rm = TRUE)/.N,
              `Switch Districts` = sum(move_district_next, na.rm = TRUE)/.N,
              `Exit Wisconsin Public School` = sum(quit_next, na.rm = TRUE)/.N,
              `Number of Teachers` = .N),
          keyby = .(`Teacher Experience` = {
            f = factor(total_exp_floor)
            levels(f) = list(`0-2 years` = 1:3,
                             `3-5 years` = 4:6,
                             `6-10 years` = 7:11,
                             `11-30 years` = 12:30)
            f})]
#table 1b
teachers[ , .(`Teacher Experience` = 'All',
              `Remain in Same School` = sum(!move_school_next, na.rm = TRUE)/.N,
              `Change Schools Within District` = 
                sum(move_school_next & !move_district_next, na.rm = TRUE)/.N,
              `Switch Districts` = sum(move_district_next, na.rm = TRUE)/.N,
              `Exit Wisconsin Public School` = sum(quit_next, na.rm = TRUE)/.N,
              `Number of Teachers` = .N)]
```

```{r table_2}
#table 2a
## to do: WTF is going on with missing urbanicity, in particular in WI
teachers[(move_district_next & !is.na(urbanicity_s)), 
         c(as.list(table2(urbanicity_s_next, prop = TRUE)),
           list(`# Changing Districts` = .N, 
                `% of origin teachers` =
                  .N/teachers[!is.na(urbanicity_s)
                              ][.BY, .N, on = 'urbanicity_s'])),
         keyby = urbanicity_s]

#table 2b
teachers[(move_district_next & !is.na(urbanicity_s) & total_exp_floor < 3), 
         c(as.list(table2(urbanicity_s_next, prop = TRUE)),
           list(`# Changing Districts` = .N, 
                `% of origin teachers` =
                  .N/teachers[!is.na(urbanicity_s) & total_exp_floor < 3
                              ][.BY, .N, on = 'urbanicity_s'])),
         keyby = urbanicity_s]
```

```{r table_3}
teachers[move_district_next & total_exp_floor <= 10, 
         .(d_lsalary = 
             mean(schedule_lsalary_next - 
                    schedule_lsalary_next_cf, na.rm = TRUE), 
           d_lsalary_resid = 
             mean(schedule_lsalary_resid_next - 
                    schedule_lsalary_resid_next_cf, na.rm = TRUE),
           d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
         keyby = .(exp = {
           f = factor(total_exp_floor)
           levels(f) = list('1-3' = 1:3, '4-6' = 4:6, '7-10' = 7:10)
           f}, gender = factor(gender, levels = c('M', 'F')))
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ gender + exp, value.var = 'value')]
```

```{r table_4}
teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_lsalary = 
             mean(schedule_lsalary_next - 
                    schedule_lsalary_next_cf, na.rm = TRUE), 
           d_lsalary_resid = 
             mean(schedule_lsalary_resid_next - 
                    schedule_lsalary_resid_next_cf, na.rm = TRUE),
           d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]

teachers[move_district_next & urbanicity_d %in% c('Large Urban', 'Suburban') & 
           urbanicity_d_next == 'Suburban' & total_exp_floor <= 10,
         .(d_pct_prof_s = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp_s = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black_s = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl_s = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE)),
         keyby = urbanicity_d
         ][ , melt(.SD, measure.vars = patterns('^d_'))
            ][ , dcast(.SD, variable ~ urbanicity_d, value.var = 'value')]
```

```{r table_5}
teachers[move_district_next & ethnicity %in% c('B', 'H') & 
           total_exp_floor <= 10,
         .(d_pct_prof = mean(pct_prof_next - pct_prof, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next - pct_hisp, na.rm = TRUE),
           d_pct_black = mean(pct_black_next - pct_black, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next - pct_frl, na.rm = TRUE), N = .N),
         keyby = ethnicity
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity, value.var = 'value')]

teachers[move_school_next & !move_district_next & 
           ethnicity %in% c('B', 'H') & total_exp_floor <= 10,
         .(d_pct_prof = mean(pct_prof_next_s - pct_prof_s, na.rm = TRUE),
           d_pct_hisp = mean(pct_hisp_next_s - pct_hisp_s, na.rm = TRUE),
           d_pct_black = mean(pct_black_next_s - pct_black_s, na.rm = TRUE),
           d_pct_frl = mean(pct_frl_next_s - pct_frl_s, na.rm = TRUE), N = .N),
         keyby = ethnicity
         ][ , melt(.SD, measure.vars = patterns('^d_|N'))
            ][ , dcast(.SD, variable ~ ethnicity, value.var = 'value')]
```

```{r table_6}
districts[payscales[ , mean(lwage_ba_resid + lwage_ma_resid, na.rm = TRUE), 
                     by = .(district_fill, year)], 
          lwage_resid_avg := i.V1, on = c(district = 'district_fill', 'year')]
districts[teachers[ , .N, by = .(district_fill, year)],
          n_teachers := i.N, on = c(district = 'district_fill', 'year')]

q_var = c('lwage_resid_avg', 'pct_prof', 'pct_frl', 'pct_black', 'pct_hisp')
districts[ , paste0(q_var, '_q') := lapply(.SD, function(x) {
  brk = wtd.quantile(x, 0:4/4, weights = n_teachers, 
                     normwt = TRUE, na.rm = TRUE)
  cut(x, breaks = brk, labels = 1:4, right = FALSE, include.lowest = TRUE)
}), .SDcols = q_var]

teachers[districts, 
         `:=`(lwage_resid_q = i.lwage_resid_avg_q,
              pct_frl_q = i.pct_frl_q, pct_black_q = i.pct_black_q,
              pct_prof_q = i.pct_prof_q, pct_hisp_q = i.pct_hisp_q),
         on = c(district_fill = 'district', 'year')]

melt(teachers, id.vars = c('year', 'move_district_next', 
                           'move_school_next', 'quit_next'), 
     measure.vars = patterns('_q$'), na.rm = TRUE, value.name = 'quartile'
     )[ , .(`Probability Teachers Move to New School within District` = 
              mean(move_school_next & !move_district_next),
            `Probability Teachers Move to New District` = 
              mean(move_district_next),
            `Probability Teachers Exit Public Schools` = 
              mean(quit_next)), 
        keyby = .(`Quartile of Distribution` = 
                    factor(variable, 
                           levels = c('lwage_resid_q', 'pct_prof_q',
                                      'pct_frl_q', 'pct_black_q', 'pct_hisp_q')), 
                  quartile = 
                    factor(quartile, levels = 4:1, 
                           labels = c('Highest', '3rd', '2nd', 'Lowest')))]
```

```{r table_7}
exp_lab = c('1-3 years', '4-6 years', '7-11 years', '12-30 years')
teachers[ , exp_split := factor(total_exp_floor)]
levels(teachers$exp_split) = setNames(list(1:3, 4:6, 7:11, 12:30), exp_lab)
teachers[ , gender := factor(gender, levels = c('M', 'F'))]

teachers[payscales[ , log(wage_ba[1L]), by = .(district_fill, year)], 
         schedule_lbase_ba_salary := i.V1, on = c('year', 'district_fill')]
teachers[districts, `:=`(n_students = i.n_students, class_size = i.class_size),
         on = c(district_fill = 'district', 'year')]

reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 urbanicity_s + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l)
```

```{r table_8}
reg_l = 
  lapply(split(teachers, by = 'exp_split', sorted = TRUE),
         function(DT) DT[ , lm(move_district_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_s + pct_frl_s + 
                                 ethnicity_main*pct_black_s + 
                                 ethnicity_main*pct_hisp_s + factor(year) + 
                                 factor(district_fill) + total_exp_floor + 
                                 I(total_exp_floor^2) + n_students + class_size)])
texreg(reg_l, omit.coef = '^factor')
```

```{r table_9}
teachers[ , stay := !move_district_next & !quit_next]
teachersML = 
  melt(teachers, id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_s', 'pct_frl_s', 'urbanicity_s',
           'ethnicity_main', 'pct_black_s', 'pct_hisp_s',
           'total_exp_floor', 'n_students', 'class_size','exp_split'), 
       measure.vars = c('stay', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

setattr(teachersML, 'class', c('mlogit.data', class(teachersML)))

mnl_l = 
  lapply(split(teachersML, by = 'exp_split', sorted = TRUE), function(DT) {
    print(head(DT))
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_s + pct_frl_s + 
             ethnicity_main*pct_black_s + ethnicity_main*pct_hisp_s + 
             #need to include dummy for year, but solution fails
             urbanicity_s + total_exp_floor + 
             I(total_exp_floor^2) + n_students + class_size, data = DT)
  })
texreg(mnl_l)
```



# Conclusion

# References
