---
title: "Teacher Turnover in Wisconsin"
author: "Michael Chirico"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    keep_tex: yes
    includes:
      in_header: turnover_paper_header.tex
fontsize: 12pt
linestretch: 1.5
abstract: 'Given the consistently-affirmed importance of teacher quality to student success, understanding teacher churn is crucial to formulating and evaluating teacher labor market policy. This paper replicates and extends the analysis of @hanushek over a longer and more recent time period in Wisconsin and confirms all of its major findings, namely that while inter-district pay differentials are a significant determinant of turnover and that school quality measures are much better predictors of all three types of churn -- within and between school districts and out of local public schools. We further implement and validate a new technique for inferring contracted wage schedules from observed cross-sectional wage data.'
bibliography: references.bib
link-citations: true
---

```{r setup, include = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, results = 'hide', fig.path = 'figures/')
knitr::read_chunk('turnover_data_cleaner.R')
library(xtable)
options(xtable.comment = FALSE)
options(xtable.include.rownames = FALSE)
options(xtable.table.placement = 'htbp')
library(data.table)
library(texreg)
library(sandwich)
library(lmtest)
library(mlogit)
library(funchir)
pn = function(x) format(x, big.mark = ',')
```

```{r read_interpolate, cache = TRUE, include = FALSE}
#for intermediate debugging to skip interpolation step
# payscales = fread(wds['data'] %+% "wisconsin_salary_scales_imputed.csv",
#                   colClasses = list(character = 'district'))
```

```{r kenosha_drop}
#clear errors in Kenosha data in 2010;
#  blank pending correspondence with Ann Petering
teachers[year == 2009 & district_next == '2793',
         grep('salary.*next', names(teachers)) := NA]
```


# Introduction

\TAG{BEGIN_INTRO}

Good teachers have large impacts on student achievement[^teachers_important]. It is therefore imperative for public schools to be able to attract and retain high-quality teachers. Of preeminent concern for policymakers, then, is the strength of the various manipulable levers at their disposal for influencing teacher labor markets. More specifically, state and local education administrators would like to identify the policy implications of various tools on three types of teacher mobility: intra-district switching, where due to the collectively bargained nature of most teachers' salaries, only nonpecuniary considerations matter, inter-district switching, where teachers move to another school district in the same state, and exo-district switching, where teachers leave the public teaching workforce entirely[^new_teachers].

[^teachers_important]: See, e.g., @rockoff.

[^new_teachers]: Policies that affect the supply and quality of new teachers to the profession may also be of considerable importance to replenishing and improving the stock of teachers over time, but we do not consider these channels in this work. See @harris, @wayne, and @boyd2009.

In this paper, we consider pecuniary and non-pecuniary predictors of various types of teacher churn in replicating the analyses of @hanushek (HKR) in a new context (Wisconsin) and time horizon (`r sprintf('%d - %d', incl_rng[1L], incl_rng[2L])`). The headline results of @hanushek were that "teacher mobility is much more strongly related to characteristics of the students, particularly race and achievement, than to salary, although salary exerts a modest impact once compensating differentials are taken into account." We confirm the pith of this conclusion, namely that student characteristics are a much better predictor of turnover than are wage differentials, though we come to different conclusions regarding more specific points. To wit, while we do find strong evidence that the socioeconomic makeup of a teacher's district predicts turnover (and that there is heterogeneity in this effect by teacher race), the evidence we find for the importance of wages and student achievement is far from compelling.

We explore to the extent possible potential contributors to this discrepancy in results; most salient are the measurable differences between Texas, where @hanushek conduct their study, and Wisconsin. Wisconsin is a largely rural state -- its largest city/metropolitan area, Milwaukee, currently has roughly 600,000 residents (1,500,000 including the metropolitan area), making it around the 30th-largest city in the United States[^wi_large_urban]. By contrast, Texas has six cities larger than this, with El Paso (#6 in Texas) being the nearest in size to Milwaukee. Though the non-urban parts of Texas are themselves sparsely populated and distinctly rural, the more uniform lack of major population centers in Wisconsin is likely to be reflected when considerably different preferences among local vis-à-vis urban residents for various aspects of potential teaching positions are aggregated. 

[^wi_large_urban]: In fact, Milwaukee is the only city in Wisconsin considered to be "large" for NCES reporting purposes.

To the end of exploring the pecuniary aspects of teacher turnover, we start by expanding upon the efforts of @hanushek to infer teachers' tenure-wage paths from teacher-level data on pay. Most unionized teachers are paid according to a salary schedule (specifying wages as an increasing function of tenure and certification) explicated in contracts collectively bargained at the district level. With this easily-obtained information in hand, teachers are able to infer their future potential wage trajectories at their own and other potential district employers. Lacking the physical contract faced by the teachers, an econometrician armed only with administrative data reporting actual wages in a given year must use some imputation techniques to deduce the underlying wage structure. We explore the utility of natural Constrained B-Splines (COBS) to this end. COBS are an enhanced version of the traditional semiparametric splines technique enhanced by the ability to impose a monotonicity constraint on the resultant curve which allows the fit to incorporate more local information from nearby experience cells.

The fidelity and utility of the resulting fitted contract curves are supreme. In both large and small districts, COBS produces a plausible tenure-wage arc which enables us to examine counterfactual wage levels for mobile teachers. By comparing the fit to a small number of wage tables obtained from actual contracts, we also learn that using COBS may be preferable to an attempt to use actual wage tables, as the data-derived curves can reveal latent progress of teachers towards further certification, an aspect which is commonly observed in salary tables but rarely included in teacher-level data Thus, empircally-derived curves can hew closer to the true wage path that rationally forward-thinking teachers are likely to consider when mulling over career options.

\TAG{END_INTRO}

\TAG{BEGIN_BODY}

# Literature Review

Because the potential policy implications of turnover in the teaching profession (from human capital and equity/distributional perspectives both) are far-reaching and polypartisan, the literature on turnover-related topics in education is extensive. As relates to this paper, there are five broad (and often overlapping) categories of inquiry: the relationship between turnover and wages, which has tended to focus on “opportunity wages” outside of the field of education; the relationship between turnover, school demographics, and other nonpecuniary benefits, which has tended to focus on distributional inequalities--whether teachers with certain characteristics are more or less likely to be teaching certain disadvantaged groups; the relationship between turnover and teacher quality as measured by student performance, usually value added (VA); collective bargaining agreements in education, focusing by and large on the implications (or lack thereof) of seniority-preferential clauses; and the recent phenomenon of specific retention incentives, the provisioning of wage bonuses to teachers willing to teach in high-needs schools.

One of the earliest papers attempting to rigorously investigate turnover was a panel study of teachers in Michigan by @murnane, who used college degree field wages outside of education as opportunity wages, finding the expected lower exit rate for teachers with higher wages in teaching relative to the authors' defined alternative. @dolton use panel data on university graduates in the United Kingdom to estimate a competing risks model of the decision to leave teaching entirely, finding results in line with @murnane. Returning to panel studies in the US, @loeb use PUMS data to get an idea of teacher relative wages in many states and find that dropout rates fall when teacher relative wages are high. @stinebrickner also uses panel data (this time NLS-72) to track both teachers and non-teachers, focusing in particular on young teachers who leave the profession for long stints, and finds that the best predictor of female exit is recent childbearing, which is an important consideration for all work related to teacher turnover because such a high percentage (76 nationwide) of teachers are female. Lastly, @hanushek focuses on teachers in Texas and emphasizes that the characteristics of students are much stronger factors in predicting teacher exit than are wages (while also affirming the statistical significance of pay).

While wages have been found consistently to have some measurable effect on teacher turnover, it is impossible to explain within-district migration (which constitutes a large portion of switching--as much as 50%) through wage-only channels because contracts are fixed at the district level. As such, another strand of literature has chosen to focus on the nonpecuniary aspects of the decision to take a teaching job--school environment/rapport, student enthusiasm, neighborhood characteristics, etc.--usually by directing attention to a single district so that any wage-based considerations are stifled, as is the case for @boyd2005 and @engel. @boyd2005 track early-career teachers in New York City as they quit or transfer out of the city, and most importantly finds that commuting time is an important, often overlooked aspect of location preference. @engel leverages a unique data set from Chicago Public School job fairs which affords them a rather strong measure of teachers' demand for vacancies, neutralizing the influence of school administration's behavior on turnover (through poor match selection or other means). The authors contribute evidence that the school's neighborhood (perhaps due to ambient crime or other reputational effects good and bad) is a better predictor of teachers' preference than distance from home, going somewhat against the grain of @boyd2005. @scafidi examine statewide data from Georgia, but ignore wage effects, choosing instead to focus on disentangling the contributions of low student achievement and minority status to turnover; they find that minority status is the more salient associate of teacher exit.

The key element missing from all of the above studies is perhaps the most important consideration in the issue of teacher turnover--teacher quality. None of the studies above have student-teacher matched data, and so are unable to directly associate student outcomes with any given teacher. If, with respect to any measure of quality you would like, we find that transitioning teachers are identical to their replacements, the issue of teacher turnover is not, in fact, much of an issue. Thus, the recent trend in the literature to incorporate measures of teacher quality (in large part made possible by a trend towards administrative records allowing students to be linked to teachers and tracked over time) in considerations of teacher turnover has made big strides in addressing the most policy-relevant questions to be asked. The most common and widely accepted measure of teacher quality is VA[^value_added] (in its various guises), and the literature has begun to incorporate such measures into studies of teacher turnover. @hanushek2010 consider VA as a measure of teacher productivity, and ask if common results of labor search theory (namely that turnover falls with tenure and that turnover is negatively associated with match-specific productivity) continue to hold in the education labor market. In fact, the authors find that the teachers most likely to switch schools are those with low measured match quality, and especially that those who leave teaching entirely are those with the lowest match quality. The results are more pronounced for schools with high proportions of low-SES students, which has strong policy implications, as it appears the best teachers in high needs schools are the least likely to change jobs. @goldhaber2007 performs a similar analysis with the longitudinal data of North Carolina and comes to similar conclusions, strengthening the robustness of the results. Lastly, @goldhaber2015 examine the inequity in the distribution of teacher quality by high-needs groups in Washington state, and find that for all three measures of quality (teacher experience, licensure exam score, and VA), the distribution of teachers favors the less needy (as measured by free/reduced-price lunch status, minority status, and low prior academic achievement).

[^value_added]: The most commonly cited expositions on value-added, its validity, and so on are probably @rivkin, an extensive exploration of the predictive powers of empirical Bayes VA measures; and @chettyI and @chettyII, the largest-scale study of long-term inferences based on VA.

The aforementioned papers have tended to keep the collective bargaining aspect of salary determination for teachers out of the spotlight, if largely for reasons of data restrictions. Nevertheless, it stands to reason to believe that the rigid structure of union-negotiated contracts could serve to contribute in a large way to teacher turnover. @ballou give much descriptive evidence of the shape of the wage-tenure profile, rooted in a data set collected by the Department of Defense and published by the AFT. They find that seniority premia in education largely mirror those in more traditional white collar professins, that steeper profiles are associated with less turnover, and that district financial and demographic conditions alone are insufficient to explain variation in contracts. Another common (and recently quite controversial, as evidenced by the contention in the ongoing contract negotiations in Philadelphia) feature of union-negotiated teacher contracts are seniority priviliges--preferential treatments granted to teachers in voluntary and involuntary transfers. @moe codes contracts from 158 districts in California according to the strength of seniority rights therein guaranteed to teachers and finds that such rights are associated with the distribution of teachers across schools (measuring quality as experience and certification) in a way that serves to harm minorities. Revisiting California with a slightly different sample and definition of the “determinacy” of the contracts with respect to seniority, @koski come to the opposite conclusion--that there is no such relationship. As a rebuttal, @anzia pin the difference in results on the exclusion in @moe of small school districts, where it appears that the entrenchment of bureaucracy falters and the rigidity of contract language wane, a claim which they support by repeating their analysis with the inclusion of an interaction for district size--indeed, for small districts the result of @koski holds, while the insight of @moe holds in larger districts. @cohenvogel use data from Florida and their results align with those of @koski (though they neglect to nuance their results by district size).

Finally, an emerging strand of literature is looking at the potential for transfer bonuses and retention incentives to positively affect student outcomes. @fulbeck analyzes a scheme in place in Denver whereby teachers who choose to transfer to high-needs schools (low-performing) are given recurring bonus pay, and those initially stationed there are given retention incentives. She concludes that recipients of incentives are significantly less likely to switch jobs, as driven by a reduction in district exit rates and especially by teachers whos incentive payments exceed \$5,000. @glazerman evaluate the Talent Transfer Initiative, a randomized controlled trial conducted in 10 districts whereby high-performance teachers were given \$20,000 over the course of two years as reward for transferring the identified high-needs schools, and conclude that there were significant effects on teacher retention as well as on student outcomes.

Two highly germane papers investigate the impact in Wisconsin on teachers of Governor Scott Walker's flagship policy, Act 10, which severely limited the scope for collective bargaining in the state. @litten uses differences in contract renewal dates surrounding the policy's enactment to evince the effect of unionization on teachers' wages, and finds the lack of union bargaining power reduced teacher compensation by 8%. @biasi constructs value-added measures from grade-level test results and concludes that the move to individually-negotiated salaries in some districts had a significant impact on teacher quality and student outcomes in such districts, while also cautioning that most of these gains are competition-based, so that scaling up the system state-wide would have an impact limited to a boost from the exit of low-quality teachers. 

# Data

```{r sample_restrictions, include = FALSE}
#use some command line utilities to automatically
#  generate some of the pre-cleaning counts
raw_file_pattern = 
  '/media/data_drive/wisconsin/teacher_raw_data/data_files/*.csv'
count_all_lines = 
  paste0('wc -l ', raw_file_pattern, ' | ',
         'grep total | awk \'{gsub("[^0-9]", "")}1\'')
count_headers = paste('ls', raw_file_pattern, '| wc -l')
total_observations = as.integer(system(count_all_lines, intern = TRUE)) - 
  as.integer(system(count_headers, intern = TRUE))
total_matchable = 
  gsub('[^0-9]', '', system(paste('wc -l', data_path), intern = TRUE))
total_matchable = as.integer(total_matchable) - 1L

ethnicity_flagged = teachers[(ethnicity_flag), uniqueN(teacher_id)]
gender_flagged = teachers[(gender_flag), uniqueN(teacher_id)]

avg_cert_premium = 
  teachers[ , median(salary), keyby = .(total_exp_floor, highest_degree)
            ][ , V1[2L]/V1[1L], by = total_exp_floor][ , mean(V1) - 1]
```

The State of Wisconsin's Department of Public Instruction (DPI) releases annual Salary, Position & Demographic reports through the WISEstaff data collection system. These reports represent "a point-in-time collection of all staff members in public schools as of the 3rd Friday of September..." [@dpi], and will serve as the primary source of data on teachers in this paper. Data are available at the position-teacher level cross-sectionally, with each entry in a given year corresponding to one of possibly several positions/assignments held by each school district employee[^multiple_positions]. Identifiers in each file permit unique identification of an employee within a given year, but this identifier does not follow teachers between years[^file_number]. To overcome this substantial hurdle to identifying teacher mobility, data are first fed through the matching algorithm described in further detail in the Appendix. Essentially, we are aided by the availability of various imperfect identifiers which should be more stable over time, most crucially teachers' first and last names and year of birth. By building on these covariates and incorporating some limited fuzzy matching techniques, we construct a panel of teachers spanning the 1994-95 academic year (AY) through AY2015-16 [^spring] consisting of `r pn(total_observations)` teacher-position-year observations. The matching algorithm necessitates elimination of `r pn(total_observations - total_matchable)` (`r to.pct(1 - total_matchable/total_observations, 1L)`%) observations over all 21 years on account of belonging to teachers who could not be uniquely identified in a given year of data due to exact overlap of their first name, last name, and birth year fields with another teacher in the data[^unique_clean].

[^multiple_positions]: Many teachers (and other district employees) serve in multiple roles within a school/district, for example as a coach, part-time program aide, or department head. Each of these is filed as a separate observation in the DPI system, though salary information is given at the teacher as opposed to the assignment level.

[^file_number]: From AY2011-12, a field called the File Number appears to allow longitudinal tracking of teachers. We use this in part to validate the matching algorithm; see the Appendix.

[^spring]: For brevity, we herein refer to academic years by the spring year, e.g., AY2003-04 will be simply 2004.

[^unique_clean]: Technically, we use a slightly modified version of the name strings in making these eliminations which, for example, eliminates initials -- see Appendix.

Specific to the exercise at hand, with data reliability and precision in mind, we make the following series of further restrictions on the data. The introduction of Wisconsin Act 10 introduced a substantial structural break in the labor market for Wisconsin teachers, so we include only data from `r teachers[ , sprintf('%d-%d', min(year), max(year))]` to avoid conflating the effects of this policy on teacher turnover with the earlier functioning of the labor market (i.e., we do not want to mix the results from distinct equilibria of the teacher labor market, but would instead prefer to analyze the pre- and post-Act-10 markets separately). We drop all employees who are not full-time, full-year regular teachers of a major core subject (all-purpose elementary teachers or English/Math) at a single regular public school with a Bachelor's or Master's degree and fewer than `r max_exp` years' recorded experience; taken together, these restrictions eliminate `r round(100*abs(N_subset_I/N_full - 1))`% of employees, the lion's share of which come from eliminating substitutes/support staff and teachers of on-core subjects[^position_code]. We then eliminate teachers with missing information on their subsequent school or district and teachers with instability in their recorded ethnicity, as well as teachers not categorized as white, black, or Hispanic, eliminating a further `r round(100*(N_subset_I - N_subset_II)/N_full, 1L)`% of all employees[^ethnicity]. Finally, we drop teachers' multiple positions by keeping only the highest-intensity position for each teacher, as measured by full-time equivalency, resulting in a final count of `r pn(nrow(teachers))` teacher-year observations -- `r pn(teachers[ , uniqueN(teacher_id)])`s in `r pn(teachers[ , uniqueN(district)])` districts and `r pn(uniqueN(teachers, by = c('district', 'school')))`.

[^position_code]: \label{ftn:pos_code}We also eliminate any teacher who appears in any role besides "Teacher" in any year. In particular, this eliminates a nontrivial number of educators who begin their career with an "ease-in" period, take a mid-career "leave" speckled with a transition to substitute teaching -- perhaps during their child's infancy -- or end it with a "soft retirement" period, during which they act as a substitute teacher at some point in the midst of a career otherwise focused on teaching. Such teachers often have part-time roles at several local schools, which introduces sufficient ambiguity in the definition of mobility so as to obscure interpretation of results, so we opt for a stricter definition of full-time teaching than is completely necessary.

[^ethnicity]: Wisconsin teachers are predominantly white (`r pct_white`%). As noted in the Appendix, we also use the panel data to correct noise found in recorded ethnicity and gender over time for some teachers. In the final sample, `r pn(ethnicity_flagged)` and `r pn(gender_flagged)` teachers had their ethnicity and gender (respectively) adjusted in some year(s).

The data used for the incorporation of counterfactual salary calculations is largely the same, but with a few noteworthy differences. First, as noted in Footnote \ref{ftn:pos_code}, the main turnover data eliminated some teachers who transitioned in and out of being categorized as a full-time teacher due to the muddling effects thereof on defining turnover. This concern not being relevant to constructing the salary schedules, it is not imposed for this data. Next, because all regular teachers are covered by the same collective bargaining agreement, the salary imputation data is less restrictive with respect to the subject codes excluded from the data, and generally includes any teacher not in special education. This data also ignores instability in recorded gender and ethnicity within a teacher. 

Finally, the salary data loses observations that are present in the turnover data based on a series of cuts which are either required for COBS to function, or else substantially increase the reliability of its output. The most noteworthy/far-reaching of these numerical restrictions is to eliminate any teachers working in districts where there are not at least 20 total teachers in each degree track for that year. While ultimately arbitrary, this number is reasonable to limit the potential effect of an individual teacher on an exercise determining `r max_exp` levels of pay with minimal functional form restrictions. The other numerical flags require both the BA & MA track to be represented at a district, for at least 7 distinct levels of experience to be represented within a degree track, and for at least 5 unique values of the two measures of pay (salary and fringe benefits) to be available in each degree track; all teachers at districts failing at least one of these tests is dropped.

The sum total of all of these restrictions leaves us with an analysis sample of `r pn(nrow(teachers_ps))` teacher-year observations to be used to estimate pay scales, made up of `r pn(n_teachers)` individual teachers in `r teachers_ps[ , uniqueN(district)]` districts over `r teachers_ps[ , uniqueN(year)]` years. In total, there is sufficient data to fit `r pn(uniqueN(teachers_ps, by = c('year', 'district', 'highest_degree')))` $y_t(\tau, c, d)$ curves, an average of roughly `r round(nrow(teachers_ps)/uniqueN(teachers_ps, by = c('year', 'district', 'highest_degree')), -2)` observations per curve. Ultimately around `r  teachers[ , round(100*mean(is.na(schedule_lsalary)))]`% of teachers have missing salary information[^na_salary], mostly in rural districts or other districts with only one or two schools and a small number of students. 

[^na_salary]: HKR include like-minded restrictions, but combine teachers of different certification within an experience level, despite the headline importance of this factor to teacher pay -- median pay at a given level of experience is on average `r to.pct(avg_cert_premium, 0)` higher for those with a Master's degree.

We supplement the WISEstaff data set in several ways to incorporate information about other characteristics of schools and districts in Wisconsin. To get school- and district-level measures of socioeconomic makeup (percentage of students who are black or Hispanic or eligible for free/reduced lunches) and community type/urbanicity, we tap the Universe Surveys from the National Center for Education Statistics' Common Core of Data, which provide this information on a yearly basis for all years in the study[^urbanicity_details]\textsuperscript{,}[^missing_sd]. At the district level, we also use this data to compute class size and the size of the student body.

[^urbanicity_details]: The method of recording urbanicity by the Common Core switched from being "metropolitan-centric" to being "urban-centric" for Wisconsin from 2006 [@sable]. We map the corresponding codes to match those used by HKR as well as possible, and use the data file from 2006, which has both types of code for all US districts, to confirm that the pre- and post-2006 correspondence is by-and-large working as intended. For a small number of districts/schools with missing urbanicity codes in certain years, we use information about that entity from other years to inform urbanicity.

[^missing_sd]: Further, the WKCE data does not include a standard deviation field even in those years when the school average scale score is available, precluding any attempt to standardize test scores and put the data here on equal footing with that of HKR.

Lastly, we turn to DPI's public data again to get school- and district-level performance metrics. While @hanushek were able to obtain school- and district-level average scale scores on a standardized test in Texas, such a metric is not publicly available in Wisconsin for all years. Instead, we calculate student proficiency rates for each school and district as the percentage of test-takers deemed to be at grade level in mathematics or reading in a given year on the Wisconsin Knowledge and Concepts Examination (WKCE), which is administered to 4th, 8th, and 10th-grade students.

# Salary Scale Imputation with Constrained B-Splines

For many years, the ubiquitous characteristic of collectively bargained teachers' contracts has been the salary table, which gives a mapping from the calendar year, a teacher's experience (their length of tenure at the current district), and their certification (typically Master's vs. Bachelor's degree) to their wage. This table gives current teachers a clear understanding of how their pay will advance as a function of their labor inputs, and thereby gives forward-looking potential teachers and potential migrant teachers a clear understanding of their would-be pay arcs under a district-switching decision-making framework, especially given that this information is typically openly available. 

It would behoove an econometrician seeking to understand education labor market dynamics, then, to incorporate this information on future pay into their statistical modeling framework. Unfortunately, this data is typically not available in a format lending itself to easy analysis at scale -- whether locked inside idiosyncratically formatted and sporadically-available contract PDFs or hidden behind large-scale freedom of information act inquiries, the temporal and financial costs of scraping such data into a usable form can be substantial.

Much more common in empirical settings is access to teacher-year-level salary data of the form $y_{i, t} = y(\tau_{i, t}, c_{i, t}, d_{i, t}) + \varepsilon_{i, t}$, where $\tau_{i,t}$, $c_{i, t}$ and $d_{i, t}$ are the tenure, certification, and district of teacher $i$ in year $t$, and $\varepsilon_{i, t}$ represents unaccounted factors affecting the wage (e.g., not all teachers work full time, some teachers split their time among duties yielding different pay levels, and many teachers supplement their income with additional duties like coaching). Here we consider one approach and some empirical lessons for trying to estimate the underlying mapping $y(\tau, c, d)$ from such data.

There are a multitude of inference/imputation techniques suitable to the inference of a latent function of unknown parametric form available in the statistician/econometrician's palette. The powerful flexibility of nonparametric approaches (local regression, splines, Random Fourier Feature expansions) is a double-edged sword; as it happens, in this particular setting, even if we know linearity is not a reasonable functional form restriction, we do know some very basic properties of the underlying tenure-wage curves that will be violated in general by uninformed estimation techniques. In particular, we know that such tenure-wage curves are non-decreasing and that they are non-negative, i.e., $y(\tau', c, d) >= y(\tau, c, d)$ whenever $\tau' >= \tau$, and $y(0, c, d) \geq 0$.

@he introduce a linear programming approach to incorporating monotonicity, curvature, and pointwise restraints to quantile regression spline estimation techniques, and @ng present an overview of the R package \texttt{cobs} which gives an efficient implementation of this approach (COBS standing for Constrained B-Splines; B-splines are computationally-efficient basis functions for degree $k$ splines). The basic idea of quantile regression spline estimation is to swap out the standard squared loss function for a quantile-dependent weighted absolute loss function to target conditional quantiles instead of conditional means. Monotonicity, point, and curvature restrictions enter as penalized terms to the objective function; \texttt{cobs} expresses this in a fashion which facilitates the application of standard linear programming techniques for efficiency, and handles internally the issues of knot selection and penalty parameter assignment through cross-validation.

We implement and fine-tune this general approach with an eye to being as minimally-invasive as possible. The first innovation is required by the poor performance of standard COBS fit in extrapolation. Data sparsity in smaller districts means that it is often the case that only a small range of $\tau$ values are observed in a given year-certification-district. Monotonicty constraints are only built into the B-spline routine internally; the underlying basis functions may produce decreasing fits outside the observed range of data. To overcome this, we take a cue from the literature tackling Runge's Phenomenon [@runge], wherein polynomial approximations tend to exhibit extreme oscillations in extrapolation. This issue is one of the motivations behind natural cubic/smoothing splines [see, e.g., @friedman; @wahba; @green; or @deboor], which handle this issue by using a simple linear basis function outside the outermost interpolating knots. We incorporate this technique of linear extension only when necessary by testing the COBS fit for monotonicity; $\tau$ values failing this constraint are replaced by extending the final non-decreasing fit values through the end of the range of extrapolation.

Next, a major shortcoming of COBS for this context is its limit to one-dimensional spline fits; while techniques for nonparametric B-spline fits are available in arbitrary dimensions [see @deboor], at present COBS is only capable of imposing monotonicity on one dimension of a curve. In our context, however, $y(\tau, c)$ is increasing not only with respect to $\tau$, but also with respect to $c$ (as, without fail until only very recently in Wisconsin, certification was rewarded with a Master's premium, typically a percentage increase in wage). One solution would be to generalize the implementation of COBS to handle a second dimension by simply adding penalty terms along this dimesion[^many_lanes]. We abandon this approach because of the categorical nature of the certification dimension -- there are not numerical units to the difference between having a Master's vs. Bachelor's degree. The assignment of such a number required by this approach would itself become an implementation hyperparameter, meaning that the ultimate fit would itself be sensitive to the particular choice of continuous representation.

[^many_lanes]: Not to mention the empirical reality that the two-lane dichotomy is in fact false -- it is very common, nearly ubiquitous, for contracts to offer separate lanes for teachers with the same completed certification, but different levels of progress towards completing further certification. As this dimension is impossible to glean from our data, we exclude it from the imputation exercise.

Instead, we use a two-step procedure to fit the Bachelor's and Master's pay tracks in serial. In the first step, we fit the Bachelor's career track as a typical one-dimensional COBS fit. In the second step, we first construct Master's premia for each observation by subtracting out the predicted Bachelor's pay corresponding to each observed level of tenure for a teacher with a Master's degree. We then use COBS to fit a non-decreasing Master's premium curve over all tenure levels on these residuals, before finally adding the Master's premium and Bachelor's fit curves to get the overall Master's fit curve. Monotonicity of the result is guaranteed by forcing upwards monotonicity on the Master's premium, a restriction in line with the empirical observation that Master's degree pay is often simply a fixed-percentage rise over the corresponding Bachelor's pay.

Our implementation was also aided by the imposition of weak concavity on the $y(\tau, BA)$. While not a theoretically-assured functional form restriction[^convexity], concavity improves the goodness of fit notably. Small-sample district-level observations and simple reduced-form regressions of wages versus quadratic forms in experience support this shape's validity. A variety of contracts obtained from a database for teachers in nearby Michigan also meet this condition, and the decrease in marginal returns to experience is also commonly found in the wider study of labor markets[^mincer_experience]. We do not impose this restriction on the fit for the Master's premium (the only restrictions there being non-negativity at 0 and, as mentioned, an increasing relationship with tenure). 

[^convexity]: In fact, in reality tenure-wage curves are often piecewise convex -- year-over-year rises are specified as a percentage bump which eventually levels off to either linear increase or maxes out and flattens. Nevertheless, the degree of convexity in that section of the curve tends to be low, which leads COBS to fit a good linear approximation there. The lack of a concavity restriction on the Master's pay track allows fit curves which fit this pattern for this lane.

[^mincer_experience]: See, e.g., @heckman.

```{r milwaukee, fig.cap = '\\label{fig:mwk}Pay in Milwaukee, 2003-2006'}
mwk = teachers_ps[district == '3619']
mwk_avg_n = teachers_ps[ , .N, by = year][ , mean(N)]
par(mfrow = c(2, 2),
    mar = c(0.1, 0.1, 0.6, 0.1),
    oma = c(5.1, 5.1, 4.1, 2.1))
yrs = 2003:2006
parm = list(x = list(),
            y = list(las = 1L))
ymx = mwk[year %in% yrs, 1.05*max(salary, na.rm = TRUE)]
for (ii in 1:4) {
  yr = yrs[ii]
  mwk[year == yr, 
      as.list(c(N = .N, quantile(salary, c(.25, .5, .75)))), 
      keyby = .(ba = highest_degree == 4,
                ex = total_exp_floor)
      ][CJ(ba = c(FALSE, TRUE), ex = seq_len(max_exp)), on = c('ba', 'ex')
        ][ , {
          ex = unique(ex)
          BA = .SD[(ba), !c(1:3), with = FALSE]
          MA = .SD[(!ba), !c(1:3), with = FALSE]
          matplot(ex, BA, type = 'l', lty = c(2, 1, 2), 
                  lwd = 1L, col = 'blue', ylim = c(0, ymx),
                  axes = FALSE)
          mtext(yr, side = 3L, cex = .6, line = -.5)
          if (ii %% 2 == 1) mtext('Salary ($)', side = 2, line = 4)
          if (ii > 2) mtext('Tenure (Years)', side = 1, line = 3)
          matplot(ex, MA, type = 'l', lty = c(2, 1, 2), 
                  lwd = 1L, col = 'red', add = TRUE)
          tile.axes(ii, 2, 2, parm)
          par(new = TRUE)
          barplot(matrix(N, nrow = 2, byrow = TRUE),
                  beside = TRUE, col = c('red', 'blue'),
                  ylim = c(0, 2.5*max(N, na.rm = TRUE)), axes = FALSE)}]
}
legend('right', c('BA', 'MA', 'Median', '25/75 %ile', '# Teachers'),
       col = c('blue', 'red', 'black', 'black', 'black'),
       lty = c(1, 1, 1, 2, NA), pch = c(NA, NA, NA, NA, 15), bty = 'n', cex = .5)
mtext('Empirical Distribution of Salary in Milwaukee\n' %+%
        'By Certification', outer = TRUE, side = 3)
```

As an illustrative example of the patterns in the data we wish to quantify and formalize, we turn briefly now to Milwaukee Public Schools, the largest district in Wisconsin with roughly `r pn(mwk_avg_n)` teachers per year. Figure \ref{fig:mwk} depicts key moments of the empirical distribution of salary in 4 years at Milwaukee Public Schools, broken down by tenure and certification. The central lines on each plot (Bachelor's pay track in blue, Master's pay track in red) are the empirical median levels of pay, and thus give a rough approximation to $y(\tau, c)$. The dashed-line intervals on either side represent the 25th and 75th percentiles.

Notably, these intervals and the medians themselves tend to get quite noisy at later stages in the career, especially for the Bachelor's track. This fact that reflects the almost universal certification of teachers by about 15 years into their career. This is reflected in the bar graph below each set of curves, which shows the distribution of teachers in each certification track by tenure. Almost all new teachers start with only a Bachelor's degree; the relative presence of Master's degrees grows over time as more teachers certify mid-career.

We can also note two more key empirical facts from this plot. First, the vanishing presence of teachers in both certification tracks leads the empirical median to be a poor approximation of $y(\tau, c)$ since it frequently fails to respect the fundamental monotonicity constraint discussed above. With respect to tenure, this tends to affect the Bachelor's track later in the career as more teachers certify, and the Master's track very early in the career before teachers certify. The monotonicity with respect to $c$ of the median wage is mostly maintained here for Milwaukee, but this is not always the case; our estimation procedure is thus careful to impose these restrictions internally.

Second, structural breaks are an important empirical phenomenon in this context. Each time a contract is renegotiated at a district, the tenure-wage curves can potentially change shape dramatically. It is with this in mind that we refrain, given our ignorance with respect to when such structural breaks occur, from combining information from adjacent years in fitting a given year's curve, an approach which would substantially enhance the statistical power available to fit contracts for sparsely-populated districts. Such a structural break is apparent in Milwaukee, for example, between 2003 and 2004 and between 2005 and 2006, where the shape of the Master's pay scale has shifted notably. While we eschew, for example, full Bayesian estimation of structural breaks in a given district, such techniques are applicable and worthy of future exploration.

## Goodness of Fit

Returning to the motivating example illustrated in Figure \ref{fig:mwk}, we turn first to the performance in Milwaukee, where, given the relatively large sample size, performance is expected to be very good. Indeed this is the case, as seen in Figure \ref{fig:mwk_fit}. The COBS fit has retained all the salient features of the empirical median return to experience and certification, while simultaneously improving over this nonparametric conditional median by ironing out nonmonotonicities found empirically as a result of small-sample bias. 

```{r milwaukee_fit, fig.cap = '\\label{fig:mwk_fit}Estimation Results for Milwaukee, 2003-2006'}
X = mwk[ , .(med_ba = median(salary[highest_degree == 4]),
             med_ma = median(salary[highest_degree == 5])),
         keyby = .(year, tenure = total_exp_floor)
         ][dcast(payscales[district == '3619'], 
                 year + district + tenure ~ highest_degree,
                 value.var = 'wage'),
             on = c('year', 'tenure')]
setnames(X, c('4', '5'), c('wage_ba', 'wage_ma'))
par(mfrow = c(2, 2),
    mar = c(0.1, 0.1, 0.6, 0.1),
    oma = c(5.1, 5.1, 4.1, 2.1))
parm = list(x = list(),
            y = list(las = 1L))
for (ii in 1:4) {
  yr = yrs[ii]
  X[year == yr, {
    #ymx = 1.05*max(c(wage_ma, wage_ba))
    y = .SD[ , !c("year", "tenure", "district")]
    matplot(tenure, y, type = 'l', lty = c(2, 2, 1, 1), 
            lwd = 1, col = c('blue', 'red', 'blue', 'red'),
            ylim = c(0, ymx), axes = FALSE)
    mtext(yr, side = 3L, cex = .6, line = 0)
    if (ii %% 2 == 1) mtext('Salary ($)', side = 2, line = 4)
    if (ii > 2) mtext('Tenure (Years)', side = 1, line = 3)
    tile.axes(ii, 2, 2, parm)}]
  box()
}
legend('right', c('BA', 'MA', 'Empirical Median', 'COBS Fit'),
       col = c('blue', 'red', 'black', 'black'),
       lty = c(1, 1, 2, 1), bty = 'n', cex = .5)
mtext('Comparison of Fit Schedule and Empirical Median in Milwaukee\n' %+%
        'By Certification', outer = TRUE, side = 3)
```

Perhaps more telling is the goodness of fit in minimally small districts. Four such examples are featured in Figure \ref{fig:small_fit}. These four districts just barely satisfy the sample restriction that at least 20 teachers be present in both the BA and MA pay track (each has fewer than 42 teachers, and only in a single year); for this reason, rather than plot the empirical median, we simply present the full distribution of wage, experience, and certification in these districts. Here again the COBS fit captures the essence of the wage-tenure curve even in these sparsely-staffed districts. Both Montello and Manawa evince the importance of the non-negativity constraint on extrapolated values of the Master's premium -- given the absence of teachers so certified prior to the fifth year of experience, some supplementary discipline is necessary to prevent the tail of this curve from dipping below that for the Bachelor's lane.

```{r small_dist_fit, fig.cap = '\\label{fig:small_fit}Estimation Results for Selected Sparse Districts'}
par(mfrow = c(2, 2),
    mar = c(0.1, 0.1, 0.6, 0.1),
    oma = c(5.1, 5.1, 4.1, 2.1))
parm = list(x = list(),
            y = list(las = 1L))
dists = c(`Minocqua J1 School District (2003)` = '3640', 
          `Auburndale School District (2007)` = '0203',
          `Montello School District (2009)` = '3689',
          `Manawa School District (2009)` = '3276')
ymx = 1.05*max(payscales[district %chin% dists & 
                           highest_degree == 5L, wage],
               teachers_ps[district %chin% dists, salary])
#don't have to condition on year -- all only show up once
for (ii in 1:4) {
  dst = dists[ii]
  payscales[district == dst, {
    idx = highest_degree == 4L
    matplot(tenure[idx], cbind(wage[idx], wage[!idx]),
            col = c('blue', 'red'), lty = 1L, type = 'l',
            axes = FALSE, ylim = c(0, ymx))
  }]
  teachers_ps[district == dst,
              points(total_exp_floor, salary, col = 
                       ifelse(highest_degree == 4L, 'blue', 'red'))]
  mtext(names(dists)[ii], side = 3L, cex = .6, line = 0)
  if (ii %% 2 == 1) mtext('Salary ($)', side = 2, line = 4)
  if (ii > 2) mtext('Tenure (Years)', side = 1, line = 3)
  tile.axes(ii, 2, 2, parm)
  box()
}
legend('bottomright', c('COBS Fit, BA', 'COBS Fit, MA', 'Observed Pairs'),
       col = c('blue', 'red', 'black'),
       lty = c(1, 1, NA), pch = c(NA, NA, 1), bty = 'n', cex = .5)
mtext('Comparison of Fit Schedule and Observed Wages in Small Districts\n' %+%
        'By Certification', outer = TRUE, side = 3)
```

A final check on the validity of the imputation procedure would be to compare fit schedules side-by-side with the true schedules, e.g. through root mean-squared error. As mentioned, this is typically a difficult undertaking on a mass scale since the true schedules may be hard to come by in a parseable electronic format. Usually, a smaller-scale version of this exercise would be possible through sampling, say, 5-10% of districts at random and spending the time to extract actual schedules by hand for this purpose. Unfortunately, with the passage of Act 10 and the abandonment of collective bargaining in many districts, electronic copies of legacy contracts became hard to come by -- none of the large districts we contacted (nor their former union representatives) had access to old copies of contracts they were willing to share, nor could we find any but a very small number of these contracts online. We present here the comparison of COBS-produced fit to true schedule in three district-year combinations for which we could actually obtain the true schedule[^available].

[^available]: These contracts and a few others from outside of the study time frame are available upon request.

```{r true_schedule_fit, fig.cap = '\\label{fig:true_fit}Comparison of True Contracted Schedule with Output of Imputation'}
true_sched = 
  melt(fread(wds['data'] %+% 'actual_contract_schedules.csv'),
       id.vars = c('district', 'district_name', 'year', 'certification'),
       measure.vars = patterns('^tenure_'),
       variable.name = 'tenure', value.name = 'wage')
true_sched[ , tenure := as.integer(gsub('.*_', '', tenure))]
#pull out monona BA+12 & BA+24 scales
idx = true_sched[district == 3675 & 
                   grepl('BA+', certification, fixed = TRUE), which = TRUE]
monona_ba = true_sched[idx]
#now remove
true_sched = true_sched[!idx]
#for easier merging, rename & cast as string
true_sched[ , district := sprintf('%04d', district)]
true_sched[ , highest_degree := 4L + (certification == 'MA')]
dyr_com = unique(true_sched[ , .(district, district_name, year)])

par(mfrow = c(1L, 3L), 
    mar = c(.1, .1, .6, .1), 
    oma = c(5.1, 5.1, 4.1, 2.1))
ymx = max(true_sched[dyr_com, wage, on = c('district', 'year')],
          payscales[dyr_com, wage, on = c('district', 'year')])
parm = list(x = list(),
            y = list(las = 1L))
for(ii in seq_len(nrow(dyr_com))) {
  this_dist = dyr_com[ii]
  is_monona = this_dist[ , unique(district)] == '3675'
  if (is_monona) {
    monona_ba[ , dcast(.SD, district_name + year + tenure ~ 
                         certification, value.var = 'wage')
               ][ , { y = .SD[ , grep('BA', names(.SD)), with = FALSE]
               matplot(tenure, y, type = 'l', col = 'gray', lty = 1L, 
                       ylim = c(0, 1.05*ymx), cex.main = .8, axes = FALSE)}]
    legend('bottomright', c('BA', 'MA', 'Truth', 'Fit', 'Teachers'),
           col = c('blue', 'red', 'black', 'black', 'black'),
           lty = c(1L, 1L, 2L, 1L, NA), lwd = 2L,
           pch = c(NA, NA, NA, NA, 1L))
  }
  true_sched[this_dist, {
    idx = highest_degree == 4L
    matplot(tenure[idx], cbind(wage[idx], wage[!idx]), lty = 2L,
            type = 'l', col = c('blue', 'red'), lwd = 2L, 
            add = is_monona, ylim = c(0, 1.05*ymx), 
            axes = FALSE, cex.main = .8)
    }, on = c('district', 'year')]
  payscales[this_dist, {
    idx = highest_degree == 4L
    lines(tenure[idx], wage[idx], col = 'blue', lwd = 2L)
    lines(tenure[!idx], wage[!idx], col = 'red', lwd = 2L)
  }, on = c('district', 'year')]
  teachers[this_dist, {
    points(total_exp_floor, salary, 
           col = ifelse(highest_degree == 4, 'blue', 'red'))
  }, on = c('district', 'year')]
  if (ii == 1L) mtext('Salary ($)', side = 2L, line = 4)
  if (ii == 2L) mtext('Tenure (Years)', side = 1L, line = 3)
  mtext(this_dist[ , sprintf('%s, %d', district_name, year)],
        side = 3L, line = 0, cex = .6)
  tile.axes(ii, 1, 3, parm)
  box()
}
title('Data-Derived Tenure-Wage Curves vs. True Schedules', 
      outer = TRUE, cex.main = 1.5)
err = payscales[true_sched, x.wage - i.wage,
                on = c('district', 'year', 'highest_degree', 'tenure')]
mean_abs_dev = mean(abs(err))
median_dev = median(err)
```

As seen in Figure \ref{fig:true_fit}, the resulting fit is generally superb[^objective]. Only for the Bachelor's track in Monona Grove in 2009 does the COBS-fit curve depart substantially from the true contracted schedule. Moreover, this departure is likely attributable to the oversimplification taken in this paper of restricting pay to follow only two "lanes" (Bachelor's and Master's degrees), when in reality districts often differentiate among holders of these degrees by rewarding those with more credit-hours of supplementary coursework under their belts in pursuit of continued learning or a higher degree -- in fact, such coursework is often required of Bachelor's-certified teachers, which means it is likely that the later-career Bachelor-certified teachers observed in Monona Grove are actually being paid according to a higher lane. This is exactly what is depicted by the gray lines on the Monona Grove plot, which show the BA+12 and BA+24 lanes are more representative of instructors at the later stages of their career in Monona Grove (the data lack any way of detecting a given teacher's extracurricular credit accumulation). 

[^objective]: In terms of objective measures of the fit, the mean absolute error is `r dol.form(mean_abs_dev, tex = TRUE)`, while the overall median error is `r dol.form(median_dev, tex = TRUE)`. This is evidence against the assumption built into the COBS routine of 0-median errors $\varepsilon_{i, t}$, and is understandable -- it is not uncommon for teachers to earn supplementary pay from coaching or extra teaching duties that would push them above their salary-schedule-dictated pay grade. With a more complete set of training data, one could potentially account for this by treating the quantile of the data targeted by COBS (.5 by default, i.e., COBS is median-targeted) as a hyperparameter to be fit by cross-validation to prevent overfitting [see @stone or @friedman].

We take the above as strongly affirming the utility of COBS as a tool for constructing wage-tenure curves from teacher-level salary data. It is able to gloss over  noise-induced non-monotonicities in the empirical median, not just with the rich data found in urban districts, but also in sparsely-populated districts. Moreover, as explored in the case of Monona Grove School District, COBS can be seen as doing a good job of capturing an aspect of the data which is still latent (namely, the degree of progress towards further certification), and of being closer to the "true" schedules that teachers use to make mobility decisions (since it is likely that teachers are able to anticipate extra income from holding multiple roles and factor this into their assessment of a wage offer). Lastly, the COBS routine is computationally attractive -- embarassingly parallelizable and implemented very efficiently, the whole routine runs in a few minutes.

# Turnover in Wisconsin

```{r table_1_move_by_exp, results = 'asis', message = FALSE}
T1 = rbind(
  teachers[ , .(`Remain in Same School` =
                  100*sum(!move_school_next & !quit_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 
                  100*sum(quit_next)/.N,
                `Number of Teachers` = pn(.N)),
            keyby = .(`Teacher Experience` = exp_split)],
  teachers[ , .(`Teacher Experience` = 'All',
                `Remain in Same School` = 
                  100*sum(!move_school_next & !quit_next)/.N,
                `Change Schools Within District` = 
                  100*sum(move_within_next)/.N,
                `Switch Districts` = 100*sum(move_district_next)/.N,
                `Exit Wisconsin \\mbox{Public Schools}` = 
                  100*sum(quit_next)/.N,
                `Number of Teachers` = pn(.N))])

n_retd = 
  5*round(T1[`Teacher Experience` == '>30 years'][[grep('Exit', names(T1))]]/5)

suppressWarnings(
  tbl <- capture.output(print(xtable(
    T1, caption =
      paste0('Year-to-year Transitions of Teachers by Experience, ',
             incl_rng[1L], '-', incl_rng[2L] %% 100), 
    label = 'tbl:move_by_exp', digits = 1L, 
    align = paste0('lp{.12\\linewidth}p{.14\\linewidth}',
                   'p{.17\\linewidth}p{.10\\linewidth}',
                   'p{.17\\linewidth}R{.13}')),
    sanitize.text.function = identity))
)
idx = grep('^Teacher', tbl) - 1L
tbl = c(tbl[1L:idx], 
        ' & \\multicolumn{4}{c}{Percent of Teachers Who} & \\\\ \\cline{2-5}',
        tbl[(idx + 1L):length(tbl)])
cat(tbl, sep = '\n')

quit_rates = teachers[, mean(quit_next), keyby = total_exp_floor]
new_quits = quit_rates[total_exp_floor == 1, V1]
mid_quits = quit_rates[total_exp_floor %between% c(10, 20), mean(V1)]

n_exo_switch = 
  teachers[(year == 2009 & district %chin% c('2205', '4242') & 
              district_next == '1071') |
             (year == 2010 & district %chin% c('6410', '1078') & 
                district_next == '1080') | 
             (year == 2006 & district %chin% c('5061', '5075') & 
                district_next == '5780'), .N]
# code to produce plot of quits by experience level, with
#   bootstrapped confidence intervals:
# x = teachers[total_exp_floor <= 40]
# setkey(x, teacher_id)
# IDs = unique(x$teacher_id)
# 
# bs = rbindlist(replicate(5000, x[.(sample(IDs, replace = TRUE)), 
#                                  mean(quit_next),
#                                  keyby = total_exp_floor],
#                          simplify = FALSE))
# 
# Y = merge(x[, mean(quit_next), keyby = total_exp_floor],
#           bs[ , as.list(quantile(V1, c(.025, .975))), keyby = total_exp_floor],
#           by = 'total_exp_floor')
# Y[ , matplot(total_exp_floor, .SD[ , !"total_exp_floor"])]

# code to produce indicator for exogenous moves
#   induced by charter closures -- less than 200
#   such moves in total, and the source schools
#   are too small to have been fit with COBS,
#   so we salary effects can't be seen analogously
# library(readxl)
# closures = 
#   read_excel(paste0('/media/data_drive/wisconsin/charter_schools/',
#                     'charter_closures_report.xls'), skip = 2L, 
#              col_names = c('sch_year', 'cesa', 'district', 'authorizer',
#                            'school', 'school_name', 'grades_served',
#                            'year_closed', 'closure_reason'))
# setDT(closures)
# 
# closures = closures[!grepl('no longer charter status', closure_reason)]
# #this school appears to have lose its charter status,
# #  see correspondence with Latoya Holiday Apr. 21, 2017
# closures = closures[!(district == '3619' & school == '0419')]
# 
# closures[ , year := as.integer(gsub('^([0-9]{4}).*', '\\1', sch_year)) + 1L]
# 
# teachers[closures, exogenous_switch := TRUE,
#          on = c('year', 'district', 'school')]
```

We move now to the core focus of our analysis, examining the distinguishing features of turnover in the teacher labor market in Wisconsin. Table \ref{tbl:move_by_exp} replicates Table 1 of @hanushek, and as HKR found in Texas, most turnover in Wisconsin is happening within districts and out of the profession[^cite_pkg]\textsuperscript{,}[^exo_switch]. In Wisconsin, the fraction of teachers transitioning among districts is vanishingly small after a "burn-in" period of roughly 6 years -- only `r round(100*teachers[total_exp_floor >= 7, mean(move_district_next)], 1)`% of such teachers do so (compared with `r round((4.5*75284 + 2.5*165873 + 0.7*6978)/(75284+165873+6978), 1)`% for the comparable group in HKR), but is still relatively highest among the youngest teachers -- roughly twice as high for the "probationary" teachers (1-3 years' experience) as for teachers with 7-11 years' experience in both states.

[^cite_pkg]: This and subsequent analyses were greatly facilitated by several facilities of the R programming language, for which due credit must be given to @r, @rstudio, @dowle, @xie, @leifeld, @dahl, @henningsen, @zeileis2002, @zeileis2004, @zeileis2006 and @croissant.

[^exo_switch]: We also note that some "turnover" identified by teachers not appearing at the same school in the following year is in fact spurious -- @dpi_name_change identifies a number of instances of school districts merging during the timeframe of our analysis and hence disappearing from the data altogether. We take care to reset the district and school switch identifiers off for these `r n_exo_switch` teachers if they appear in the newly-formed district in the subsequent period. 

By contrast, movement patterns within districts in the two states are very similar, lending weight to teachers "earning their stripes" within a district to be able to choose the best schools as a privilege of seniority. As expected, we also observe a U-shaped pattern in teachers exiting Wisconsin public schools, which jibes with there being two types of quits. Early-career quitters change to private schools, change state of residence, or change professions; late-career quitters retire -- especially evident among teachers with more than 30 years' experience, a group which sees a mass exodus of fully `r n_retd` percent of its teachers annually. Results not included here break down the exit rates by experience level, where this dichotomy is even more dramatic -- first-year exit rates are about `r to.pct(new_quits, 0)` percent and quickly level off at around `r to.pct(mid_quits, 0)` percent before spiking again past around 25 years.

As examined further below, the low rate of switches between districts appears to be owing to the generally more rural nature of Wisconsin vis-à-vis. Texas. To wit, Milwaukee is the only major urban area in the state, and its population (2010 Census) of 594,833 would rank 7th in Texas. This means that two major types of movers in the HKR data -- Large Urban - Large Urban and Suburban - Large Urban -- are limited within the state to ending up in a relatively minor metropolitan area. HKR don't provide any results disaggregated by city, precluding any attempts to compare these numbers more comparably to those that would obtain from eliminating the largest cities in Texas.

```{r table_2_markov, results = 'asis'}
#** TO DO **
# - calculate distribution of distance moved between districts (esp. rural)
# - fix all table notes
share_change = 
  #use 2006, not incl_rng, because of the artificial change in 
  #  shares induced by the change in how urbanicity is calculated
  teachers[year %in% c(2000, 2006), .N, by = .(year, urbanicity_s)
           ][ , shr := N/sum(N), by = year
              ][order(year), .(delta = diff(shr)), by = urbanicity_s]
T2 = rbind(
  teachers[ , {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = pn(N_move), pct_origin = 100*N_move/.N,
           change_share = 
             share_change[.BY, sprintf('%.1f\\%%', 100*delta), 
                          on = 'urbanicity_s']))
  }, keyby = urbanicity_s],
  teachers[total_exp_floor <= 3, {
    idx = move_district_next
    N_move = sum(idx)
    c(as.list(table2(urbanicity_s_next[idx], prop = TRUE, pct = TRUE)),
      list(n_change = pn(N_move), pct_origin = 100*N_move/.N))
  }, keyby = urbanicity_s],
  fill = TRUE)
total_urban_moves =
  teachers[urbanicity_s %in% c('Large Urban', 'Small Urban'), 
           sum(move_district_next)]
rural_rural = T2[urbanicity_s == 'Rural', Rural[1L]]
r_r_msg = if(rural_rural>60) '60%' else 'MAJOR DATA CHANGE FLAG'

setnames(T2, grep('[^y]_', names(T2)), character(3L))
T2[ , c('Origin Community', 'urbanicity_s') :=
      .(paste0('\\quad ', urbanicity_s), NULL)]
setcolorder(T2, c(ncol(T2), seq_len(ncol(T2) - 1L)))

tbl = capture.output(print(xtable(
  T2, caption = paste('Destination Community Type for Teachers',
                      'Changing Districts, by Origin Community',
                      'Type and Teacher Experience Level'),
  label = 'tbl:markov', digits = 1L, align = 'llrrrrrrr'),
  sanitize.text.function = identity, floating.environment = 'sidewaystable'))
idx = grep('^Origin', tbl)
mrow = function(x, n) paste0('\\multirow{', n, '}{*}{', x, '}')
mcol = function(x, n) paste0('\\multicolumn{', n, '}{c}{', x, '}')
pbox = function(x, p) paste0('\\parbox{', p, '\\linewidth}{', x, '}')
tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol(mrow('Percent of Teachers Who Move to', 2), 4),
                     mrow(pbox('Number Teachers Changing Districts', .09), 4),
                     mrow(pbox('Percent of Origin Teachers', .07), 4),
                     mrow(pbox('Change in Share of Teachers 2000-06', .09), 4), 
                     sep = ' & '), '\\\\'),
        ' & \\multicolumn{4}{c}{} & & & \\\\ \\cline{2-5}',
        '& & & & & & & \\\\', tbl[idx + 0L:1L],
        'I. All teachers & & & & & & & \\\\', tbl[idx + (2L:5L)], 
        '\\multicolumn{3}{l}{II. Probationary teachers ' %+% 
          '(1-3 years experience)}' %+%
          ' & & & & & \\\\', tbl[(idx+6L):length(tbl)])
cat(tbl, sep = '\n')

#What percent of teachers starting in Large Urban districts
#  ever work at a Suburban district?
pct_ever_go_suburban = 
  #similar if check Large Urban on first 3 schools
  teachers[order(year), if (urbanicity_d[1L] == 'Large Urban')
    urbanicity_d[-1L], by = teacher_id
    ][ , any(V1 == 'Suburban', na.rm = TRUE),
       by = teacher_id][ , mean(V1)]

suburban_new_hires = teachers[urbanicity_s == 'Suburban',
                              sum(total_exp_floor == 1L)]
mwk_net = 
  teachers[(move_district_next),
           sum(district_next == '3619') - 
             sum(district == '3619')]
#Madison, Elmbrook, Waukesha, Waunakee, Oconomowoc
attractive = c('3269', '0714', '6174', '6181', '4060')
attr_net = 
    teachers[(move_district_next),
           sum(district_next %chin% attractive) - 
             sum(district %chin% attractive)]
# Re: Hanushek comment "Urban teachers equally likely as suburban teachers
#   to remain in the same school", consult:
# teachers[grep('Urban', urbanicity_s), mean(stay_next & !move_within_next)]
# teachers[grep('Suburban', urbanicity_s), mean(stay_next & !move_within_next)]
# Re: Hanushek comment "Urban teachers ~ 10% more likely to quit", consult:
# teachers[grep('Urban', urbanicity_s), mean(quit_next)]
# teachers[grep('Suburban', urbanicity_s), mean(quit_next)]

# #most/least "attractive" districts (by net in/outflow)
# arr = 
#   teachers[(move_district_next & !grepl('^[79]', district_next)), 
#            .(arrivals = .N), keyby = district_next]
# dep = 
#   teachers[(move_district_next), .(exits = .N), by = district]
# 
# arrdep = merge(arr, dep, by.x = 'district_next', by.y = 'district', all = TRUE)
#       
# arrdep[is.na(arrivals), arrivals := 0]
# arrdep[is.na(exits), exits := 0]
# arrdep[ , net_flow := arrivals - exits]
```

Moving from the aggregate numbers to begin to examine heterogeneity in turnover, Table \ref{tbl:markov} replicates HKR Table 2, and reverberates its most important conclusions. HKR argue that there is little support for the idea that scores of young teachers are using large urban schools as a training ground before "settling down" with easier assignments in the suburb, based on the general low level of turnover from Large Urban districts. We affirm the scarcity of transitions from districts in Milwaukee, while also noting that such a path is certainly present, as evidenced by the plurality of those who do leave Large Urban districts ending up in a Surburban district in both settings. HKR also observe that the likelihoods of remaining in the same school and of quitting are roughly the same for urban and suburban teachers, an observation which we can confirm in Wisconsin. We further note that while Table \ref{tbl:markov} only presents a cross-sectional picture, the career-long trend reaffirms this -- only `r to.pct(pct_ever_go_suburban, 1L)`% of teachers starting their careers at a large urban district ever work at a suburban district. Lastly, we echo the suggestion of HKR that this phenomenon cannot be driven purely by demand-side constraints -- in our time period of observation, we observe only `r pn(total_urban_moves)` urban teachers change districts, whereas `r pn(suburban_new_hires)` teachers were hired in suburban districts, though of course this does not rule out arguments based for example on stricter screening of applicants transferring from urban districts. 

We note, however, that though tales of flight from troubled urban districts are apparently anecdotal, they are far from apocryphal. To wit, while 50 percent of districts have a net inflow (arrivals less departures) of four or fewer teachers (in absolute value), Milwaukee's net outflow was `r abs(mwk_net)` teachers, and the five highest-inflow districts, all suburbs of Milwaukee or districts adjacent the main university town of Madison, saw in total an inflow of `r attr_net` teachers in this time. This being a two-sided market, this state of affairs is perhaps largely attributable to the dynamic nature of student populations at these districts -- but these, as well, are reflective of the appeal of the districts to parents (and teachers as parents).

```{r tx_wi_urb_dist, fig.cap = '\\label{fig:ti_wi_urb}Comparison of the Prevalence of Different Community Types'}
wi_ti[ , plot(table(State, `Community Type`), las = 1L,
              color = c('red', 'blue', 'darkgreen', 'lavender'),
              main = 'Urbanicity in Texas and Wisconsin, 2010')]
wi_pct_districts_nonurb = 
  wi_ti[State == 'Wisconsin', mean(`Community Type` %in% 
                              c('Rural', 'Suburban'), na.rm = TRUE)]
```


As mentioned in the discussion of Table \ref{tbl:move_by_exp}, the major difference with respect to quantities observed in Texas appears to be driven by differences in the urban landscape between Texas and Wisconsin[^share_shift]. This is supported by the overall similarity of magnitudes of transition rates to community types besides Large Urban in the two papers. Figure \ref{fig:ti_wi_urb} depicts this difference in landscape by comparing the distribution of community types in Texas and Wisconsin in 2010 (bar widths reflect the relative quantity of districts in Texas and Wisconsin). While both states are majority-rural, the non-rural part of Texas is comparatively urbanized, whereas more than `r to.pct(wi_pct_districts_nonurb, -1)`% of Wisconsin districts are non-urban.

Returning to Table \ref{tbl:markov}, we see that, as in HKR, the "stickiest" community type is Rural -- over `r r_r_msg` of Rural teachers remain Rural in both papers, and even fewer Rural Wisconsin teachers end up in a big city than is the case for Texas. This may reflect the similarity in prevalence of rural districts in the two states and a natural similarity in preferences of rural teachers and districts. Lastly, we also find that the community type transition patterns of younger teachers as compared to all teachers are broadly similar.

[^share_shift]: We also note a difference (as found in Table \ref{tbl:markov}) in the relative shift in population among community types between the two states -- Texas observed dramatic changes in its community type distribution over the period of study of only 4 years, while Wisconsin only saw some movement from Rural to Suburban communities over a longer period of `r diff(incl_rng) + 1` years.

```{r table_3_change_by_ge, results = 'asis'}
#** TO DO **
# - subset to years with scale scores available, use this instead
#   Use aggregated distribution? Possible to construct
#     population moments from school-level data?
# - explore _why_ differential wages become more important with experience;
#    : ignoring certification? breaking down results by
#      certification shows the patterns consistent, but _could_ in
#      principal be related to the residual wages themselves picking up
#      unexpected patterns by ignoring certification.
#    : plot distribution of change in wage vs. tenure
#      very weak evidence for influence of skew; nevertheless ever-so-slight
#      positive trend emerges w.r.t. experience
se = function(x) sd(x)/sqrt(length(x))
T3 = 
  teachers[move_district_next & total_exp_floor <= 10, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean), sapply(dl, se))))
  }, keyby = .(exp_split, gender)
  ][ , dcast(.SD, var ~ gender + exp_split, value.var = 'val')]
T3[ , all := 
      teachers[move_district_next & total_exp_floor <= 10, {
        dl = lapply(
          list(schedule_lsalary_next - schedule_lsalary_next_cf,
               schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
               pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
               pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
          na.omit)
        c(rbind(sapply(dl, mean), sapply(dl, se)))}]]

avg_premium = 
  teachers[(move_district_next), 
           mean(exp(schedule_lsalary_next) - 
                  exp(schedule_lsalary_next_cf), na.rm = TRUE)]

avg_premium_rel = 
  teachers[(move_district_next), 
           mean(exp(schedule_lsalary_next)/
                  exp(schedule_lsalary_next_cf), na.rm = TRUE)]

m_del_prem = diff(unlist(
  T3[var == '1M', grep('M.*(3|11)', names(T3)), with = FALSE]
))
f_del_prem = diff(unlist(
  T3[var == '1M', grep('F.*(3|11)', names(T3)), with = FALSE]
))
prem_trend_msg = if (m_del_prem < 0 || f_del_prem < 0) 
  'MAJOR DATA CHANGE FLAG' else ''

mid_career_premium = 
  teachers[move_district_next & total_exp_floor %between% c(4, 11),
           mean(schedule_lsalary_resid_next - 
                  schedule_lsalary_resid_next_cf, na.rm = TRUE)]

adj_wage_coef = T3[var == '2M', all]
prof_coefs = unlist(T3[var == '3M', !'var'])
prof_coefs_m = prof_coefs[grep('^M', names(prof_coefs))]
prof_coefs_f = prof_coefs[grep('^F', names(prof_coefs))]
pct_prof_coef = prof_coefs['all']
pct_prof_msg = if (any(prof_coefs_f < prof_coefs_m) ||
                   any(prof_coefs_m[1L] < prof_coefs_m[-1L]) ||
                   any(prof_coefs_f[1L] < prof_coefs_f[-1L]))
  'MAJOR DATA CHANGE FLAG' else ''
                   
pct_black_coef = T3[var == '5M', all]
pct_frl_coef = T3[var == '6M', all]

var_explained = 
  teachers[ , var(schedule_lsalary_pred, na.rm = TRUE)/
              var(schedule_lsalary, na.rm = TRUE)]
var_explained_msg = if (var_explained <= .7) 'MAJOR DATA CHANGE FLAG' else ''

T3[ , var := rep(c('Base year salary (log)', 
                   'Adjusted salary\\textsuperscript{a} (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3), c('var', 'type'))
sidx = T3$type == 's'
pidx = grepl('^Percent', T3$var)
T3[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f\\%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f\\%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3[type == 's', var := '']
T3[ , type := NULL]
setnames(T3, c('', rep(exp_lab[1L:3L], 2L), ''))

tbl = capture.output(print(xtable(
  T3, caption = paste('Average Change in Salary and District Student',
                      'Characteristics (and Standard Deviations) for',
                      'Teachers Changing Districts, by Gender and Experience'),
  label = 'tbl:change_by_ge', align = 'llccccccc'), 
  floating.environment = 'sidewaystable', sanitize.text.function = identity))

idx = grep('years', tbl)
idx2 = grep('\\end{tabular}', tbl, fixed = TRUE)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Men by Experience Class', 3L),
                     mcol('Women by Experience Class', 3L),
                     mrow(pbox('All Teachers 0-9 Years', .1), 2L),
                     sep = ' & '), '\\\\ \\cline{2-4} \\cline{5-7}'),
        tbl[idx:(idx2 - 1L)],
        paste0(mcol(pbox(paste(
          '\\scriptsize{Note: a. Adjusted salary is the',
          'residual of log salary by district and experience',
          'level on', teachers[ , uniqueN(cesa)], 
          'regional indicators, three urbanicity indicators,',
          'and the district percentages proficient on the WKCE',
          'exam, black, Hispanic, and low income.}'
          ), .85), 8L), '\\\\'),
        tbl[idx2:length(tbl)])

cat(tbl, sep = '\n')
# code to bootstrap adjusted salary SEs
# tids = teachers[ , unique(teacher_id)]
# boot_dist = rbindlist(lapply(integer(5000), function(...) {
#   DT = teachers[.(sample(tids, replace = TRUE))]
#   DS = payscales[district %in% DT[ , unique(district)]])
#   DS[ , lwage_resid := {
#     resid(lm(log(wage) ~ cesa + urbanicity + pct_prof + 
#                pct_black + pct_hisp + pct_frl))
#   }, by = .(highest_degree, tenure)]
#   DT[DS, schedule_lsalary_resid := i.lwage_resid,
#      on = c('year', 'district', 
#             total_exp_floor = 'tenure', 'highest_degree')]
#   DT[order(year), schedule_lsalary_resid_next := 
#        shift(schedule_lsalary_resid, n = 1L, type = 'lead'), 
#      by = teacher_id]
#   DT[DS[ , .(year = year - 1L, district, 
#              tenure = tenure - 1L, highest_degree, 
#              lwage, lwage_pred, lwage_resid)], 
#      schedule_lsalary_resid_next_cf := i.lwage_resid,
#      on = c('year', 'district', 
#             total_exp_floor = 'tenure', 'highest_degree')]
#   DT[move_district_next & total_exp_floor <= 10,
#      mean(schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
#           na.rm = TRUE), keyby = .(exp_split, gender)]
# }), idcol = 'bb')
#with output:
# boot_dist[ , sd(V1), by = .(exp_split, gender)]
#     exp_split gender          V1
# 1:  1-3 years      M 0.005152039
# 2:  1-3 years      F 0.002977234
# 3:  4-6 years      M 0.006794788
# 4:  4-6 years      F 0.003923421
# 5: 7-11 years      M 0.007791188
# 6: 7-11 years      F 0.006181071

# code for distribution of Delta residual wage by experience
# teachers[move_district_next & total_exp_floor <= 10, {
#   boxplot(schedule_lsalary_resid_next - 
#             schedule_lsalary_resid_next_cf ~ total_exp_floor)
#   abline(h = 0, lty = 2)}]
```

Table \ref{tbl:change_by_ge} replicates Table 3 of HKR, and again confirms its most important insights. Raw salary differentials predict teacher mobility, but the average pay differential is not on average very large -- only about `r dol.form(25*round(avg_premium/25), tex = TRUE)`, or `r to.pct(avg_premium_rel - 1, 1)`% higher than the counterfactually expected wage that would have obtained had the district-switching teacher remained in their current district[^multi_year]. This premium `r prem_trend_msg`increases with age for both male and female teachers.

[^multi_year]: There are `r pn(teachers[year_next - year > 1 & move_district_next, .N])` teachers in the data who skipped one or more years before reappearing at different school or district (perhaps representing leaves of absence for retraining or re-adjustment). For such teachers, the counterfactual subsequent experience and reference curves are taken from their next year in the data, rather than from simply incrementing their experience by one.

```{r potential_premium, fig.cap = '\\label{fig:premia}How Much Do Teachers Stand to Gain from Changing Districts throughout Their Careers?'}
payscales[ , {
  qs = quantile(wage, c(.1, .25, .4, .6, .75, .9))
  .(r9010 = qs['90%']/qs['10%'] - 1,
    r7525 = qs['75%']/qs['25%'] - 1,
    r6040 = qs['60%']/qs['40%'] - 1,
    d7525 = qs['75%'] - qs['25%'])
}, by = .(tenure, highest_degree)
][ , {
  avg_7525 <<- mean(r7525)
  #multiplying factor for discounting
  #  20 years at 10%
  dfact = (1-1.06^(-21))/(1-1.06^(-1))
  total_gain_ma <<- mean(d7525[highest_degree == 5]) * dfact
  dcast(.SD, tenure ~ highest_degree,
        value.var = c('r9010', 'r7525', 'r6040'))
}][ , {
  y = 100*.SD[ , !"tenure"]
  ba = grepl('_4$', names(y))
  par(oma = c(0, 0, 0, 3))
  matplot(tenure, y, lty = 1, type = 'l', lwd = 3,
          col = ifelse(ba, 'red', 'blue'), las = 1,
          ylim = c(0, 1.1*max(y)), xlab = 'Tenure',
          ylab = 'Available Wage Ratio',
          main = 'Potential Gains from Mobility')
  ys = unlist(y[.SD$tenure == 15, !ba, with = FALSE])
  text(15, ys, c('90-10 Ratio', '75-25 Ratio', '60-40 Ratio'),
       pos = 3L)
  usr = par('usr')[c(2L, 4L)]
  legend(usr[1L], usr[2L]/2, c('MA', 'BA'), lty = 1L,
         lwd = 3L, col = c('blue', 'red'), xpd = NA, 
         bty = 'n', yjust = .5)
}]
```

One potential explanation of the weakness of the wage results is that there simply is not sufficient heterogeneity among available contracts to generate mobility incentives. Figure \ref{fig:premia} demonstrates that this is not likely the case. No matter their current experience or certification level, a teacher in a district paying the 25th percentile of wages for that experience-certification cell would gain on average `r to.pct(avg_7525, 0)`% by changing to a district at the 75th percentile. Especially for younger teachers, this potential gain would accumulate annually to become a hefty sum over the course of the career -- discounting the average annual gain for Master's-certified teachers at 6% and adding over 20 years, this means roughly `r dol.form(total_gain_ma, dig = -4, tex = TRUE)` is on the table; results are more dramatic for teachers at districts further in the tails of the wage distribution.

Attempting to isolate the influence of district characteristics on wage effects, HKR suggest comparing the differential leverage of residual wages (the residuals being the unexplained part of a Mincer-type regression) to get a more focused estimate of the association between wages and mobility[^residual_ses]. We run a similar regression, but evaluate separate regressions not just for each level of experience, but also for each certification track. This leads to a boost in the overall fraction of explained variance from 60% cited by HKR to `r var_explained_msg``r to.pct(var_explained, 0)`% here; as in HKR, other included covariates are consistently significant, suggesting their strong independent correlation with salary levels.

[^residual_ses]: HKR mention they failed to adjust the standard errors associated with the adjusted wage differentials to account for the fact that they involve residuals from a regression. We explored accounting for this by bootstrapping the regression through resampling teachers and recalculating residuals, but little changes as a result, so we present the naive standard errors for simplicity.

Unlike HKR, we find the demographic-independent wage differentials to be no more important than the uncontrolled raw wages, with the predicted wage improvement amounting to `r to.pct(adj_wage_coef, 1L)`%. In further contrast to HKR, we find a positive relationship between experience and residual wage differentials, with mid-career district switchers experiencing roughly `r to.pct(mid_career_premium, 1)`% higher wages upon arrival to their new employer, by contrast to the null relationship for probationary teachers. This pattern is consistent across the dimension of certification which was ignored by HKR, suggesting the opposite result cannot be attributed to bias introduced by movement patterns of Bachelor's- vs. Master's-certified instructors.

Student demographic differentials are very important for predicting teacher turnover, a finding which held in Texas as it does in Wisconsin. Most distinguished in all experience classes and for both genders are changes in measures of student performance, student poverty and the percetnage of black students -- district switchers end up at schools with `r to.pct(pct_prof_coef, 0)`% more students at grade level overall, an effect which is `r pct_prof_msg`stronger for female teachers and for young teachers. They also end up on average with about `r to.pct(-pct_frl_coef, 0)`% fewer students (school-wide) eligible for subsidized lunch and `r to.pct(-pct_black_coef, 0)`% fewer black students. While this finding would need to be bolstered with experimental or quasi-experimental evidence, it hints at the potentially limited scope of teacher labor market policies intended to ameliorate teacher supply problems in hard-to-serve districts -- schools can much more easily exert influence over their compensation policies than they can dictate their student bodies, but the latter appears more efficacious [see @fulbeck and @glazerman]. 

```{r table_3_long_distance, results = 'asis'}
T3D = 
  teachers[move_district_next & total_exp_floor <= 10 & distance_moved > 50, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean), sapply(dl, se))))
  }, keyby = .(exp_split, gender)
  ][ , dcast(.SD, var ~ gender + exp_split, value.var = 'val')]
T3D[ , all := 
       teachers[move_district_next & total_exp_floor <= 10 & distance_moved > 50, {
         dl = lapply(
           list(schedule_lsalary_next - schedule_lsalary_next_cf,
                schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
                pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
                pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
           na.omit)
         c(rbind(sapply(dl, mean), sapply(dl, se)))}]]
adj_wage_coef = T3D[var == '2M', all]

T3D[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                    'Percent proficient', 'Percent Hispanic',
                    'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3D[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3D), c('var', 'type'))
sidx = T3D$type == 's'
pidx = grepl('^Percent', T3D$var)
T3D[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3D[type == 's', var := '']
T3D[ , type := NULL]
setnames(T3D, c('', rep(exp_lab[1L:3L], 2L), ''))

tbl = capture.output(print(xtable(
  T3D, caption = paste('Average Change in Salary and District Student',
                       'Characteristics (and Standard Deviations) for',
                       'Teachers Changing to a district more than 50',
                       'Miles Away, by Gender and Experience'),
  label = 'tbl:change_far_by_ge', align = 'llccccccc'), 
  floating.environment = 'sidewaystable'))

idx = grep('years', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Men by Experience Class', 3L),
                     mcol('Women by Experience Class', 3L),
                     mrow(pbox('All Teachers 0-9 Years', .1), 2L),
                     sep = ' & '), '\\\\ \\cline{2-4} \\cline{5-7}'),
        tbl[idx:length(tbl)])

cat(tbl, sep = '\n')

# #t-test of difference vs. table 3 among the young
# teachers[exp_split == '1-3 years' & move_district_next,
#          t.test(I(schedule_lsalary_next -
#                     schedule_lsalary_next_cf) ~ I(distance_moved > 50)),
#          by = gender]
# teachers[exp_split == '1-3 years' & move_district_next & distance_moved > 50,
#          t.test(I(schedule_lsalary_next -
#                     schedule_lsalary_next_cf) ~ gender)]
# #scatterplot of distance vs. differential
# teachers[(move_district_next), {
#   ldist = log10(distance_moved)
#   wdiff = schedule_lsalary_next - schedule_lsalary_next_cf
#   plot(ldist, wdiff)
#   abline(lm(wdiff ~ ldist), col = 'red')
# }]
```

## Long-Distance Moves

One major aspect of teacher mobility glossed over by HKR is geographic separation. A wide variety of frictions may be geospatially-related or -generated -- social and professional networks tend to be concentrated locally; there are typically substantial fixed costs involved in moving (real estate closing fees, moving expenses, etc.); preferences may depend on climate/geography; and so on. As a first pass at exploring how long-distance moves may differ in nature from those over short distances, we reproduce in Table \ref{tbl:change_far_by_ge} the analysis of Table \ref{tbl:change_by_ge} for only those moves where the distance between the origin and destination school exceeded 50 miles (a distance deemed sufficient to likely entail a physical move rather than simply an adjusted commute).

The preeminent distinction of long-distance moves is moderation -- all average demographic differentials moderate towards zero, suggesting a diminution of the importance of these aspects in this population. The noteworthy exception to this trend is among probationary teachers -- young males experience wage increases in an uprooting move, while young females experience  declines for long moves. More detailed data would be needed to explore the mechanism at work behind this observation (in particular, none of the differences -- male vs. female or short- vs. long-distance moves -- have $p$ values below .05), but one explanation is a higher willingness among bachelors to change scenery completely, while younger women may tend to be married and moving with their partners. In any case, the overall importance of wages in long-distance moves is close to zero, suggesting wage differentials are either of secondary or tertiary concern in the associated decision processes, or that there is unsufficient heterogeneity in wages at such distances to generate enough moves so motivated, though the case of young male teachers does weaken the latter explanation. 


## Supply and Demand for Subject Specialists

Another source of heterogeneity about which HKR have little to say is subject specialty. While it is true that all teachers on a given contract are typically paid  independently of the subject they teach, teaching a hard-to-staff subject should lead to more bargaining power in the labor market (as such teachers are less easily replaced), so we would expect such teachers to transition to more attractive positions upon moving. Fully accounting for the demand side of labor markets would bestow higher confidence in results which ultimately depend on the strategic interaction of the two sides.

We are aided in trying to explore this aspect of the teacher labor market by the public availability of annual technical reports from DPI about various aggregate indicators for the health of supply and demand for educators in Wisconsin [the last published edition is @fischer]. In addition to providing counts for the number of educators graduating from the in-state education programs broken down by subject area, the report uses a survey distributed to district administrators to give a score (based, for example, on the market tightness -- applications per vacancy) in each Cooperative Educational Service Agency (CESA, the administrative unit for districts between the school district and DPI) rating the need for educators in various subject areas, including those in our study sample, Math, Reading, and Elementary.

```{r table_3_subject, results = 'asis'}
T3A = 
  teachers[move_district_next & total_exp_floor <= 10 & highest_degree == 5L, {
    dl = lapply(
      list(schedule_lsalary_next - schedule_lsalary_next_cf,
           schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
           pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
           pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
      na.omit)
    .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
      val = c(rbind(sapply(dl, mean), sapply(dl, se))))
  }, keyby = .(exp_split, math = area == '0400')
  ][ , dcast(.SD, var ~ exp_split + math, value.var = 'val')]
T3A[teachers[move_district_next & total_exp_floor <= 10 & 
               highest_degree == 5L, {
  dl = lapply(
    list(schedule_lsalary_next - schedule_lsalary_next_cf,
         schedule_lsalary_resid_next - schedule_lsalary_resid_next_cf,
         pct_prof_next_d - pct_prof_d, pct_hisp_next_d - pct_hisp_d,
         pct_black_next_d - pct_black_d, pct_frl_next_d - pct_frl_d),
    na.omit)
  .(var = paste0(rep(seq_len(6L), each = 2L), rep(c('M', 'S'), 6L)),
    val = c(rbind(sapply(dl, mean), sapply(dl, se))))
}, keyby = .(math = area == '0400')
][ , dcast(.SD, var ~ math, value.var = 'val')],
c('all_nonmath', 'all_math') := .(i.FALSE, i.TRUE), on = 'var']

area_change_msg = T3A[ , {
  dsal = all_math[1L] - all_nonmath[1L]
  sesal = sqrt(all_math[2L]^2 + all_nonmath[2L]^2)
  drsal = all_math[3L] - all_nonmath[3L]
  sersal = sqrt(all_math[4L]^2 + all_nonmath[4L]^2)
  dprof = all_math[5L] - all_nonmath[5L]
  dfrl = all_math[11L] - all_nonmath[11L]
  if (dsal < 0 || drsal < 0 || dsal/sesal > 2 || 
      drsal/sersal > 2 || dprof > 0 || dfrl < 0)
    'MAJOR DATA CHANGE FLAG' else ''}]

T3A[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                    'Percent proficient', 'Percent Hispanic',
                    'Percent black', 'Percent subsidized lunch'), each = 2L)]
T3A[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T3A), c('var', 'type'))
sidx = T3A$type == 's'
pidx = grepl('^Percent', T3A$var)
T3A[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o}), .SDcols = cols]
T3A[type == 's', var := '']
T3A[ , type := NULL]
setnames(T3A, c('', rep(c('Non-Math', 'Math'), 4L)))

tbl = capture.output(print(xtable(
  T3A, caption = paste('Average Change in Salary and District Student',
                       'Characteristics (and Standard Deviations) for',
                       'Teachers with Master\'s Degrees Changing',
                       'Districts, by Subject Area and Experience'),
  label = 'tbl:change_area_by_ge', align = 'llcccccccc'), 
  floating.environment = 'sidewaystable'))

idx = grep('Non-Math', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol(exp_lab[1L], 2L), mcol(exp_lab[2L], 2L), 
                     mcol(exp_lab[3L], 2L), mcol('All', 2L),
                     sep = ' & '), 
               '\\\\ \\cline{2-3} \\cline{4-5} \\cline{6-7} \\cline{8-9}'),
        tbl[idx:length(tbl)])

cat(tbl, sep = '\n')
```

Both Reading and Elementary are chronically over-supplied throughout the state, whereas the demand for math teachers varies considerably. In a given year, the market tightness for the former two subjects is roughly twice that in Math (e.g., it was 67.43 for Elementary, 28.65 for English/Speech/Theater/Journalism, and 24.22 for Mathematics). As a result, we expect to see some heterogeneity in labor market success of specialists in Math as compared to the other teachers in our sample. Table \ref{tbl:change_area_by_ge} explores some of the basic insights on subject matter heterogeneity. To mitigate the potential for degree holdings to skew results, we focus on Master's holders and obfuscate gender differences for brevity. Actually, there is little `r area_change_msg`in this table to support the hypothesis that math teachers are given a substantial advantage in the labor market -- math teachers earn more (both in nominal and beyond-demographic pay), but this result is not significant. Further, English teachers are advantaged in ending up at less economically disadvantaged and higher-performing districts.

```{r table_4_change_by_urb, results = 'asis'}
#** TO DO **
# - How to express drop in %Black/Hispanic/FRL
#   RELATIVELY (i.e., accounting for the fact
#   that there are no minority/poor students outside MWK)
# #Code to get nominal vs. residual pay differential for Urban-Suburban
# #  switchers, _by highest_degree_
# teachers[move_district_next & urbanicity_next_d == 'Suburban' &
#            urbanicity_d == 'Large Urban' & total_exp_floor <= 10, {
#              dl = lapply(
#                list(schedule_lsalary_next - schedule_lsalary_next_cf,
#                     schedule_lsalary_resid_next -
#                       schedule_lsalary_resid_next_cf),
#                na.omit)
#              .(var = c('1M', '1S', '2M', '2S'),
#                val = c(rbind(sapply(dl, mean), sapply(dl, se))))
#            }, keyby = .(urbanicity_d, highest_degree)]
T4D = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(schedule_lsalary_next - schedule_lsalary_next_cf,
                      schedule_lsalary_resid_next -
                        schedule_lsalary_resid_next_cf,
                      pct_prof_next_d - pct_prof_d, 
                      pct_hisp_next_d - pct_hisp_d,
                      pct_black_next_d - pct_black_d, 
                      pct_frl_next_d - pct_frl_d),
                 na.omit)
               .(var = paste0(rep(seq_len(6L), each = 2L),
                              rep(c('M', 'S'), 6L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

lose_msg = if (!all(T4D[var %in% c('1M', '2M')]$`Large Urban` < 0))
  'MAJOR DATA CHANGE FLAG' else ''
lose_resid_msg = 
  if (T4D[ , `Large Urban`[var == '1M'] > `Large Urban`[var == '2M']])
    'MAJOR DATA CHANGE FLAG' else ''
lose_degree_msg = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' &
             urbanicity_d == 'Large Urban' & total_exp_floor <= 10, {
               p_nom = t.test(I(schedule_lsalary_next - 
                                  schedule_lsalary_next_cf) ~ 
                                highest_degree)$p.value
               p_res = t.test(I(schedule_lsalary_resid_next - 
                                  schedule_lsalary_resid_next_cf) ~ 
                                highest_degree)$p.value
               if (p_nom < .1 || p_res < .1) 'MAJOR DATA CHANGE FLAG' else ''}]
         
pct_prof_coef_d = T4D[var == '3M', `Large Urban`]
pct_black_coef_d = T4D[var == '5M', `Large Urban`]
pct_frl_coef_d = T4D[var == '6M', `Large Urban`]

T4S = 
  teachers[move_district_next & urbanicity_next_d == 'Suburban' & 
             urbanicity_d %in% c('Large Urban', 'Suburban') & 
             total_exp_floor <= 10, {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s,
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s,
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = paste0(rep(3L:6L, each = 2L), rep(c('M', 'S'), 4L)),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se))))
             }, keyby = urbanicity_d
           ][ , dcast(.SD, var ~ urbanicity_d, value.var = 'val')]

T4 = merge(T4D, T4S, by = 'var', all.x = TRUE)

T4[ , var := rep(c('Base year salary (log)', 'Adjusted salary (log)',
                   'Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch'), each = 2L)]
T4[ , type := rep(c('m', 's'), 6L)]
cols = setdiff(names(T4), c('var', 'type'))
sidx = T4$type == 's'
pidx = grepl('^Percent', T4$var)
T4[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[!pidx & !sidx] = sprintf('%.3f', x[!pidx & !sidx])
  o[!pidx & sidx] = sprintf('(%.3f)', x[!pidx & sidx])
  o[pidx & !sidx] = sprintf('%.1f\\%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f\\%%)', 100*x[pidx & sidx])
  o[is.na(x) & !sidx] = '---'
  o[is.na(x) & sidx] = ''
  o}), .SDcols = cols]
T4[type == 's', var := '']
T4[ , type := NULL]
T4[grepl('^Percent', var), var := paste('\\quad', var)]

suburban_black_msg10 = 
  if (districts[urbanicity == 'Suburban',
                mean(pct_black < .1, na.rm = TRUE) <= .85])
    'MAJOR DATA CHANGE FLAG' else ''
suburban_black_msg2 = 
  if (districts[urbanicity == 'Suburban',
                mean(pct_black < .02, na.rm = TRUE) <= .55])
    'MAJOR DATA CHANGE FLAG' else ''
pct_black_mwk = 
  districts[urbanicity == 'Large Urban',
            sum(n_students*pct_black, na.rm = TRUE)/
              sum(n_students, na.rm = TRUE)]
pct_frl_mwk = 
  districts[urbanicity == 'Large Urban',
            sum(n_students*pct_frl, na.rm = TRUE)/
              sum(n_students, na.rm = TRUE)]
pct_frl_suburb = 
  districts[urbanicity == 'Suburban',
           median(pct_frl, na.rm = TRUE)]

tbl = capture.output(print(xtable(
  T4, caption = paste('Average Change in Salary and in District and Campus',
                      'Student Characteristics (and Standard Deviations)',
                      'for Teachers with 1-10 Years of Experience Who',
                      'Change Districts, by Community Type of Origin',
                      'and Destination District'),
  label = 'tbl:change_by_urb', 
  align = paste0('llp{.135\\textwidth}p{.135\\textwidth}',
                 'p{.135\\textwidth}p{.135\\textwidth}')),
  sanitize.text.function = identity))

idx = grep('Urban', tbl) - 1L

tbl = c(tbl[1L:idx],
        paste0(paste(
          '', mcol(mrow(pbox('District Average Characteristics', .2), 2L), 2L),
          mcol(mrow(pbox('Campus Average Characteristics', .2), 2L), 2),
          sep = ' & '), '\\\\\n & & & & \\\\ \\cline{2-5}'),
        ' & Large Urban to Suburban & Suburban to Suburban & ' %+%
          'Large Urban to Suburban & Suburban to Suburban \\\\',
        tbl[(idx + 2L):length(tbl)])

idx = grep('quad', tbl)[1L] - 1L

tbl = c(tbl[1L:idx], 'Average Student Characteristics & & & & \\\\',
        tbl[(idx+1L):length(tbl)])

cat(tbl, sep = '\n')
```

Table \ref{tbl:change_by_urb}, which parallels Table 4 of HKR, again uncovers a labor market functioning similar to that in Texas. In particular, while HKR find Large Urban - Suburban district switchers penalize themselves in pay but are rewarded in demographic-adjusted pay, Wisconsin teachers `r lose_msg`lose out on both measures when leaving Large Urban districts, albeit the residual pay penalty is `r lose_resid_msg`much lower than that of nominal pay. This difference does not appear to be attributable to HKR's exclusion of certification as a conditioning variable, as the pattern here `r lose_degree_msg`differs insignificantly by degree.

The other results of HKR are confirmed in even more dramatic fashion. There is strong evidence of selection on the student performance metric, which does vary quite widely in suburban districts. Teachers leaving Milwaukee tend to end up at districts with `r to.pct(pct_prof_coef_d, 0)`% more students deemed to be at grade level on the state standardized test. On the other hand, teachers leaving Large Urban districts (i.e, Milwaukee) for the suburbs experience a precipitous drop of `r to.pct(-pct_black_coef_d, 0)`% black students and `r to.pct(-pct_frl_coef_d, 0)`% subsidized lunch eligibility. This is practically a tautological result, as the student demographics outside of urban areas in Wisconsin are pretty uniformly non-minority -- about `r suburban_black_msg10`90% of suburban districts have fewer than 10% black students, and about `r suburban_black_msg2`60% have fewer than 2% black students, whereas Milwaukee is about `r to.pct(pct_black_mwk, 0)`% black. Similarly, teachers leaving Milwaukee for the suburbs have little choice but to end up in a district with far fewer economically disadvantaged students -- whereas `r to.pct(pct_frl_mwk, 0)`% of Milwaukee students are eligible, the median percentage in suburban schools is `r to.pct(pct_frl_suburb, 0)`%. 

The direction of these effects are preserved among suburban-to-suburban moves, suggesting the importance of these factors even in areas where there is a wider array demographically of destination districts. We also find evidence of selection into economically better-off districts among suburban switchers, but the magnitude of this difference is attenuated with respect to that reported by HKR. We do not find patterns of selection on student performance as strongly as was found in HKR. This may be a reflection of the crudeness of the proficiency measure as compared to the more variable raw scale score measures used by HKR. Lastly, we confirm the finding of HKR that there does not appear to be evidence that teachers are able to select into the more desirable schools within their target districts -- the differences in campus-level characteristics are almost identical to the differences in district-level characteristics. This is likely a reflection of supply-side constraints, as the choicest appointments in a district may be awarded to long-serving serving teachers (promotion from within), as well as suburban districts perhaps having only a small number of schools at which to teach a given grade level/subject.

```{r table_5_change_by_eth, results = 'asis'}
T5D = 
  teachers[move_district_next & total_exp_floor <= 10 & 
             ethnicity_main %in% c('Black', 'Hispanic'), {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L),
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean), sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

T5S = 
  teachers[move_within_next & total_exp_floor <= 10, {
               dl = lapply(
                 list(pct_prof_next_s - pct_prof_s, 
                      pct_hisp_next_s - pct_hisp_s,
                      pct_black_next_s - pct_black_s, 
                      pct_frl_next_s - pct_frl_s),
                 na.omit)
               .(var = c(paste0(rep(1L:4L, each = 2L), 
                                rep(c('M', 'S'), 4L)), 'N'),
                 val = c(rbind(sapply(dl, mean),
                               sapply(dl, se)), .N))
             }, keyby = ethnicity_main
           ][ , dcast(.SD, var ~ ethnicity_main, value.var = 'val')]

white_s = T5S[-.N, White]
black_s = T5S[-.N, Black]
z_scores = function(x) {
  odd = seq(1L, length(x), by = 2L)
  x[odd]/x[-odd]
}
white_v_black_msg =
  if (!identical(which(abs(z_scores(white_s)) > 2), c(1L, 3L, 4L)) | 
      !identical(which(abs(z_scores(black_s)) > 2), c(1L, 4L)))
    'MAJOR DATA CHANGE FLAG' else ''

T5S = T5S[ , !'White']

T5 = merge(T5D, T5S, by = 'var', all.x = TRUE)

T5[ , var := rep(c('Percent proficient', 'Percent Hispanic',
                   'Percent black', 'Percent subsidized lunch',
                   'Number of teachers'), c(2L, 2L, 2L, 2L, 1L))]
T5[ , type := c(rep(c('m', 's'), 4L), 'n')]
cols = setdiff(names(T5), c('var', 'type'))
sidx = T5$type == 's'
pidx = grepl('^Percent', T5$var)
nidx = T5$type == 'n'
T5[ , (cols) := lapply(.SD, function(x) {
  o = character(length(x))
  o[pidx & !sidx] = sprintf('%.1f%%', 100*x[pidx & !sidx])
  o[pidx & sidx] = sprintf('(%.1f%%)', 100*x[pidx & sidx])
  o[nidx] = pn(x[nidx])
  o}), .SDcols = cols]
T5[type == 's', var := '']
T5[ , type := NULL]

invisible(
  teachers[ , .(eth = ethnicity_main[1L], prof = pct_prof_d[1L],
                frl = pct_frl_d[1L]), by = teacher_id
            ][ , {
              blk = eth == 'Black'
              wht = eth == 'White'
              med_init_prof_black <<- median(prof[blk], na.rm = TRUE)
              med_init_prof_white <<- median(prof[wht], na.rm = TRUE)
              med_init_frl_black <<- median(frl[blk], na.rm = TRUE)
              med_init_frl_white <<- median(frl[wht], na.rm = TRUE)}]
)

tbl = capture.output(print(xtable(
  T5, caption = paste('Average Change in District and Campus Student',
                      'Characteristics (and Standard Deviations)',
                      'for Black and Hispanic Teachers with 1-10',
                      'Years of Experience who Change Campuses'),
  label = 'tbl:change_by_eth', 
  align = paste0('llp{.1\\textwidth}p{.1\\textwidth}',
                 'p{.1\\textwidth}p{.1\\textwidth}'))))

idx = grep('Black.x', tbl)

tbl = c(tbl[1L:(idx - 1L)],
        paste0(paste('', mcol('Between District Moves', 2L),
                     mcol('Within District Moves', 2L),
                     sep = ' & '), '\\\\ \\cline{2-5}'),
        ' & Black Teachers & Hispanic Teachers & ' %+%
          'Black Teachers & Hispanic Teachers \\\\',
        tbl[(idx + 1L):length(tbl)])

cat(tbl, sep = '\n')
```

HKR examine the state of Texas, which features substantially more ethnic heterogeneity than does Wisconsin. As a result, they are better-equipped to identify heterogeneity in preferences by teacher ethnicity. In Wisconsin, however, only `r teachers[ethnicity_main %in% c('Black', 'Hispanic'), pn(uniqueN(teacher_id))]` of the `r teachers[ , pn(uniqueN(teacher_id))]` teachers are non-white, so our results are underpowered relative to HKR. For completeness, Table \ref{tbl:change_by_eth} presents these results, which parallel HKR Table 5. Given how few observations we have of black or Hispanic teachers switching districts, we eschew any temptation to interpret these results. Only black switchers within districts provide enough records to interpret meaningfully. In Wisconsin, we find that`r white_v_black_msg`, in contrast to white within-district switchers, black teachers tend to migrate to economically better-off and higher-performing schools (white teachers also select on percentage of black students). This could simply be a reflection of differences in initial district choice by black vis-à-vis white teachers -- the median proficiency at a black teacher's first district is `r to.pct(med_init_prof_black, 0)`%, compared to `r to.pct(med_init_prof_white, 0)`% for white teachers (`r to.pct(med_init_frl_black, 0)`% and `r to.pct(med_init_frl_white, 0)`% for reduced lunch eligibility, respectively).

```{r table_6_change_by_quartile, results = 'asis'}
#** TO DO **
# - weight by SCHOOL not DISTRICT size (?)
# - HKR suggested they would have like to use
#   student body size for weighting instead of
#   teacher workforce size; investigate doing so
# - ? include residual salary rows for within-district
#   movers (should in principal all show up null, but
#   could reveal confounding effects that are likely
#   to be present elsewhere in the table -- use
#   as a motivation, or is it just distraction?)
# - Why do teachers in lowest-FRL districts move
#   more often than those in highest-FRL districts?
#   : teachers[pct_frl_d > 0, mean(move_district_next), 
#              keyby = .(cut(pct_frl_d, breaks = 0:20/20))
#              ][ , plot(1:19/20, V1)]
#     ^ just noise? ^
# - for Hanushek/Rivkin -- is Table 6 also restricted
#   to younger teachers??
# - how much is Milwaukee alone driving some of these results?
#    * idem Kenosha (erroneous year of data)
T6 = 
  melt(teachers, id.vars = c('year', 'move_district_next', 
                             'move_within_next', 'quit_next'), 
       measure.vars = paste0(q_var, '_q'), na.rm = TRUE, value.factor = TRUE
       )[ , .(`Probability Teachers Move to New School within District` = 
                mean(move_within_next),
              `Probability Teachers Move to New District` = 
                mean(move_district_next),
              `Probability Teachers Exit Public Schools` = 
                mean(quit_next)), 
          keyby = .(variable, value)]


resid_lo_hi_ratio = 
  T6[variable == 'lwage_resid_avg_q', {
    v = get(grep('New District', names(T6), value = TRUE, fixed = TRUE))
    v[value == 'Lowest']/v[value == 'Highest']}]
pct_prof_lo_hi_ratio = 
  T6[variable == 'pct_prof_q', {
    v = get(grep('Exit', names(T6), value = TRUE, fixed = TRUE))
    v[value == 'Highest']/v[value == 'Lowest']}]
     
T6[variable == 'lwage_resid_avg_q', grep('within', names(T6)) := NA]
T6[ , variable := NULL]
cols = grep('^Prob', names(T6))
T6[ , (cols) := lapply(.SD, function(x) {
  o = sprintf('%.1f\\%%', 100*x)
  is.na(o) = is.na(x); o}), .SDcols = cols]
T6[ , value := paste0('\\quad ', value)]
setnames(T6, 'value', 'Quartile of Distribution')

tbl = capture.output(print(xtable(
  T6, caption = paste('School Average Transition Rates by Distribution of',
                      'Residual Teacher Salary and Student Demographic',
                      'Characteristics (data weighted by number of',
                      'teachers in school)'),
  label = 'tbl:change_by_quartile',
  align = 'lp{.3\\textwidth}p{.15\\textwidth}p{.15\\textwidth}p{.15\\textwidth}'), 
  sanitize.text.function = identity, NA.string = '---'))

idx = grep('Highest', tbl)
tbl[idx] = paste0(c('Residual salary', 'Percent proficient',
                    'Percent eligible for reduced-price lunch',
                    'Percent Black', 'Percent Hispanic'),
                  ' & & & \\\\\n', tbl[idx])
cat(tbl, sep = '\n')
```

To the end of examining heterogeneity in the impact of school and district characteristic differentials on teacher mobility, HKR present their Table 6, which breaks down the three exit rates for each (weighted) quartile of the covariate distribution. We replicate that analysis here in Table \ref{tbl:change_by_quartile}. Saliently, our results for the correlation of school characteristics for within-district movers are qualitatively identical to those found in Texas and similar in magnitude, which gives a stronger indication that we have identified some fundamental nonpecuniary mechanisms driving sorting among schools in a district.

Differences with respect to the results in Texas begin to emerge for the other destinations of school leavers (other districts and other professions). As noted in Table \ref{tbl:move_by_exp}, overall rates of switching districts are quite low compared to Texas and national averages; conditional on this, the patterns of movement by quartile of residual salary exhibit a similar pattern to that in Texas, with teachers in the lowest quartile about `r to.pct(resid_lo_hi_ratio - 1, 0)`% more likely to change districts than teachers in the highest residual pay quartile.  By contrast to HKR, however, who found the opposite association, we find the same trend (at attenuated magnitudes) with respect to leaving Wisconsin public schools, suggesting salary considerations are also important for teachers considering options outside of public school teaching (or in other states).

We also find fairly strong patterns in quitting associated with subsidized lunch eligibility and with the ethnic makeup of schools, with teachers at the most economically advantaged schools `r to.pct(1-pct_prof_lo_hi_ratio, 0)`% less likely to exit teaching; similar numbers obtain for both the quantity of black and of Hispanic students. For teachers moving within districts, we observe similar patterns.

## Regression Results

```{r table_7_reg_lpm, results = 'asis', cache = TRUE}
#** TO DO **
# - don't use first-year base salary (HKR didn't
#   because they only estimated schedule for
#   experience 1 - 10, but run these regressions
#   for all experience classes)
# - check units of coefficients
# - missingness biasing results substantially?
# - HKR claim there's insufficient variation in
#   their data to separately identify gradients
#   in growth rate from base levels of growth;
#   explore whether that's possible here
# - HKR also claim to have checked robustness
#   to using 6th-year instead of 1st-year
#   as the base salary
# - HKR fit separate quadratic curves in 
#   experience for each experience class 
#   (almost surely leading to hard discontinuities
#    in the E[exit | tenure] curve) -- explore
#   this and explore fixing it.
reg_l = 
  lapply(split(teachers, f = teachers$exp_split, sorted = TRUE),
         function(DT) 
           DT[ , lm(leave_next ~
                      schedule_lbase_ba_salary*gender + 
                      pct_prof_d + pct_frl_d + 
                      ethnicity_main*pct_black_d + 
                      ethnicity_main*pct_hisp_d + factor(year) + 
                      urbanicity_d + total_exp_floor + 
                      I(total_exp_floor^2) + n_students_d + class_size_d)])

#note: using unclustered SEs for these tests
tvals = sapply(reg_l, function(x) summary(x)$coefficients[ , 'Pr(>|t|)'])
pct_prof_signif = tvals['pct_prof_d', ]
pct_prof_signif_msg = if (any(pct_prof_signif < .01) || 
                          sum(pct_prof_signif < .05) > 1L)
  'MAJOR DATA CHANGE FLAG' else ''
salary_signif = tvals[grep('salary', rownames(tvals)), ]
salary_signif_msg = if (sum(salary_signif[ , 1:2] < .05) < 3L ||
                        sum(salary_signif[ , 4:5] < .05) > 1L)
  'MAJOR DATA CHANGE FLAG' else ''

coefn = setNames(nm = names(coef(reg_l[[1L]])))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_d', 'pct_frl_d', 'pct_black_d', 'pct_hisp_d',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_d')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
SEs = lapply(reg_l, vcovHC, 'HC1')
se_vcov = function(x) sqrt(diag(x))
pvals = lapply(seq_along(reg_l), function(ii)
  coeftest(reg_l[[ii]], SEs[[ii]])[ , 'Pr(>|t|)']) 

tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts, by Experience (linear',
                  'probability models; Huber-White standard ',
                  'errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), override.pvalues = pvals,
  reorder.coef = c(1, 6, 2:5, 7:10), override.se = lapply(SEs, se_vcov),
  include.rsquared = FALSE, include.adjrs = FALSE, 
  include.rmse = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])

idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)

#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

Having identified some key patterns in moments of the data, we now move on to try and separate the confounding effects of each of these and other factors in affecting teacher turnover with the aim of identifying more fundamentally the association between salient district and school characteristics on teacher turnover. Table \ref{tbl:reg_lpm} provides the main coefficients of interest from a simple linear probability regression model predicting leaving a district (i.e., either switching districts or exiting teaching); this corresponds to HKR Table 7. 

By contrast to the strength implied in earlier results`r pct_prof_signif_msg`, the importance of student achievement has dwindled in the regression specification, and only comes out as independently significant for probationary teachers. The same goes for base salary differentials`r salary_signif_msg` -- in contrast to HKR, the evidence we find in favor of an independent influence of salary on turnover rates is sparse and concentrated among young teachers[^class_size]. This does not appear to be due to imprecision -- the magnitude of HKR's standard errors follows closely those found for the Wisconsin data, despite our smaller sample sizes.

[^class_size]: HKR also mention results not printed in their paper suggesting a paucity of evidence suggesting class size is an important factor in teacher turnover decisions; we give tepid support to this statement, as class size does indeed appear to be related to turnover, but somewhat weakly and only for younger teachers.

HKR also found little independent evidence in favor of student economic status factoring in to teachers' mobility decisions, but we find fairly consistent support for the importance of subsidized lunch eligibility prevalence. As mentioned above, it is possible that the crude nature of the proficiency measure is only weakly identified, and that some of the unaccounted for part of student performance is being captured in other coefficients, especially subsidized lunch eligibility and student race. Even more compelling would be to associate student performance (and other school/district-level characteristics) more finely with the set of students actually faced by a given teacher.

The results in HKR about the differential effects of student body makeup are largely similar to those we find in Wisconsin. White and nonwhite teachers have opposite and significant correlations between the quantity of minority students in their origin district and their likelihood of leaving it. These differential results tend to modulate towards zero with experience, regardless of teacher or student race category, and suggest a degree of assortative matching on ethnicity among districts in Wisconsin (though the patterns for whites differ sharply from those of nonwhites, the patterns for black and Hispanic teachers are hard to distinguish).

```{r table_8_reg_lpm_fe, results = 'asis', cache = TRUE}
#** TO DO **
# - Do total future discounted pay totals lead to different
#   results?
reg_l = 
  lapply(split(teachers, f = teachers$exp_split, sorted = TRUE),
         function(DT) DT[ , lm(leave_next ~
                                 schedule_lbase_ba_salary*gender + 
                                 pct_prof_d + pct_frl_d + 
                                 ethnicity_main*pct_black_d + 
                                 ethnicity_main*pct_hisp_d + factor(year) + 
                                 factor(district) + total_exp_floor + 
                                 I(total_exp_floor^2) +
                                 n_students_d + class_size_d)])

#some districts are dropped by lm
#  (insufficient variation given low frequency of moves & other covariates)
coefn = setNames(nm = Reduce(union, lapply(reg_l, function(x) names(coef(x)))))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
              'pct_prof_d', 'pct_frl_d', 'pct_black_d', 'pct_hisp_d',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_d')), names(coefn))
coefn[idx] = 
  c('First year base salary (log)', 'First year base salary (log) * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
SEs = lapply(reg_l, vcovHC, 'HC1')
pvals = lapply(seq_along(reg_l), function(ii)
  coeftest(reg_l[[ii]], SEs[[ii]])[ , 'Pr(>|t|)']) 
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm_fe', 
  caption = paste('Estimated Effects of Starting Teacher Salary and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts with District Fixed',
                  'Effects, by Experience (linear probability models;',
                  'Huber-White standard errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), override.pvalues = pvals,
  reorder.coef = c(1, 6, 2:5, 7:10), override.se = lapply(SEs, se_vcov),
  include.rsquared = FALSE, include.adjrs = FALSE, 
  include.rmse = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])
idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

To account in a rudimentary way for district-specific hiring policies, HKR move on to their Table 8 which repeats Table 7 (our Table \ref{tbl:reg_lpm}) with district fixed effects. HKR note that the patterns in responsiveness to wages are the same, though attenuated; that coefficients involving student ethnicity are qualitatively unaffected; and that schools with high achievement continue to exhibit lower propensities for turnover. Our results, presented in Table \ref{tbl:reg_lpm_fe}, are similar in that they closely resemble the results without fixed effects, but with noted attenuation and weaker precision.

The most notable difference relative to Table \ref{tbl:reg_lpm} is the general weakening of results regarding the importance of student characteristics for white teachers. While partially attributable to a decline in precision, this adjustment suggests much of the discovered correlation between student characteristics and exit probability for white teachers can be chalked up to district-to-district heterogeneity in preferences or hiring policies.

### Local Wage Ratio

```{r table_8_relative, results = 'asis', cache = TRUE}
reg_l = 
  lapply(split(teachers, f = teachers$exp_split, sorted = TRUE),
         function(DT) DT[ , lm(leave_next ~
                                 relative_wage*gender + 
                                 pct_prof_d + pct_frl_d + 
                                 ethnicity_main*pct_black_d + 
                                 ethnicity_main*pct_hisp_d + factor(year) + 
                                 factor(district) + total_exp_floor + 
                                 I(total_exp_floor^2) +
                                 n_students_d + class_size_d)])

#some districts are dropped by lm
#  (insufficient variation given low frequency of moves & other covariates)
coefn = setNames(nm = Reduce(union, lapply(reg_l, function(x) names(coef(x)))))
coefn[seq_len(length(coefn))] = 'x'
idx = match(c('relative_wage', 'relative_wage:genderF',
              'pct_prof_d', 'pct_frl_d', 'pct_black_d', 'pct_hisp_d',
              paste0('ethnicity_main', 
                     c('Black', 'Black', 'Hispanic', 'Hispanic'), ':pct_',
                     c('black', 'hisp', 'black', 'hisp'), '_d')), names(coefn))
coefn[idx] = 
  c('Local Relative Wage', 'Local Relative Wage * female',
    'Percent proficient', 'Percent eligible for subsidized lunch',
    'Percent Black', 'Percent Hispanic', 'Black * percent Black',
    'Black * percent Hispanic', 'Hispanic * percent Black',
    'Hispanic * percent Hispanic')
reg_l = lapply(reg_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})
SEs = lapply(reg_l, vcovHC, 'HC1')
pvals = lapply(seq_along(reg_l), function(ii)
  coeftest(reg_l[[ii]], SEs[[ii]])[ , 'Pr(>|t|)']) 
tbl = capture.output(texreg(
  reg_l, omit.coef = '^x', label = 'tbl:reg_lpm_fe_rel', 
  caption = paste('Estimated Effects of Relative Local Wage and Student',
                  'Demographic Characteristics on the Probability that',
                  'Teachers Leave School Districts with District Fixed,',
                  'by Experience (linear probability models; Huber-White',
                  'standard errors in parentheses)'),
  groups = list('Campus average student characteristics' = 3:6,
                'Interactions' = 7:10), override.pvalues = pvals,
  reorder.coef = c(1, 6, 2:5, 7:10), override.se = lapply(SEs, se_vcov),
  include.rsquared = FALSE, include.adjrs = FALSE, 
  include.rmse = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-6}',
        tbl[idx:length(tbl)])
idx = grep('^Num.*obs', tbl)
#print-formatting 1k+ numbers
tbl[idx] = gsub('(\\d{1,3})(?=\\d{3}+(?!\\d))', '\\1,', tbl[idx], perl = TRUE)
tbl[idx] = gsub('Num. obs.   ', 'Observations', tbl[idx], fixed = TRUE)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

Perhaps a better measure of the influence of a teacher's wage on their propensity to move is their potential gains from changing to nearby districts. Table \ref{tbl:reg_lpm_fe_rel} presents results of a specification paralleling that in Table \ref{tbl:reg_lpm_fe}, save for the replacement of the initial Bachelor's salary as a predictor with a measure of a teacher's local relative wage. Specifically, the local relative wage is defined as the ratio of a teacher's next scheduled wage to the wage ceiling at districts within 50 miles of their current district (excluding their own) The wage ceiling is calculated as the maximum wage at the teacher's subsequent level of experience and certification in such districts. If this measure exceeds one, a teacher is getting paid more for their current qualifications than is possible locally; otherwise, they stand to gain in pay from switching to at least one school locally. This relative local wage measure is an even poorer predictor of teacher churn than are local wage levels. Table \ref{tbl:reg_lpm_fe_rel} bolsters evidence that student characteristics are more important than wage differentials for teachers considering changing districts[^rel_population].

[^rel_population]: Some of the other coefficients in Table \ref{tbl:reg_lpm_fe_rel} have changed somewhat substantially relative to those found in Table \ref{tbl:reg_lpm_fe}. This is largely attributable to a different subpopulation of teachers included in the results, as evidenced by the change in sample size between the two tables. This reflects differential missingness of the wage measures. The wage coefficients are qualitatively robust to selecting a fixed population to estimate the models for the two tables.

```{r table_9, results = 'asis', cache = TRUE}
##** TO DO**
# - Estimate marginal effects for men/women
#   of a 10% salary increase (also with
#   confidence intervals?) & compare to HKR
# - Why did changing definition of move_district_next
#   change the #s for nonwhites so we can't fit anymore?
teachersML = 
  melt(teachers[total_exp_floor <= 30], id.vars =
         c('teacher_id', 'year', 'schedule_lbase_ba_salary', 
           'gender', 'pct_prof_d', 'pct_frl_d', 'urbanicity_d',
           'nonwhite', 'pct_nonwhite_d',
           'total_exp_floor', 'n_students_d', 'class_size_d','exp_split'), 
       measure.vars = c('stay_next', 'move_district_next', 'quit_next'),
       variable.name = 'alternative', value.name = 'chosen')
setorder(teachersML, teacher_id, year, alternative)
teachersML[ , exp_split := droplevels(exp_split)]

teachersML[ , ID := .GRP, by = .(teacher_id, year)]

mnl_l = 
  lapply(split(teachersML, f = teachersML$exp_split, sorted = TRUE), function(DT) {
    setattr(DT, 'class', c('mlogit.data', class(DT)))
    setattr(DT, 'index', with(DT, data.table(alt = alternative, chid = ID)))
    mlogit(chosen ~ 0 | 
             schedule_lbase_ba_salary*gender + pct_prof_d + pct_frl_d + 
             nonwhite*pct_nonwhite_d +  factor(year) + 
             urbanicity_d + total_exp_floor + I(total_exp_floor^2) + 
             n_students_d + class_size_d, data = DT)
  })

coefn = setNames(nm = names(coef(mnl_l[[1L]])))
coefn[seq_len(length(coefn))] = 'x'
idx = match(
  paste0(rep(c('move_district_next:', 'quit_next:'), each = 6L),
         rep(c('schedule_lbase_ba_salary', 'schedule_lbase_ba_salary:genderF',
               'pct_prof_d', 'pct_frl_d', 'pct_nonwhite_d',
               'nonwhiteTRUE:pct_nonwhite_d'), 2L)), 
  names(coefn)
)
coefn[idx] = 
  rep(c('First year base salary (log)', 
        'First year base salary (log) * female', 'Percent proficient', 
        'Percent eligible for subsidized lunch', 'Percent Nonwhite',
        'Nonwhite * percent Nonwhite'), 2L)
mnl_l = lapply(mnl_l, function(x) {
  names(x$coefficients) = coefn[names(coef(x))]; x})

tbl = capture.output(texreg(
  mnl_l, label = 'tbl:reg_mlogit', omit.coef = '^x',
  caption = paste('Multinomial Logit Estimated Effects of Teacher',
                  'Salary and Student Demographic Characteristics',
                  'on the Probabilities That Teachers Switch',
                  'School Districts or Exit Teaching Relative to',
                  'Remaining in Same District'),
  reorder.coef = c(1, 9, 3, 5, 7, 11, 2, 10, 4, 6, 8, 12),
  groups = list('I. Switch Districts' = 1:6, 'II. Exit Teaching' = 7:12),
  include.aic = FALSE, include.loglik = FALSE,
  include.nobs = FALSE, sideways = TRUE, use.packages = FALSE))

idx = grep('years', tbl)
tbl = c(tbl[1L:(idx - 1L)],
        ' & \\multicolumn{4}{c}{Teacher Experience} \\\\ \\cline{2-5}',
        tbl[idx:length(tbl)])
tbl = gsub('\\([12]\\)', '', tbl)
#exclude the extra blank rows introduced by texreg's group option
cat(tbl[grep('[^ &\\]', tbl)], sep = '\n')
```

Finally, the conflation of switching districts and exiting teaching may mask important heterogeneity between these two choices. To separate these competing exit risks, HKR construct Table 9, which gives coefficients from a multinomial logit model with three choices -- remain in district, switch districts, and exit teaching. We repeat that analysis here in Table \ref{tbl:reg_mlogit}, with the caveat that, given the sparsity in racial variation present among Wisconsin teachers, we are unable to identify the full model specified by HKR and mirrored above in Tables \ref{tbl:reg_lpm} and \ref{tbl:reg_lpm_fe}. In light of this, and in light of the apparent similarity in Wisconsin in the behavior of black and Hispanic teachers described above, we specify the multinomial logit model in terms of a more parsimonious coefficient set. Namely, we distinguish between white and nonwhite teachers and white and nonwhite students (instead of among white, black, and Hispanic students and teachers).

We continue to see little evidence favoring the salience of wage considerations for Wisconsin teachers; the strongest suggestions found here point to the importance of wages for older male teachers in exiting teaching, a result which is generally opposed to that found by HKR in Texas, where salaries were generally important, but only for the propensity to change districts. Also as in the regression specifications, the prominence of student proficiency found by HKR fails to make a notable appearance in Wisconsin.

With respect to the importance of student demographics, our results again point to the same effects found in Texas. White teachers seem to be spurred to change districts or exit teaching by highly black student populations; the reverse is true of nonwhite teachers, who can be drawn to remain in high-minority districts. Subsidized lunch eligibility's strong effect observed in the combined specification is found here to be concentrated more among those leaving teaching than those changing districts.

\TAG{END_BODY}

# Conclusion

That salary incentives appear to play such a limited role in driving teacher churn is bound at first glance to be a disappointment for policymakers. The most powerful predictors of turnover in educators in Wisconsin are all basically beyond the control of administrators, who have no readily-manipulated direct lever for assigning students to schools[^gerrymandering]. HKR found school quality (as measured by average standardized test performance) to be of key importance for attracting/retaining teachers, but we found no evidence that student proficiency (as measured by attainment levels on standardized tests) is a factor in the turnover decision for Wisconsin teachers. Regardless, manipulating school performance is famously difficult[^cheating], and is in fact the original goal administrators often have in mind when they turn to labor market policies in the first place, so that telling administrators they can improve teacher retention by improving student performance amounts essentially to circular reasoning.

[^cheating]: See, for example, the widespread cheating scandals on standardized tests by teachers in Chicago [@jacob], Atlanta, and Philadelphia as an example of the lengths professionals feel they need to go to effect change in testing outcomes.

[^gerrymandering]: There is evidence [e.g., @richards] that catchment area manipulation (educational gerrymandering) is being used by some schools to select their student populations, but the equilibrium outcome of the strategic interactions of districts competing for the most "desirable" students is far from clear.

The upside is that this paper is far from settling the debate about welfare-maximizing teacher turnover policies. Limitations in our data prevent us from associating to teachers anything but crude measures of their productivity; measures such as experience, certification, and race are famously poor predictors of teacher quality measures such as value-added. We are thus unable to provide any input to the question of whether _high-quality_ teachers have patterns of mobility which resemble that of the teaching population as a whole, or whether heterogeneity in their preferences can be used to devise appropriate policies.

# Appendix: Longitudinal Teacher Panel from Unlinked Cross-Sectional Cuts

\TAG{BEGIN_APPENDIX}

DPI WISEstaff data does not include a longitudinal identifier for teachers, so we resorted to an alternative approach to matching teachers from year to year. The essence of this algorithm relies on the inclusion of four fields in the DPI data -- `first_name`, `last_name`, `nee` (former last name) and `birth_year`. By matching teacher using these identifiers, it is possible to construct with high accuracy a panel of teachers from simple teacher cross-sections[^find_code].

[^find_code]: The code for this process was done using R and especially helped by the `data.table` package [@dowle]. The code to reproduce this entire project can be found at https://github.com/MichaelChirico/wisconsin_teachers. The script for the algorithm is `teacher_match_and_clean.R`. The `README` file gives steps for full reproduction, including retrieving the raw data.

## Step 0: Pre-Processing

Prior to beginning the matching process, a number of steps are taken to improve the quality of the raw data. The first is to incorporate as many of the errata mentioned in @dpi_errata as possible. All name variables are then converted to lower case, after which we extract maiden names (identified for those missing a DPI-supplied entry in `nee` as the part of the `last_name` field that appears in between parentheses or surrounding a hyphen or forward slash). Generally, it appears the maiden name comes in the data _before_ the hyphen, but we create the `nee2` field to identify potential matches to the post-hyphen name as well. A search was done of the data for irregular characters (punctuation or numbers) which allowed several obvious typos to be resolved (e.g., `l0is a dewey` was easy to resolve as being `lois a dewey`), and this is implemented next.

We then create a "clean" version of the name fields which strips away all whitespace, initials (lone letters), and punctuation. At this stage, all observations which identically match another in the same year from the viewpoint of the algorithm -- namely, those that match exactly another observation on the cleaned first and last names and year of birth -- are removed from the data since it would be impossible to tell such teachers apart. A more ambitious treatment would attempt to use other cues found in the duplicated records (ethnicity, subject/position cues, etc.) to separate such teachers, but the marginal cost of doing so was found to exceed the potential benefit considerably for the exercise at hand (recall that only `r to.pct(1 - total_matchable/total_observations, 1L)`% of total observations are lost in this fashion). Finally, teachers in the first year of data (1994-95) are assigned an ID starting from 1 using the within-year identifier provided by DPI. 

## Steps 1-21: Matching

The algorithm proceeds by iterating over years of the data. In each year $Y$, matches are found serially by progressively adjusting the criteria for considering two observations to be from the same teacher as follows:

 1. Match anyone who stayed in the same school -- i.e., match any teacher found in a year $Y'<Y$ with the same `first_name`, `last_name`, and `birth_year` at the same  `district` and `school`.
 2. Find within-district switchers -- those who match on all but the `school` field from Step 1.
 3. Find out-of-district switchers -- those who match on all but the `district` field from Step 2.
 4. Find teachers that appear to have been married, but have not moved -- their `nee` field in $Y$ is matched to the `last_name` fields in $Y'<Y$, but otherwise the fields from Step 1 are all matched. We create a flag for teachers matched in this fashion called `married`.
 5. Repeat Step 2 for those who appear to have married.
 6. Repeat Step 3 for those who appear to have married.
 7-9. Repeat Steps 4-6 using the `nee2` field instead of `nee`.
 10-18. Repeat Steps 1-9 using the "cleaned" version of the first name field that had non-alphabetic characters removed, `first_name_clean`. We create a flag for teachers matched in this fashion called `mismatch_inits`.
 19. Match individuals in the same school assigned to the same position (identified in `position_code`) but with different years of birth to overcome potential noise in year of birth (most commonly, the year of birth is missing in some years). We create a flag for teachers matched in this fashion called `mismatch_yob`.
 20. Match individuals in the same _district_ assigned to the same position but with different years of birth. We do not extend this logic to find district switchers since the potential for erroneous match assignment in such a case is too great, and we neglect to extend the algorithm to use other cues from the data to facilitate matching in such cases.
 21. Assign new IDs to all teachers in $Y$ not matched in the first 20 steps, incrementing from the highest ID recorded thus far.
 
 To help ensure we are matching to the most important observation of each teacher, matching is always done to a teacher's highest-FTE observation within a year (particularly important for Steps 19-20). Further, it is sometimes the case that a given tuple of search keys matches more than one teacher in the prior data; if so, these rows are simply ignored for that step and such a teacher will go unmatched unless they are uniquely pinned down in a subsequent step.

```{r match_step, fig.cap = '\\label{fig:step}Frequency of Matching by Step'}
par(mar = c(5.1, 5.6, 4.1, 2.1))
plot(NULL, main = '# Teachers Matched by Step',
     xaxt = 'n', xlab = 'Step', yaxt = 'n', ylab = '', 
     xlim = range(as.integer(names(step_table))), ylim = c(0, 7))
rect(18.5, par('usr')[3L], par('usr')[2L], 
     par('usr')[4L], col = 'cadetblue1')
lines(log10(step_table), 
      col = ifelse(names(step_table) %in% c(4:9, 13:18), 'red', 'black'))
inits_tbl = step_table[names(step_table) %in% 10:18]
lines(log10(inits_tbl), lwd = 5L,
      col = ifelse(names(inits_tbl) %in% 13:18, 'red', 'black'))
axis(side = 1L, at = as.integer(names(step_table)), cex.axis = .7)
axis(side = 2L, at = 0:7, las = 1L,
     labels = prettyNum(10^(0:7), big.mark = ',', scientific = FALSE))
mtext(side = 2L, '# Matched', line = 4)
legend('topright', c('Married', 'Mismatched Initials',
                     'Mismatched Year of Birth'),
       col = c('red', 'black', 'cadetblue1'), lwd = c(2L, 5L, NA),
       pch = c(NA, NA, 15L), bty = 'n')
```

Figure \ref{fig:step} Shows that teachers are most commonly matched in the first three steps, meaning data fidelity issues are not _per se_ devastating. The real benefits of the algorithm are in the subsequent steps, as a result of which an additional `r pn(sum(step_table[!names(step_table) %in% 0:3]))` teachers are matched than would have been if only the original first and last name fields as found in the raw data were used. 

## Step 22: Post-Processing

The panels implied by the matched IDs created by the algorithm still have a substantial amount of data quality issues which we can only address once teachers' multiple observations are associated, mainly having to do with instability in certain observable characteristics which should be constant over time. First, we cascade forward maiden names (if a teacher has non-missing `nee` in a period $Y$ and it becomes missing in $Y'>Y$, we replace it in $Y'$ with its value in $Y$); the same is done for the certification field, `highest_degree` (just as a teacher cannot erase marriage from their past, so can they not make a degree disappear).

Next, we correct instability in the `ethnicity` (and `gender`) fields when possible according to three steps: 1) it is sometimes missing, in which case we simply overwrite it with the other values found for that teacher; 2) at least 70% of a teacher's observations use the same ethnicity (or gender); or 3) there are at least five people that share a last name with an ethnicity-ambiguous teacher, at least 70% of whom have one ethnicity (or gender), the idea being that names like Xu or Gutierrez are strongly associated with a particular ethnicity. This type of correction is uncommon enough not to warrant an appeal to a more sophisticated approach commonly found in natural language processing applications, e.g. training a classifier such as a random forest [@breiman] to predict ethnicity as accurately as possible.

Lastly, we synergize the year of birth field for those matched in Steps 19 or 20 by assigning the one that appears most frequently for each teacher; in the case of ties, we use a regression-to-the-mean-type logic and assign the year which brings the teacher closer to the median age observed in the data. More data-driven approaches (conditioning the target median on the teacher's employer, position, year in the data, or using social security data to determine the maximum-likelihood year of birth for a given first name, etc.) were again eschewed for expediency.

## Validity Check: `file_number`

Starting in the 2011-12 release, the DPI data begins to consistently record a field called `file_number` for teachers which generally acts as a time-consistent ID [from verbiage gleaned from @dpi_errata, it appears this corresponds to a teaching license number]. We looked for instances of multiple file numbers and are content that the algorithm is performing well -- only 78 teacher IDs were found to be associated with more than one `file_number`, with almost all of them having been matched on Steps 1 - 3 (what should be the highest-accuracy steps). Given a number of apparent transcription mistakes (i.e., `file_number` differing by one digit in some years) and that the `file_number` does appear to change on occasion, even these 78 could be an overstatement of the number of incorrectly matched individuals. 

\TAG{END_APPENDIX}

# References
